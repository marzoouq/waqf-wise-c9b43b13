name: ðŸ”Œ Edge Functions Integration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/functions/**'
      - 'src/__tests__/integration/**'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'supabase/functions/**'
      - 'src/__tests__/integration/**'
  schedule:
    # Run daily at 4 AM UTC
    - cron: '0 4 * * *'
  workflow_dispatch:
    inputs:
      run_authenticated:
        description: 'Run authenticated tests'
        type: boolean
        default: true
      run_performance:
        description: 'Run performance tests'
        type: boolean
        default: true

concurrency:
  group: integration-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
  VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Setup Job - Check if tests should run
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  setup:
    name: ðŸ”§ Setup
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if tests should run
        id: check
        run: |
          if [[ -z "${{ secrets.VITE_SUPABASE_URL }}" ]]; then
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ VITE_SUPABASE_URL not configured - skipping integration tests"
          else
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… Supabase configuration found"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Public Functions Tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  public-functions:
    name: ðŸŒ Public Edge Functions
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_run == 'true'
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: Run Public Functions Tests
        run: |
          npx vitest run src/__tests__/integration/edge-functions-public.integration.test.ts \
            --reporter=verbose \
            --reporter=json \
            --outputFile=test-results/public-functions.json
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: public-functions-results
          path: test-results/
          retention-days: 7

      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸŒ Public Functions Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results/public-functions.json ]; then
            echo "Results saved to artifacts" >> $GITHUB_STEP_SUMMARY
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Authenticated Functions Tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  authenticated-functions:
    name: ðŸ” Authenticated Edge Functions
    runs-on: ubuntu-latest
    needs: setup
    if: |
      needs.setup.outputs.should_run == 'true' && 
      (github.event.inputs.run_authenticated != 'false' || github.event_name != 'workflow_dispatch')
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: Run Authenticated Functions Tests
        run: |
          npx vitest run src/__tests__/integration/edge-functions-authenticated.integration.test.ts \
            --reporter=verbose \
            --reporter=json \
            --outputFile=test-results/authenticated-functions.json
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          VITE_TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: authenticated-functions-results
          path: test-results/
          retention-days: 7

      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸ” Authenticated Functions Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test user: ${{ secrets.TEST_USER_EMAIL != '' && 'âœ… Configured' || 'âš ï¸ Not configured' }}" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Performance Tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [setup, public-functions]
    if: |
      needs.setup.outputs.should_run == 'true' && 
      (github.event.inputs.run_performance != 'false' || github.event_name != 'workflow_dispatch')
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install --legacy-peer-deps
        
      - name: Run Performance Tests
        run: |
          npx vitest run src/__tests__/integration/edge-functions-performance.integration.test.ts \
            --reporter=verbose \
            --reporter=json \
            --outputFile=test-results/performance.json
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          
      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: test-results/
          retention-days: 7

      - name: Generate Performance Summary
        if: always()
        run: |
          echo "## âš¡ Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Threshold |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cold Start | < 15s |" >> $GITHUB_STEP_SUMMARY
          echo "| Average Response | < 5s |" >> $GITHUB_STEP_SUMMARY
          echo "| Concurrent (5) | 80% success |" >> $GITHUB_STEP_SUMMARY
          echo "| Concurrent (10) | 70% success |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Summary Report
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ðŸ“Š Integration Summary
    runs-on: ubuntu-latest
    needs: [public-functions, authenticated-functions, performance-tests]
    if: always() && needs.setup.outputs.should_run == 'true'
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results
          
      - name: Generate Summary Report
        run: |
          echo "# ðŸ”Œ Edge Functions Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** ${{ github.run_number }} | **Branch:** ${{ github.ref_name }} | **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Public Functions | ${{ needs.public-functions.result == 'success' && 'âœ… Passed' || needs.public-functions.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Authenticated Functions | ${{ needs.authenticated-functions.result == 'success' && 'âœ… Passed' || needs.authenticated-functions.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Performance Tests | ${{ needs.performance-tests.result == 'success' && 'âœ… Passed' || needs.performance-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "${{ needs.public-functions.result }}" == "failure" ]] || \
             [[ "${{ needs.authenticated-functions.result }}" == "failure" ]]; then
            echo "## âŒ Some Critical Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please review the test logs and fix the failing tests." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… All Critical Tests Passed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for failures
        if: needs.public-functions.result == 'failure' || needs.authenticated-functions.result == 'failure'
        run: exit 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Skip notification (when secrets not configured)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  skip-notification:
    name: â­ï¸ Tests Skipped
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_run == 'false'
    
    steps:
      - name: Notify skipped
        run: |
          echo "## âš ï¸ Integration Tests Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Supabase configuration not found. To enable integration tests:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Add \`VITE_SUPABASE_URL\` secret to your repository" >> $GITHUB_STEP_SUMMARY
          echo "2. Add \`VITE_SUPABASE_ANON_KEY\` secret to your repository" >> $GITHUB_STEP_SUMMARY
          echo "3. (Optional) Add \`TEST_USER_EMAIL\` and \`TEST_USER_PASSWORD\` for authenticated tests" >> $GITHUB_STEP_SUMMARY
