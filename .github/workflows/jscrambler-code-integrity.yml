# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# This is a basic workflow to help you get started with Using Jscrambler Code Integrity Action.
# It automates the protection of your JavaScript Applications, so you can run it whenever a new version of your application is built.
# A Jscrambler account is required to use this Workflow.
#
# More info can be found here : https://docs.jscrambler.com/latest/code-integrity/documentation/github-ci-integration

name: Jscrambler Code Integrity

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install dependencies
        run: npm ci
      
      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      # NOTE: Before enabling this step, ensure the following are configured:
      # 1. Add jscrambler.json configuration file to the repository (download from your Jscrambler account)
      # 2. Configure these repository secrets:
      #    - JSCRAMBLER_APPLICATION_ID (created within your Jscrambler account)
      #    - JSCRAMBLER_SECRET_KEY (found in your Jscrambler account)
      #    - JSCRAMBLER_ACCESS_KEY (found in your Jscrambler account)
      
      - name: Jscrambler Code Integrity
        # Automatically enabled when jscrambler.json is present in the repository
        if: hashFiles('jscrambler.json') != ''
        id: jscrambler
        # Complete list of inputs: https://github.com/marketplace/actions/jscrambler#inputs
        uses: jscrambler/code-integrity-actions/protect@v1
        with:
          application-id: ${{ secrets.JSCRAMBLER_APPLICATION_ID }}
          secret-key: ${{ secrets.JSCRAMBLER_SECRET_KEY }}
          access-key: ${{ secrets.JSCRAMBLER_ACCESS_KEY }}
          jscrambler-config-path: jscrambler.json
          files-src: |
            dist/**/*
          files-dest: dist-protected  # Output to separate directory to avoid overwriting original dist
