# ๐ ุญููู ุงููุณุชููุฏูู ูู ุงูุฏุฑุฌุฉ ุงูุฃููู

<div align="center">

![Version](https://img.shields.io/badge/ุชุงุฑูุฎ_ุงูุชุญุฏูุซ-2025--11--22-blue.svg)
![Status](https://img.shields.io/badge/ุงูุญุงูุฉ-ูุญูู_ููุดุท-green.svg)
![Protection Level](https://img.shields.io/badge/ูุณุชูู_ุงูุญูุงูุฉ-ุญุฑุฌ-red.svg)

**๐ก๏ธ ุญููู ูููููุฉ ููุญููุฉ ุจุขููุฉ Event Trigger**

</div>

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงููุณุชูุฏ ููุซู **ุญููู ุงููุณุชููุฏูู ูู ุงูุฏุฑุฌุฉ ุงูุฃููู** ูู ููุตุฉ ุฅุฏุงุฑุฉ ุงูููู ุงูุฅููุชุฑูููุฉ. ูุฐู ุงูุญููู **ูุญููุฉ ุจุดูู ุชููุงุฆู** ููุง ูููู ุชุนุฏูููุง ุฃู ุญุฐููุง ุฅูุง ุจุฅุฐู ุตุฑูุญ ูู ุงููุงุธุฑ.

---

## ๐ฅ ุงููุณุชููุฏูู ูู ุงูุฏุฑุฌุฉ ุงูุฃููู (14 ูุณุชููุฏ)

### ุงูุชูุฒูุน ุญุณุจ ุงูููุน
```
๐ ุฅุฌูุงูู: 14 ูุณุชููุฏ ูุดุท
โโโ ๐จ ุฃููุงุฏ: 5
โโโ ๐ง ุจูุงุช: 7
โโโ ๐ฐ ุฒูุฌุงุช: 2
```

### ูุงุฆูุฉ ุงููุณุชููุฏูู

| # | ุงูุงุณู ุงููุงูู | ุงูููุน | ุงูุญุงูุฉ |
|---|-------------|-------|--------|
| 1 | ุฃูู ุงูุณูุฏ ุงุจุฑุงููู ุงุจูุงูุฑูุด | ุฒูุฌุฉ | ูุดุท |
| 2 | ุฃูู ูุฑุฒูู ุนูู ุงูุซุจูุชู | ุจูุช | ูุดุท |
| 3 | ุญูุงู ูุฑุฒูู ุนูู ุงูุซุจูุชู | ุจูุช | ูุดุท |
| 4 | ุณููู ูุฑุฒูู ุนูู ุงูุซุจูุชู | ุจูุช | ูุดุท |
| 5 | ุนุจุฏุงูุฑุญูู ูุฑุฒูู ุนูู ุงูุซุจูุชู | ููุฏ | ูุดุท |
| 6 | ุนุจุฏุงูุนุฒูุฒ ูุฑุฒูู ุนูู ุงูุซุจูุชู | ููุฏ | ูุดุท |
| 7 | ุนุจุฏุงููู ูุฑุฒูู ุนูู ุงูุซุจูุชู | ููุฏ | ูุดุท |
| 8 | ุนูุงู ูุฑุฒูู ุนูู ุงูุซุจูุชู | ุจูุช | ูุดุท |
| 9 | ูุงุทูู ูุญูุฏ ุณุนุฏ ุงูุดูุฑุงูู | ุฒูุฌุฉ | ูุดุท |
| 10 | ูุงุทูู ูุฑุฒูู ุนูู ุงูุซุจูุชู | ุจูุช | ูุดุท |
| 11 | ูุงุฌุฏ ูุฑุฒูู ุนูู ุงูุซุจูุชู | ููุฏ | ูุดุท |
| 12 | ูุญูุฏ ูุฑุฒูู ุนูู ุงูุซุจูุชู | ููุฏ | ูุดุท |
| 13 | ููู ูุฑุฒูู ุนูู ุงูุซุจูุชู | ุจูุช | ูุดุท |
| 14 | ูุฏู ูุฑุฒูู ุนูู ุงูุซุจูุชู | ุจูุช | ูุดุท |

---

## ๐ ุงูุญููู ุงููููููุฉ (ูุฑุงุกุฉ ููุท)

### 1๏ธโฃ ุงูุจูุงูุงุช ุงููุงููุฉ ูุงููุญุงุณุจูุฉ

#### ุฃ) ุงููุญุงุณุจุฉ ุงูุนุงูุฉ
- โ **ุงููููุฏ ุงูููููุฉ** (`journal_entries`)
  - ูุฑุงุกุฉ ุฌููุน ุงููููุฏ ุงููุญุงุณุจูุฉ ุงููุณุฌูุฉ
  - ุงูุงุทูุงุน ุนูู ุงูุชูุงุตูู ุงููุงููุฉ ููู ููุฏ
  
- โ **ุดุฌุฑุฉ ุงูุญุณุงุจุงุช** (`accounts`)
  - ุนุฑุถ ุฌููุน ุงูุญุณุงุจุงุช ุงููุญุงุณุจูุฉ
  - ุงูุงุทูุงุน ุนูู ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช
  
- โ **ุงูููุฒุงููุงุช** (`budgets`)
  - ูุฑุงุกุฉ ุงูููุฒุงููุงุช ุงููุนุชูุฏุฉ
  - ููุงุฑูุฉ ุงูููุฒุงููุงุช ุจุงููุนูู
  
- โ **ุงูุชุฏููุงุช ุงูููุฏูุฉ** (`cash_flows`)
  - ุนุฑุถ ุงูุชุฏููุงุช ุงูููุฏูุฉ ุงูุฏุงุฎูุฉ ูุงูุฎุงุฑุฌุฉ
  - ุชุญููู ุงูุณูููุฉ ุงููุงููุฉ

- โ **ุงูุณููุงุช ุงููุงููุฉ** (`fiscal_years`)
  - ุงูุงุทูุงุน ุนูู ุงูุณููุงุช ุงููุงููุฉ ูุชูุงุฑูุฎูุง
  - ูุฑุงุฌุนุฉ ุญุงูุงุช ุฅููุงู ุงูุณููุงุช

#### ุจ) ุงููุฏููุนุงุช ุงูุดุฎุตูุฉ
- โ **ุงููุฏููุนุงุช ุงูุดุฎุตูุฉ** (`payments`)
  - ุนุฑุถ ุฌููุน ุงููุฏููุนุงุช ุงูุฎุงุตุฉ ุจุงููุณุชููุฏ
  - ุชูุงุตูู ุงููุจุงูุบ ูุงูุชูุงุฑูุฎ

---

### 2๏ธโฃ ุงูุจูุงูุงุช ุงูุจูููุฉ

- โ **ุงูุญุณุงุจุงุช ุงูุจูููุฉ** (`bank_accounts`)
  - ูุฑุงุกุฉ ูุนูููุงุช ุฌููุน ุงูุญุณุงุจุงุช ุงูุจูููุฉ ููููู
  - ุงูุงุทูุงุน ุนูู ุฃุฑุตุฏุฉ ุงูุญุณุงุจุงุช
  
- โ **ูุดููุงุช ุงูุจูู** (`bank_statements`)
  - ุนุฑุถ ูุดููุงุช ุงูุญุณุงุจุงุช ุงูุจูููุฉ
  - ูุฑุงุฌุนุฉ ุงูุฃุฑุตุฏุฉ ุงูุงูุชุชุงุญูุฉ ูุงูุฎุชุงููุฉ
  
- โ **ุงููุนุงููุงุช ุงูุจูููุฉ** (`bank_transactions`)
  - ุชูุงุตูู ุฌููุน ุงููุนุงููุงุช ุงูุจูููุฉ
  - ุงููุฏุงุฆุน ูุงูุณุญูุจุงุช

---

### 3๏ธโฃ ุงูุนูุงุฑุงุช ูุงููุญุฏุงุช ุงูุนูุงุฑูุฉ

- โ **ุงูุนูุงุฑุงุช** (`properties`)
  - ูุฑุงุกุฉ ูุนูููุงุช ุฌููุน ุงูุนูุงุฑุงุช ุงูุชุงุจุนุฉ ููููู
  - ุชูุงุตูู ุงูุนูุงุฑุงุช (ุงููููุนุ ุงููุณุงุญุฉุ ุงููููุฉ)
  
- โ **ุงููุญุฏุงุช ุงูุนูุงุฑูุฉ** (`property_units`)
  - ุนุฑุถ ุงููุญุฏุงุช ุงููุคุฌุฑุฉ ูุงููุงุฑุบุฉ
  - ุญุงูุฉ ูู ูุญุฏุฉ ูููุนูุง
  
- โ **ุงูุนููุฏ** (`contracts`)
  - ูุฑุงุกุฉ ุฌููุน ุนููุฏ ุงูุฅูุฌุงุฑ
  - ุชูุงุตูู ุงููุณุชุฃุฌุฑูู ููุจุงูุบ ุงูุฅูุฌุงุฑ
  
- โ **ูุฏููุนุงุช ุงูุฅูุฌุงุฑ** (`rental_payments`)
  - ูุชุงุจุนุฉ ุฏูุนุงุช ุงูุฅูุฌุงุฑ
  - ุงููุฏููุนุงุช ุงููุชุฃุฎุฑุฉ ูุงููุณุชุญูุฉ
  
- โ **ุทูุจุงุช ุงูุตูุงูุฉ** (`maintenance_requests`)
  - ุงูุงุทูุงุน ุนูู ุทูุจุงุช ุงูุตูุงูุฉ
  - ุญุงูุฉ ูู ุทูุจ ูุชูุงูููู

---

### 4๏ธโฃ ุงูุชูุฒูุนุงุช ูุงูุตูุงุฏูู

- โ **ุงูุชูุฒูุนุงุช ุงููุนุชูุฏุฉ** (`distributions`)
  - ูุฑุงุกุฉ ุงูุชูุฒูุนุงุช ุงููุงููุฉ ุงููุนุชูุฏุฉ ููุท
  - ุชูุงุตูู ุชูุฒูุน ุงูุบูุฉ ุนูู ุงููุณุชููุฏูู
  - ุญุตุฉ ูู ูุณุชููุฏ ููุณุจุชู
  
- โ **ุงูุตูุงุฏูู ุงููุดุทุฉ** (`funds`)
  - ุนุฑุถ ุงูุตูุงุฏูู ุงููุงููุฉ ุงููุดุทุฉ
  - ุฃุฑุตุฏุฉ ุงูุตูุงุฏูู ููุตุงุฏุฑูุง
  
- โ **ุฅุนุฏุงุฏุงุช ุงูุชูุฒูุน** (`waqf_distribution_settings`)
  - ุงูุงุทูุงุน ุนูู ุฅุนุฏุงุฏุงุช ุชูุฒูุน ุงูุบูุฉ
  - ุงููุณุจ ุงููุฎุตุตุฉ ููู ูุฆุฉ
  
- โ **ุฃููุงู ุงูููู** (`waqf_units`)
  - ูุนูููุงุช ุฃููุงู ุงูููู ุงููุฎุชููุฉ
  - ุฅูุฑุงุฏุงุช ููุตุฑููุงุช ูู ููู

---

### 5๏ธโฃ ุงูุญูููุฉ ูุงูุดูุงููุฉ

- โ **ูุฑุงุฑุงุช ุงูุญูููุฉ** (`governance_decisions`)
  - ูุฑุงุกุฉ ุงููุฑุงุฑุงุช ุงููุนุชูุฏุฉ ูุงููููุฐุฉ
  - ุงููุฑุงุฑุงุช ุงูุฌุงุฑูุฉ ูุงูููุชููุฉ
  
- โ **ุงูุฅูุตุงุญุงุช ุงูุณูููุฉ** (`annual_disclosures`)
  - ุงูุงุทูุงุน ุนูู ุงูุฅูุตุงุญุงุช ุงููุงููุฉ ุงูุณูููุฉ ุงูููุดูุฑุฉ
  - ุชูุงุฑูุฑ ููุงูุฉ ุงูุณูุฉ ุงููุงููุฉ
  
- โ **ูุนูููุงุช ุงููุงุธุฑ** (`waqf_nazers`)
  - ูุฑุงุกุฉ ูุนูููุงุช ูุงุธุฑ ุงูููู
  - ุงูุจูุงูุงุช ุงูุนุงูุฉ ูุงูุงุชุตุงู

---

### 6๏ธโฃ ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ

- โ **ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ** (`beneficiaries`)
  - ูุฑุงุกุฉ ูุชุนุฏูู ุจูุงูุงุชู ุงูุดุฎุตูุฉ ููุท
  - ุชุญุฏูุซ ุจูุงูุงุช ุงูุงุชุตุงู ูุงูุจูู
  
- โ **ุงูุทูุจุงุช** (`beneficiary_requests`)
  - ุชูุฏูู ููุชุงุจุนุฉ ุทูุจุงุชู
  - ุฑุคูุฉ ุญุงูุฉ ูู ุทูุจ
  
- โ **ุงููุฑููุงุช** (`beneficiary_attachments`)
  - ุฑูุน ุงููุณุชูุฏุงุช ุงููุทููุจุฉ
  - ุงูุงุทูุงุน ุนูู ูุฑููุงุชู

---

## ๐ก๏ธ ุขููุฉ ุงูุญูุงูุฉ

### 1. ุฏุงูุฉ ุงูุชุญูู ุงููุญููุฉ

```sql
CREATE OR REPLACE FUNCTION public.is_first_degree_beneficiary(user_uuid UUID)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
STABLE
AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 
    FROM public.beneficiaries 
    WHERE user_id = user_uuid 
      AND category = 'ุงููุฆุฉ ุงูุฃููู'
      AND status = 'ูุดุท'
  );
END;
$$;
```

**โ๏ธ ุชุญุฐูุฑ:** ูุง ุชุนุฏู ูุฐู ุงูุฏุงูุฉ ุฃุจุฏุงู - ูุญููุฉ ุถูู ุงููุธุงู

---

### 2. ุฌุฏูู ุชูุซูู ุงูุณูุงุณุงุช

ุฌุฏูู `protected_policies_log` ูุญุชูู ุนูู:
- ุงุณู ุงูุฌุฏูู
- ุงุณู ุงูุณูุงุณุฉ
- ูุตู ุงูุณูุงุณุฉ
- ูุณุชูู ุงูุญูุงูุฉ (critical, high, medium)
- ุชุงุฑูุฎ ุงูุฅูุดุงุก ูุงูุชุญุฏูุซ
- ููุงุญุธุงุช ุงูุชุญูู

---

### 3. Event Trigger ููุญูุงูุฉ ูู ุงูุญุฐู

```sql
CREATE EVENT TRIGGER protect_first_degree_policies
  ON sql_drop
  EXECUTE FUNCTION public.prevent_protected_policy_deletion();
```

**ุขููุฉ ุงูุนูู:**
1. ุนูุฏ ูุญุงููุฉ ุญุฐู ุณูุงุณุฉ RLS
2. ูุชุญูู Event Trigger ูู ุงุณู ุงูุณูุงุณุฉ
3. ุฅุฐุง ุงุญุชูุช ุนูู `first_degree` ุฃู `ุงููุฆุฉ ุงูุฃููู`
4. ูุชู ุฑูุถ ุงูุนูููุฉ ูุฅุธูุงุฑ ุฑุณุงูุฉ ุฎุทุฃ

**ูุซุงู ุนูู ุฑุณุงูุฉ ุงูุฎุทุฃ:**
```
๐ ูุง ูููู ุญุฐู ุณูุงุณุฉ ูุญููุฉ ุชุฎุต ุงููุณุชููุฏูู ูู ุงูุฏุฑุฌุฉ ุงูุฃููู
HINT: ูุฐู ุงูุณูุงุณุฉ ูุญููุฉ ุจููุฌุจ ุญููู ุงููุณุชููุฏูู ุงูู14 ูู ุงูุฏุฑุฌุฉ ุงูุฃููู
```

---

## ๐ด ููููุนุงุช ุตุงุฑูุฉ

### โ ูุง ูุฌูุฒ ุฃุจุฏุงู:

1. **ุญุฐู ุฏุงูุฉ `is_first_degree_beneficiary()`**
   - ูุญููุฉ ุจู Event Trigger
   - ุฃุณุงุณูุฉ ูุชุญุฏูุฏ ุตูุงุญูุงุช ุงููุณุชููุฏูู

2. **ุชุนุฏูู ุฌุฏูู `protected_policies_log`**
   - ุณุฌู ุงูุชูุซูู ุงูุฑุณูู
   - ูุณุชุฎุฏู ูู ุงููุฑุงุฌุนุฉ ูุงูุชุฏููู

3. **ุญุฐู Event Trigger `protect_first_degree_policies`**
   - ุขููุฉ ุงูุญูุงูุฉ ุงูุฑุฆูุณูุฉ
   - ุจุฏูููุง ูููู ุญุฐู ุงูุณูุงุณุงุช ุงููุญููุฉ

4. **ุชุนุฏูู ุญูู `category` ูู ุฌุฏูู `beneficiaries`**
   - ุชุนุฏููู ูุคุซุฑ ุนูู ุตูุงุญูุงุช ุงูู14 ูุณุชููุฏ
   - ูุญูู ูู ุงูุชุนุฏูู ุฅูุง ุจููุงููุฉ ุงููุงุธุฑ

5. **ุญุฐู ุฃู ุณูุงุณุฉ RLS ุชุญุชูู ุนูู:**
   - `first_degree`
   - `ุงููุฆุฉ ุงูุฃููู`
   - ุฃุณูุงุก ุงูุณูุงุณุงุช ุงูููุซูุฉ ูู `protected_policies_log`

---

## โ ูุณููุญ (ุจุฅุฐู ุงููุงุธุฑ ููุท)

### ูููู ุชุนุฏูู:

1. **ุณูุงุณุงุช RLS ููุฃุฏูุงุฑ ุงูุฃุฎุฑู**
   - admin, accountant, cashier, archivist
   - ูุง ุชุคุซุฑ ุนูู ุญููู ุงููุณุชููุฏูู

2. **ูุงุฌูุงุช ุงููุณุชุฎุฏู ูุงูุชูุงุฑูุฑ**
   - ุชุญุณูู ุงูุชุฌุฑุจุฉ ุงูุจุตุฑูุฉ
   - ุฅุถุงูุฉ ุชูุงุฑูุฑ ุฌุฏูุฏุฉ

3. **ุชุญุณููุงุช ุงูุฃุฏุงุก**
   - Indexes ุฌุฏูุฏุฉ
   - Query optimization

4. **ุฅุถุงูุฉ ููุฒุงุช ุฌุฏูุฏุฉ**
   - ุทุงููุง ูุง ุชุคุซุฑ ุนูู ุงูุญููู ุงูุญุงููุฉ

---

## ๐ ูุฑุงุฌุนุฉ ุฏูุฑูุฉ

### ูุชุทูุจุงุช ุงููุฑุงุฌุนุฉ ุงูุฏูุฑูุฉ:

**ูู ุดูุฑ:**
- โ ุงูุชุญูู ูู ูุดุงุท ุงููุณุชููุฏูู ุงูู14
- โ ูุฑุงุฌุนุฉ ุณุฌู `protected_policies_log`
- โ ุงุฎุชุจุงุฑ Event Trigger

**ูู 3 ุฃุดูุฑ:**
- โ ูุฑุงุฌุนุฉ ุดุงููุฉ ููุตูุงุญูุงุช
- โ ุชุฏููู ุงููุตูู ููุจูุงูุงุช
- โ ุชูุฑูุฑ ุฃููู ุดุงูู

**ุณูููุงู:**
- โ ูุฑุงุฌุนุฉ ูุงููููุฉ
- โ ุชุญุฏูุซ ุงูุชูุซูู
- โ ุชุฏุฑูุจ ุงููุงุธุฑ ูุงููุญุงุณุจ

---

## ๐ ูุฑุงุฌุน ูุฑูุงุจุท

- [ุชูุซูู ุณูุงุณุงุช RLS](./RLS_POLICIES_DOCUMENTATION.md)
- [ุฏููู ุงููุณุชุฎุฏู ูููุณุชููุฏูู](./USER_GUIDE_BENEFICIARY.md)
- [ุณูุงุณุงุช ุงูุฃูุงู](./SECURITY_POLICIES.md)
- [ุชูุฑูุฑ ุงูุชุฏููู ุงูุฃููู](./COMPREHENSIVE_AUDIT_REPORT.md)

---

## ๐ ุงูุฏุนู

**ููุงุณุชูุณุงุฑุงุช ูุงูุฏุนู:**
- ๐ง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: support@waqf-platform.sa
- ๐ฑ ุงููุงุชู: +966 XX XXX XXXX
- ๐ ูุธุงู ุงูุชุฐุงูุฑ: [ูุชุญ ุชุฐูุฑุฉ ุฏุนู]

---

<div align="center">

**โ๏ธ ูุฐู ุงูุญููู ูููููุฉ ุดุฑุนุงู ููุธุงูุงู ููุญููุฉ ุชูููุงู**

**๐ ุขุฎุฑ ุชุญุฏูุซ:** 2025-11-22  
**๐ ุงูุฅุตุฏุงุฑ:** 1.0.0  
**๐ ูุณุชูู ุงูุญูุงูุฉ:** ุญุฑุฌ (Critical)

</div>