# ูุธุงู ุฅููุงู ุงูุณูุฉ ุงููุงููุฉ - ุฏููู ุดุงูู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุดุงูู ููุชูุงูู ูุฅููุงู ุงูุณููุงุช ุงููุงููุฉ ุจุทุฑููุฉ ูุฏููุฉ ุฃู ุชููุงุฆูุฉุ ูุน ุญุณุงุจ ุชููุงุฆู ูุฌููุน ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช ูุงูุญุตุต ูุงูุถุฑุงุฆุจ ูุงูุฒูุงุฉ ูุชูุฒูุนุงุช ุงููุณุชููุฏูู.

## โจ ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

### 1. ุงูุฅููุงู ุงูุชููุงุฆู
- โ ุญุณุงุจ ุชููุงุฆู ูุงูู ูุฌููุน ุงูุจููุฏ ุงููุงููุฉ
- โ ูุนุงููุฉ ุดุงููุฉ ูุจู ุงูุชูููุฐ ุงูููุงุฆู
- โ ุฅูุดุงุก ููุฏ ุงูุฅููุงู ุชููุงุฆูุงู
- โ ุญุณุงุจ ุฑูุจุฉ ุงูููู (ุงููุงุฆุถ)
- โ ุชูุฒูุน ุงูุญุตุต ุญุณุจ ุงููุณุจ ุงููุญุฏุฏุฉ

### 2. ุงูุฅููุงู ุงููุฏูู
- โ ุชุญูู ูุงูู ูู ูู ุฎุทูุฉ
- โ ูุฑุงุฌุนุฉ ุชูุตูููุฉ ูุจู ุงูุฅููุงู
- โ ุฅููุงููุฉ ุงูุชุนุฏูู ูุงูุชุฎุตูุต
- โณ ุฎุทูุงุช ุชูุตูููุฉ (ููุฏ ุงูุชุทููุฑ)

### 3. ุงูุญุณุงุจุงุช ุงููุงููุฉ
- โ ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช
- โ ุญุตุฉ ุงููุงุธุฑ (ูุณุจุฉ ูุงุจูุฉ ููุชุนุฏูู)
- โ ุญุตุฉ ุงููุงูู (ููุฎูุฑ)
- โ ุชูุฒูุนุงุช ุงููุณุชููุฏูู
- โ ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ
- โ ุงูุฒูุงุฉ
- โ ุฑูุจุฉ ุงูููู

### 4. ุงูุชูุงุฑูุฑ
- โ ุชูุฑูุฑ PDF ุดุงูู ููุณูุฉ ุงููุงููุฉ
- โ ููุฎุต ุชูููุฐู
- โ ุชูุตูู ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช
- โ ุงูุญุตุต ูุงูุงุณุชูุทุงุนุงุช
- โ ุงูุถุฑุงุฆุจ ูุงูุฒูุงุฉ
- โ ุชูุฒูุนุงุช ุงููุฑุซุฉ
- โ ุงููุฑูุฒ ุงููุงูู ุงูุฎุชุงูู

### 5. ุงูุฃูุงู ูุงูุญูุงูุฉ
- โ RLS Policies ูุญูุงูุฉ ุงูุจูุงูุงุช
- โ Trigger ูููุน ุงูุชุนุฏูู ุนูู ุงูุณููุงุช ุงููุบููุฉ
- โ ุตูุงุญูุงุช ูุญุฏุฏุฉ (admin, nazer, accountant ููุท)

## ๐๏ธ ุงูุจููุฉ ุงูุชูููุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### ุฌุฏูู fiscal_year_closings
```sql
CREATE TABLE fiscal_year_closings (
  id UUID PRIMARY KEY,
  fiscal_year_id UUID REFERENCES fiscal_years(id),
  closing_date TIMESTAMPTZ,
  closing_type TEXT CHECK (closing_type IN ('manual', 'automatic')),
  
  -- ุงูุฅูุฑุงุฏุงุช
  total_revenues NUMERIC,
  rental_revenues NUMERIC,
  other_revenues NUMERIC,
  
  -- ุงููุตุฑููุงุช
  total_expenses NUMERIC,
  administrative_expenses NUMERIC,
  maintenance_expenses NUMERIC,
  development_expenses NUMERIC,
  other_expenses NUMERIC,
  
  -- ุงูุญุตุต
  nazer_percentage NUMERIC,
  nazer_share NUMERIC,
  waqif_percentage NUMERIC,
  waqif_share NUMERIC,
  
  -- ุชูุฒูุนุงุช
  total_beneficiary_distributions NUMERIC,
  heirs_count INTEGER,
  
  -- ุงูุถุฑุงุฆุจ ูุงูุฒูุงุฉ
  total_vat_collected NUMERIC,
  total_vat_paid NUMERIC,
  net_vat NUMERIC,
  zakat_amount NUMERIC,
  
  -- ุฑูุจุฉ ุงูููู
  net_income NUMERIC,
  waqf_corpus NUMERIC,
  
  -- ุงูุฃุฑุตุฏุฉ
  opening_balance NUMERIC,
  closing_balance NUMERIC,
  
  -- ููุฏ ุงูุฅููุงู
  closing_journal_entry_id UUID,
  
  -- ุงูุจูุงูุงุช ุงูุชูุตูููุฉ
  heir_distributions JSONB,
  expense_breakdown JSONB,
  revenue_breakdown JSONB,
  
  -- ูุนูููุงุช ุงูุฅููุงู
  closed_by UUID,
  closed_by_name TEXT,
  notes TEXT,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### ุฏุงูุฉ calculate_fiscal_year_summary
```sql
CREATE OR REPLACE FUNCTION calculate_fiscal_year_summary(
  p_fiscal_year_id UUID
) RETURNS JSONB;
```
- ุชุญุณุจ ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช ูู ุงููููุฏ ุงูููููุฉ
- ุชุญุณุจ ุฅุฌูุงูู ุงููุตุฑููุงุช ูู ุงููููุฏ ุงูููููุฉ
- ุชุญุณุจ ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ
- ุชุญุณุจ ุชูุฒูุนุงุช ุงููุณุชููุฏูู
- ุชุฑุฌุน ููุฎุต JSON ุดุงูู

#### ุฏุงูุฉ protect_closed_fiscal_years
```sql
CREATE TRIGGER prevent_modifications_on_closed_years
  BEFORE INSERT OR UPDATE ON journal_entries
  FOR EACH ROW
  EXECUTE FUNCTION protect_closed_fiscal_years();
```
- ุชููุน ุฅุถุงูุฉ ุฃู ุชุนุฏูู ูููุฏ ูู ุงูุณููุงุช ุงููุบููุฉ
- ุชุฑูุน ุฎุทุฃ ุฅุฐุง ุญุงูู ุฃุญุฏ ุงูุชุนุฏูู

### Edge Functions

#### auto-close-fiscal-year
ูููุน: `supabase/functions/auto-close-fiscal-year/index.ts`

**ุงููุฏุฎูุงุช:**
```typescript
{
  fiscal_year_id: string;
  preview_only?: boolean; // ูููุนุงููุฉ ููุท ุฏูู ุชูููุฐ
}
```

**ุงููุฎุฑุฌุงุช:**
```typescript
{
  fiscal_year_id: string;
  fiscal_year_name: string;
  summary: {
    total_revenues: number;
    total_expenses: number;
    vat_collected: number;
    beneficiary_distributions: number;
    net_income: number;
    nazer_share: number;
    waqif_share: number;
  };
  closing_entry: {
    entry_number: string;
    entry_date: string;
    description: string;
    lines: ClosingEntryLine[];
    total_debit: number;
    total_credit: number;
  };
  waqf_corpus: number;
  heir_distributions: HeirDistribution[];
  can_close: boolean;
  warnings: string[];
}
```

**ุงููุธุงุฆู:**
1. ุงูุชุญูู ูู ุงูุณูุฉ ุงููุงููุฉ
2. ุญุณุงุจ ุงูููุฎุต ุงููุงูู
3. ุญุณุงุจ ุงูุฅูุฑุงุฏุงุช ูุงููุตุฑููุงุช ุงูุชูุตูููุฉ
4. ุญุณุงุจ ุชูุฒูุนุงุช ุงููุฑุซุฉ
5. ุงูุญุตูู ุนูู ุฅุนุฏุงุฏุงุช ุงูุชูุฒูุน
6. ุญุณุงุจ ุงูุญุตุต (ูุงุธุฑุ ูุงููุ ูุณุชููุฏูู)
7. ุญุณุงุจ ุฑูุจุฉ ุงูููู
8. ุฅูุดุงุก ููุฏ ุงูุฅููุงู ุงูููุชุฑุญ
9. ุงููุนุงููุฉ ุฃู ุงูุชูููุฐ ุงูููุงุฆู

### ุงูููููุงุช (Components)

#### 1. FiscalYearsManagement
`src/pages/FiscalYearsManagement.tsx`

ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ูุฅุฏุงุฑุฉ ุงูุณููุงุช ุงููุงููุฉ:
- ุนุฑุถ ุงูุณููุงุช ุงูููุชูุญุฉ ูุงููุบููุฉ
- ุงุฎุชูุงุฑ ุณูุฉ ูุนุฑุถ ุชูุงุตูููุง
- ุฃุฒุฑุงุฑ ุงูุฅููุงู ุงููุฏูู ูุงูุชููุงุฆู
- ููุญุฉ ุงุฎุชุจุงุฑุงุช ุดุงููุฉ

#### 2. FiscalYearSummaryCard
`src/components/fiscal-years/FiscalYearSummaryCard.tsx`

ุจุทุงูุฉ ุนุฑุถ ููุฎุต ุงูุณูุฉ ุงููุงููุฉ:
- ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช
- ุฅุฌูุงูู ุงููุตุฑููุงุช
- ุตุงูู ุงูุฏุฎู
- ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ
- ุชูุฒูุนุงุช ุงููุณุชููุฏูู
- ุฑูุจุฉ ุงูููู

#### 3. AutomaticClosingDialog
`src/components/fiscal-years/AutomaticClosingDialog.tsx`

ูุงูุฐุฉ ุงูุฅููุงู ุงูุชููุงุฆู:
- ูุนุงููุฉ ุดุงููุฉ ููุฅููุงู
- ุจุทุงูุงุช ุฅุญุตุงุฆูุงุช KPI
- ุนุฑุถ ููุฏ ุงูุฅููุงู ุงูููุชุฑุญ
- ุชุญุฐูุฑุงุช ุฅู ูุฌุฏุช
- ุฒุฑ ุงูุชุฃููุฏ ุงูููุงุฆู

#### 4. ManualClosingDialog
`src/components/fiscal-years/ManualClosingDialog.tsx`

ูุงูุฐุฉ ุงูุฅููุงู ุงููุฏูู:
- ุฎุทูุงุช ูุชุฏุฑุฌุฉ (ููุฏ ุงูุชุทููุฑ)
- ุงูุชุญูู ุงููุงูู ูู ูู ูุฑุญูุฉ

#### 5. FiscalYearClosingStats
`src/components/fiscal-years/FiscalYearClosingStats.tsx`

ุจุทุงูุงุช ุฅุญุตุงุฆูุงุช ุงูุฅููุงู:
- 6 ุจุทุงูุงุช KPI ูุน ุฃููููุงุช ููููุฉ
- ุนุฑุถ ุฌููุน ุงููุคุดุฑุงุช ุงููุงููุฉ ุงูุฑุฆูุณูุฉ

#### 6. FiscalYearTestPanel
`src/components/fiscal-years/FiscalYearTestPanel.tsx`

ููุญุฉ ุงุฎุชุจุงุฑุงุช ุดุงููุฉ:
- ุงุฎุชุจุงุฑ ุฌุฏูู fiscal_year_closings
- ุงุฎุชุจุงุฑ ุฏุงูุฉ calculate_fiscal_year_summary
- ุงุฎุชุจุงุฑ Edge Function
- ุงุฎุชุจุงุฑ ุญุณุงุจ ุงูุฒูุงุฉ
- ุงุฎุชุจุงุฑ RLS Policies
- ุงุฎุชุจุงุฑ Trigger ุงูุญูุงูุฉ
- ุนุฑุถ ูุชุงุฆุฌ ุจุตุฑูุฉ ูุน ูุณุจ ุงููุฌุงุญ

### ุงูู Hooks

#### useFiscalYearClosings
`src/hooks/useFiscalYearClosings.ts`

```typescript
const {
  closings,           // ุฌููุน ุนูููุงุช ุงูุฅููุงู
  isLoading,          // ุญุงูุฉ ุงูุชุญููู
  getClosingByFiscalYear,  // ุงูุญุตูู ุนูู ุฅููุงู ูุญุฏุฏ
  calculateSummary,   // ุญุณุงุจ ููุฎุต ุงูุณูุฉ
  createClosing,      // ุฅูุดุงุก ุฅููุงู ุฌุฏูุฏ
  updateClosing       // ุชุญุฏูุซ ุฅููุงู
} = useFiscalYearClosings();
```

### ุงูุชูุงุฑูุฑ

#### generateFiscalYearPDF
`src/lib/generateFiscalYearPDF.ts`

ูููุฏ ุชูุฑูุฑ PDF ุดุงูู ูุญุชูู ุนูู:
1. **ุงูุบูุงู**: ุงุณู ุงูุณูุฉ ุงููุงููุฉ ูุชุงุฑูุฎ ุงูุฅููุงู
2. **ุงูููุฎุต ุงูุชูููุฐู**: ุงูุฅูุฑุงุฏุงุชุ ุงููุตุฑููุงุชุ ุตุงูู ุงูุฏุฎูุ ุฑูุจุฉ ุงูููู
3. **ุงูุญุตุต ูุงูุงุณุชูุทุงุนุงุช**: ุญุตุฉ ุงููุงุธุฑุ ุงููุงููุ ุงููุณุชููุฏูู
4. **ุชูุตูู ุงููุตุฑููุงุช**: ุฅุฏุงุฑูุฉุ ุตูุงูุฉุ ุชุทููุฑุ ุฃุฎุฑู
5. **ุงูุถุฑุงุฆุจ ูุงูุฒูุงุฉ**: ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ ุงููุญุตูุฉ ูุงููุฏููุนุฉุ ุงูุฒูุงุฉ
6. **ุชูุฒูุนุงุช ุงููุฑุซุฉ**: ุชูุตูู ููู ูุงุฑุซ
7. **ุงููุฑูุฒ ุงููุงูู ุงูุฎุชุงูู**: ุงูุฑุตูุฏ ุงูุงูุชุชุงุญู ูุงูุฎุชุงูู

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### 1. ุงููุตูู ูููุธุงู
```
ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ > ุงููุงููุฉ > ุงูุณููุงุช ุงููุงููุฉ
```

### 2. ุงุฎุชูุงุฑ ุณูุฉ ูุงููุฉ
- ุงููุฑ ุนูู ุฃู ุณูุฉ ูู ุงููุงุฆูุฉ
- ุณูุธูุฑ ุงูููุฎุต ุงููุงูู ุชููุงุฆูุงู

### 3. ุงูุฅููุงู ุงูุชููุงุฆู
1. ุงููุฑ ุนูู ุฒุฑ "ุฅููุงู ุชููุงุฆู"
2. ุงูุชุธุฑ ุญุณุงุจ ุงููุนุงููุฉ ุงูุดุงููุฉ
3. ุฑุงุฌุน ุฌููุน ุงูุฃุฑูุงู ูููุฏ ุงูุฅููุงู
4. ุฅุฐุง ูุงู ูู ุดูุก ุตุญูุญุงูุ ุงููุฑ "ุชุฃููุฏ ุงูุฅููุงู ุงูุชููุงุฆู"

### 4. ุงูุฅููุงู ุงููุฏูู
1. ุงููุฑ ุนูู ุฒุฑ "ุฅููุงู ูุฏูู"
2. ุงุชุจุน ุงูุฎุทูุงุช ุงููุชุฏุฑุฌุฉ
3. ุฑุงุฌุน ูุนุฏูู ุญุณุจ ุงูุญุงุฌุฉ
4. ุฃูุฏ ุงูุฅููุงู

### 5. ุชูุฑูุฑ PDF
- ุจุนุฏ ุงูุฅููุงูุ ูููู ุชุญููู ุงูุชูุฑูุฑ ูู ุงูุฒุฑ ุงููุฎุตุต

## ๐งช ุงูุงุฎุชุจุงุฑุงุช

### ุชุดุบูู ููุญุฉ ุงูุงุฎุชุจุงุฑุงุช
1. ุงูุชุญ ุตูุญุฉ ุงูุณููุงุช ุงููุงููุฉ
2. ุงููุฑ "ุนุฑุถ ุงูุงุฎุชุจุงุฑุงุช"
3. ุงููุฑ "ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช"

### ุงูุงุฎุชุจุงุฑุงุช ุงููุชููุฑุฉ
- โ ุงุฎุชุจุงุฑ ุฌุฏูู fiscal_year_closings
- โ ุงุฎุชุจุงุฑ ุฏุงูุฉ calculate_fiscal_year_summary
- โ ุงุฎุชุจุงุฑ Edge Function
- โ ุงุฎุชุจุงุฑ ุญุณุงุจ ุงูุฒูุงุฉ (5.4.5)
- โ ุงุฎุชุจุงุฑ RLS Policies
- โ ุงุฎุชุจุงุฑ Trigger ุงูุญูุงูุฉ

## ๐ ุงูุชูุงุฑูุฑ ุงููุชุงุญุฉ

### 1. ููุฎุต ุงูุณูุฉ ุงููุงููุฉ
ูุนุฑุถ ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ:
- ุฅุฌูุงูู ุงูุฅูุฑุงุฏุงุช
- ุฅุฌูุงูู ุงููุตุฑููุงุช
- ุตุงูู ุงูุฏุฎู
- ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ
- ุชูุฒูุนุงุช ุงููุณุชููุฏูู
- ุฑูุจุฉ ุงูููู

### 2. ุชูุฑูุฑ PDF ุงูุดุงูู
ูููู ุชุญูููู ุจุนุฏ ุงูุฅููุงู:
- ููุฎุต ุชูููุฐู
- ุชูุตูู ูุงูู ูุฌููุน ุงูุจููุฏ
- ุชูุฒูุนุงุช ุงููุฑุซุฉ
- ุงููุฑูุฒ ุงููุงูู

## ๐ ุงูุตูุงุญูุงุช

### ูู ููููู ุงููุตููุ
- โ Admin
- โ Nazer (ุงููุงุธุฑ)
- โ Accountant (ุงููุญุงุณุจ)

### ูู ููููู ุฅููุงู ุงูุณูุฉุ
- โ Admin
- โ Nazer (ุงููุงุธุฑ)
- โ๏ธ Accountant (ุนุฑุถ ููุท)

## ๐ ููุงุญุธุงุช ูููุฉ

### ูุจู ุงูุฅููุงู
- ุชุฃูุฏ ูู ุชุฑุญูู ุฌููุน ุงููููุฏ ุงูููููุฉ
- ุฑุงุฌุน ุฌููุน ุงูุชูุฒูุนุงุช
- ุชุญูู ูู ุฃุฑุตุฏุฉ ุงูุจููู
- ุฑุงุฌุน ุงูููุงุชูุฑ ูุงููุฏููุนุงุช

### ุจุนุฏ ุงูุฅููุงู
- โ ูุง ูููู ุงูุชุนุฏูู ุนูู ุงูุณูุฉ ุงููุบููุฉ
- โ ูุง ูููู ุฅุถุงูุฉ ูููุฏ ุฌุฏูุฏุฉ
- โ ูููู ุงูุนุฑุถ ูุงูุชูุงุฑูุฑ ููุท
- โ ูููู ุชุญููู ุชูุฑูุฑ PDF

## ๐ ุงูุชุทููุฑุงุช ุงููุณุชูุจููุฉ

- โณ ุฅููุงู ุฎุทูุงุช ุงูุฅููุงู ุงููุฏูู ุงูุชูุตูููุฉ
- โณ ุงูุชุฑุญูู ุงูุชููุงุฆู ููุณูุฉ ุงูุฌุฏูุฏุฉ
- โณ ุชูุจููุงุช ูุจู ููุงูุฉ ุงูุณูุฉ ุงููุงููุฉ
- โณ ููุงุฑูุฉ ุงูุณููุงุช ุงููุงููุฉ
- โณ ุชุญูููุงุช ูุชูุฏูุฉ ููุฃุฏุงุก ุงููุงูู
- โณ ุฑุณูู ุจูุงููุฉ ูููุคุดุฑุงุช

## ๐ ุงูุฏุนู

ูููุณุงุนุฏุฉ ุฃู ุงูุฅุจูุงุบ ุนู ูุดููุฉ:
- ุงุณุชุฎุฏู ูุธุงู ุชุฐุงูุฑ ุงูุฏุนู ุฏุงุฎู ุงูููุตุฉ
- ุฑุงุฌุน ูุงุนุฏุฉ ุงููุนุฑูุฉ
- ุชูุงุตู ูุน ุงููุดุฑู

---

**ุชุงุฑูุฎ ุขุฎุฑ ุชุญุฏูุซ:** 2 ุฏูุณูุจุฑ 2025
**ุงูุฅุตุฏุงุฑ:** 1.0.0
**ุงูุญุงูุฉ:** โ ููุชูู ููุฎุชุจุฑ
