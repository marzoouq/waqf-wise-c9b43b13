# ๐ ุฎุทุฉ ุงูุชุดููุฑ ูุงูุญุฐู ุงูุขูู - ููุตุฉ ุฅุฏุงุฑุฉ ุงูููู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุตููู ูุธุงู ุดุงูู ูุชุดููุฑ ุงูุจูุงูุงุช ูุงููููุงุช ูุญุฐููุง ุจุดูู ุขููุ ูุน ุถูุงู ุงูุงูุชุซุงู ุงููุงูู ููุนุงููุฑ ุงูุฃูุงู ูุญูุงูุฉ ุงูุจูุงูุงุช.

---

## ๐๏ธ **ุงูุจููุฉ ุงูุชุญุชูุฉ ุงููููุฐุฉ**

### **1. ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**

#### **ุฃ) encryption_keys**
- ุฅุฏุงุฑุฉ ููุงุชูุญ ุงูุชุดููุฑ ูุชุฏููุฑูุง
- ุฏุนู AES-256 ู RSA-2048
- ุชุชุจุน ุตูุงุญูุฉ ุงูููุงุชูุญ ูุชุงุฑูุฎ ุงูุชุฏููุฑ
- **ูุญูู** - ูุง ููุนุฏู ุฅูุง ูู Admin/Nazer

#### **ุจ) encrypted_files**
- ุณุฌู ุดุงูู ูุฌููุน ุงููููุงุช ุงููุดูุฑุฉ
- ุชุฎุฒูู metadata ุงูุชุดููุฑ (IV, Tag, Checksum)
- ุฑุจุท ูู ููู ุจููุชุงุญ ุชุดููุฑ ูุญุฏุฏ
- ุชุชุจุน ุชุงุฑูุฎ ุงูุงูุชูุงุก ูุงูุญุฐู

#### **ุฌ) file_retention_policies**
- ุณูุงุณุงุช ุงูุงุญุชูุงุธ ุจุงููููุงุช
- ุงูุญุฐู ุงูุชููุงุฆู ุจุนุฏ ูุชุฑุฉ ูุญุฏุฏุฉ
- ุชุญุฏูุฏ ูุชุทูุจุงุช ุงูููุงููุฉ ููุญุฐู
- 5 ุณูุงุณุงุช ุงูุชุฑุงุถูุฉ ููุนุฑููุฉ ูุณุจูุงู

#### **ุฏ) deleted_files_audit**
- ุณุฌู ุฏุงุฆู ูุฌููุน ุงููููุงุช ุงููุญุฐููุฉ
- ุฅููุงููุฉ ุงูุงุณุชุฑุฌุงุน (Soft Delete)
- ุชุชุจุน ุณุจุจ ุงูุญุฐู ูุงููุณุคูู
- **ูุญูู** - ูุง ููุญุฐู ููุงูุชุซุงู

#### **ูู) sensitive_data_access_log**
- ุชุณุฌูู ูู ุนูููุฉ ูุตูู ููุจูุงูุงุช ุงูุญุณุงุณุฉ
- ุชุชุจุน ูุญุงููุงุช ุงููุตูู ุงููุฑููุถุฉ
- IP Address, User Agent, Session ID
- **ูุญูู** - ุงูุงุญุชูุงุธ ููุฏุฉ 180 ููู

#### **ู) file_deletion_requests**
- ุทูุจุงุช ุงูุญุฐู ุงูุชู ุชุญุชุงุฌ ููุงููุฉ
- ุณูุฑ ุนูู ููููุงููุฉ (Pending โ Approved โ Completed)
- ุชุญุฏูุฏ ุงูุฃููููุฉ (Low โ Urgent)

#### **ุฒ) encryption_key_rotation_history**
- ุณุฌู ุชุฏููุฑ ููุงุชูุญ ุงูุชุดููุฑ
- ุชุชุจุน ุงูููุงุชูุญ ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ
- ุญุงูุฉ ุงูุชุฏููุฑ (In Progress โ Completed โ Failed)

---

## โ๏ธ **Edge Functions ุงูููููุฐุฉ**

### **1. encrypt-file** ๐
**ุงูุบุฑุถ:** ุชุดููุฑ ุงููููุงุช ูุจู ุชุฎุฒูููุง

**ุงููุฏุฎูุงุช:**
- `file`: ุงูููู ุงููุฑุงุฏ ุชุดููุฑู
- `category`: ุชุตููู ุงูููู (optional)
- `expiresInDays`: ูุฏุฉ ุตูุงุญูุฉ ุงูููู (optional)

**ุงูุนูููุฉ:**
1. ูุฑุงุกุฉ ูุญุชูู ุงูููู
2. ุชูููุฏ ููุชุงุญ AES-256 ุนุดูุงุฆู
3. ุชูููุฏ IV (Initialization Vector)
4. ุชุดููุฑ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู AES-GCM
5. ุญุณุงุจ SHA-256 Checksum
6. ุฑูุน ุงูููู ุงููุดูุฑ ุฅูู Storage
7. ุญูุธ metadata ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
8. ุชุณุฌูู ุงูุนูููุฉ ูู Access Log

**ุงูููุฎุฑุฌุงุช:**
```json
{
  "success": true,
  "file": {
    "id": "uuid",
    "original_name": "document.pdf",
    "encrypted_path": "encrypted_xxx.enc",
    "checksum": "sha256_hash",
    "expires_at": "2025-12-31T00:00:00Z"
  }
}
```

---

### **2. decrypt-file** ๐
**ุงูุบุฑุถ:** ูู ุชุดููุฑ ุงููููุงุช ูููุณุชุฎุฏููู ุงููุตุฑุญ ููู

**ุงููุฏุฎูุงุช:**
- `fileId`: ูุนุฑู ุงูููู
- `accessReason`: ุณุจุจ ุงููุตูู (optional)

**ุงูุชุญููุงุช ุงูุฃูููุฉ:**
1. ุงูุชุญูู ูู ูููุฉ ุงููุณุชุฎุฏู (JWT)
2. ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุตูู (Admin/Nazer/Owner)
3. ุงูุชุญูู ูู ุนุฏู ุงูุชูุงุก ุตูุงุญูุฉ ุงูููู
4. ุชุณุฌูู ูุญุงููุฉ ุงููุตูู (ุณูุงุก ูุฌุญุช ุฃู ูุดูุช)

**ุงูุนูููุฉ:**
1. ุชุญููู ุงูููู ุงููุดูุฑ ูู Storage
2. ุงุณุชูุฑุงุฏ ููุชุงุญ ุงูุชุดููุฑ
3. ูู ุชุดููุฑ ุงูุจูุงูุงุช
4. ุงูุชุญูู ูู Checksum (Data Integrity)
5. ุชุญุฏูุซ ุนุฏุงุฏ ุงููุตูู
6. ุฅุฑุฌุงุน ุงูููู ูู Base64

**ุญูุงูุฉ ูู ุงููุฌูุงุช:**
- Rate Limiting (ูููุน ูุฌูุงุช Brute Force)
- Access Logging (ูุชุชุจุน ุงูุฃูุดุทุฉ ุงููุดุจููุฉ)
- Checksum Verification (ููุดู ุงูุชูุงุนุจ ุจุงูุจูุงูุงุช)

---

### **3. secure-delete-file** ๐๏ธ
**ุงูุบุฑุถ:** ุญุฐู ุงููููุงุช ุจุดูู ุขูู ูููุงู ููุณูุงุณุงุช

**ุฃููุงุน ุงูุญุฐู:**

#### **ุฃ) ุญุฐู ูุคูุช (Soft Delete)**
- ุชุญุฏูุฏ ูุชุฑุฉ ุงุณุชุฑุฌุงุน (ุงูุชุฑุงุถู: 30 ููู)
- ุงูููู ูุจูู ูู Storage
- ููุณุฌู ูู `deleted_files_audit` ูุน `can_restore=true`
- **ููุงุณุจ ูููููุงุช ุงููุงูุฉ**

#### **ุจ) ุญุฐู ููุงุฆู (Permanent Delete)**
- ุญุฐู ููุฑู ูู Storage
- ุญุฐู ุฌููุน ุงูุณุฌูุงุช ุงููุฑุชุจุทุฉ
- ุญุฐู ููุงุชูุญ ุงูุชุดููุฑ
- **ูุชุทูุจ ุตูุงุญูุงุช Admin/Nazer**

#### **ุฌ) ุญุฐู ุจููุงููุฉ (Approval Required)**
- ุฅูุดุงุก ุทูุจ ุญุฐู ูู `file_deletion_requests`
- ุงูุชุธุงุฑ ููุงููุฉ ุงููุฏูุฑ
- ุชูููุฐ ุงูุญุฐู ุจุนุฏ ุงูููุงููุฉ

**ุณูุฑ ุงูุนูู:**
```
User Request โ Check Policy โ Requires Approval?
                โ                      โ
           Direct Delete          Create Request
                โ                      โ
         Soft or Hard?         Approval Workflow
                โ                      โ
           Execute Delete      Review โ Approve/Reject
                                        โ
                                  Execute Delete
```

---

### **4. cleanup-old-files** ๐งน
**ุงูุบุฑุถ:** ูููุฉ ูุฌุฏููุฉ ูุญุฐู ุงููููุงุช ุงููุฏููุฉ ุชููุงุฆูุงู

**ุงูุนูููุงุช:**
1. **ุญุฐู ุงููููุงุช ููุชููุฉ ุงูุตูุงุญูุฉ**
   - ุงูุจุญุซ ุนู `expires_at < now()`
   - ุญุฐู ููุงุฆู ุชููุงุฆู

2. **ุชุทุจูู ุณูุงุณุงุช ุงูุงุญุชูุงุธ**
   - ููู ุณูุงุณุฉ ูุดุทุฉ ูุน `auto_delete=true`
   - ุญุณุงุจ ุชุงุฑูุฎ ุงูุงูุชูุงุก: `uploaded_at + retention_days`
   - ุญุฐู ุฃู ุฅูุดุงุก ุทูุจ ุญุฐู

3. **ุญุฐู ุงููููุงุช ุงููุญุฐููุฉ ูุคูุชุงู**
   - ุงูุจุญุซ ุนู `permanent_deletion_at < now()`
   - ุชุญููู Soft Delete ุฅูู Hard Delete

4. **ุชูุธูู ุณุฌูุงุช ุงููุตูู**
   - ุญุฐู ุงูุณุฌูุงุช ุงูุฃูุฏู ูู 180 ููู

**ุงูุฌุฏููุฉ ุงูููุตู ุจูุง:**
```bash
# ุชุดุบูู ููููุงู ุนูุฏ ุงูุณุงุนุฉ 2 ุตุจุงุญุงู
0 2 * * * curl -X POST https://your-project.supabase.co/functions/v1/cleanup-old-files
```

---

## ๐ **ุณูุงุณุงุช ุงูุฃูุงู (RLS Policies)**

### **1. encryption_keys**
- โ **Admin/Nazer ONLY**: Full Access
- โ **Others**: No Access

### **2. encrypted_files**
- โ **Admin/Nazer/Accountant**: View All
- โ **Admin/Nazer**: Full Management
- โ **Owner**: View Own Files Only

### **3. sensitive_data_access_log**
- โ **Admin/Nazer**: View All Logs
- โ **System**: Insert Logs (All Users)
- โ **Users**: Cannot Delete/Update Logs

### **4. deleted_files_audit**
- โ **Admin/Nazer**: View All
- โ **No One**: Cannot Delete (Permanent Audit Trail)

### **5. file_deletion_requests**
- โ **Users**: View Own Requests + Create
- โ **Admin/Nazer**: View All + Approve/Reject

---

## ๐ **ุณูุงุณุงุช ุงูุงุญุชูุงุธ ุงูุงูุชุฑุงุถูุฉ**

| ุงูุณูุงุณุฉ | ุงูุชุตููู | ูุฏุฉ ุงูุงุญุชูุงุธ | ุญุฐู ุชููุงุฆู | ูุชุทูุจ ููุงููุฉ |
|---------|---------|-------------|-----------|-------------|
| ุนููุฏ ููุชููุฉ | `expired_contracts` | 7 ุณููุงุช | โ | โ |
| ูุณุชูุฏุงุช ูุณุชููุฏูู ูุญุฐูููู | `deleted_beneficiary_docs` | 5 ุณููุงุช | โ | โ |
| ูุณุชูุฏุงุช ูุคูุชุฉ | `temporary_uploads` | 30 ููู | โ | โ |
| ูุณุฎ ุงุญุชูุงุทูุฉ ูุฏููุฉ | `old_backups` | 90 ููู | โ | โ |
| ุณุฌูุงุช ุงููุธุงู ุงููุฏููุฉ | `old_system_logs` | 180 ููู | โ | โ |

---

## ๐๏ธ **ุงุณุชุฎุฏุงู ุงููุธุงู ูู ุงูููุฏ**

### **ูุซุงู: ุชุดููุฑ ููู**
```typescript
import { useEncryption } from '@/hooks/useEncryption';

function UploadComponent() {
  const { encryptFile, isEncrypting } = useEncryption();
  
  const handleUpload = async (file: File) => {
    try {
      const result = await encryptFile({
        file,
        category: 'contracts',
        expiresInDays: 365
      });
      
      console.log('Encrypted File ID:', result.id);
    } catch (error) {
      console.error('Encryption failed:', error);
    }
  };
  
  return (
    <input 
      type="file" 
      onChange={(e) => handleUpload(e.target.files[0])}
      disabled={isEncrypting}
    />
  );
}
```

### **ูุซุงู: ูู ุชุดููุฑ ูุชูุฒูู**
```typescript
const { decryptFile, isDecrypting } = useEncryption();

const handleDownload = async (fileId: string) => {
  try {
    await decryptFile({
      fileId,
      accessReason: 'ูุฑุงุฌุนุฉ ุงูุนูุฏ'
    });
    // ุงูููู ูููุฒูู ุชููุงุฆูุงู
  } catch (error) {
    console.error('Decryption failed:', error);
  }
};
```

### **ูุซุงู: ุญุฐู ุขูู**
```typescript
const { deleteFileSafely, isDeleting } = useEncryption();

const handleDelete = async (fileId: string) => {
  try {
    const result = await deleteFileSafely({
      fileId,
      fileCategory: 'temporary_uploads',
      deletionReason: 'ูู ูุนุฏ ูุทููุจุงู',
      permanentDelete: false, // soft delete
      restoreDays: 30
    });
    
    if (result.requiresApproval) {
      console.log('Deletion request created');
    }
  } catch (error) {
    console.error('Deletion failed:', error);
  }
};
```

---

## ๐ **ูุคุดุฑุงุช ุงูุฃุฏุงุก ูุงููุฑุงูุจุฉ**

### **ููุงููุณ ูุฌุจ ูุชุงุจุนุชูุง:**
1. **ุนุฏุฏ ุงููููุงุช ุงููุดูุฑุฉ ููููุงู**
2. **ูุชูุณุท ููุช ุงูุชุดููุฑ/ูู ุงูุชุดููุฑ**
3. **ุนุฏุฏ ูุญุงููุงุช ุงููุตูู ุงููุฑููุถุฉ**
4. **ุงููุณุงุญุฉ ุงููุญุฑุฑุฉ ูู ุงูุชูุธูู ุงูุชููุงุฆู**
5. **ุนุฏุฏ ุทูุจุงุช ุงูุญุฐู ุงููุนููุฉ**

### **ุชูุจููุงุช ูุฌุจ ุฅุนุฏุงุฏูุง:**
- ๐จ ูุญุงููุงุช ูุตูู ูุฑููุถุฉ ูุชูุฑุฑุฉ (> 5 ูู ุณุงุนุฉ)
- โ๏ธ ูููุงุช ุชูุชุฑุจ ูู ุงูุชูุงุก ุงูุตูุงุญูุฉ (ุฎูุงู 7 ุฃูุงู)
- ๐ ุงุณุชุฎุฏุงู ูุฑุชูุน ููุชุฎุฒูู (> 80%)
- ๐ ููุงุชูุญ ุชุดููุฑ ุชุญุชุงุฌ ุชุฏููุฑ (> 90 ููู)

---

## ๐ **ุฃูุถู ุงูููุงุฑุณุงุช**

### **1. ุฅุฏุงุฑุฉ ุงูููุงุชูุญ**
- โ ุชุฏููุฑ ุงูููุงุชูุญ ูู 90 ููู
- โ ุนุฏู ูุดุงุฑูุฉ ุงูููุงุชูุญ ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- โ ุงุณุชุฎุฏุงู HSM ูุชุฎุฒูู ุงูููุงุชูุญ ุงูุฑุฆูุณูุฉ (ูู ุงูุฅูุชุงุฌ)
- โ ูุณุฎ ุงุญุชูุงุทู ูุดูุฑ ููููุงุชูุญ

### **2. ุงูุชุดููุฑ**
- โ ุชุดููุฑ ุฌููุน ุงููููุงุช ุงูุญุณุงุณุฉ ูุจู ุงูุชุฎุฒูู
- โ ุงุณุชุฎุฏุงู IV ุนุดูุงุฆู ุฌุฏูุฏ ููู ููู
- โ ุงูุชุญูู ูู Checksum ุจุนุฏ ูู ุงูุชุดููุฑ
- โ ูุณุญ ุงูููุงุชูุญ ูู ุงูุฐุงูุฑุฉ ุจุนุฏ ุงูุงุณุชุฎุฏุงู

### **3. ุงูุญุฐู**
- โ ุงุณุชุฎุฏุงู Soft Delete ูููููุงุช ุงููุงูุฉ
- โ ุชุทุจูู ุณูุงุณุงุช ุงุญุชูุงุธ ูุงุถุญุฉ
- โ ุชูุซูู ุณุจุจ ุงูุญุฐู ุฏุงุฆูุงู
- โ ูุฑุงุฌุนุฉ ุฏูุฑูุฉ ูููููุงุช ุงููุญุฐููุฉ

### **4. ุงูุชุฏููู ูุงูุงูุชุซุงู**
- โ ูุฑุงุฌุนุฉ ุณุฌูุงุช ุงููุตูู ุดูุฑูุงู
- โ ุงูุชุญูู ูู ุชุทุจูู ุณูุงุณุงุช ุงูุงุญุชูุงุธ
- โ ุชูุฑูุฑ ุดุงูู ุฑุจุน ุณููู
- โ ุงุฎุชุจุงุฑ ุงุณุชุฑุฌุงุน ุงููููุงุช ุงููุญุฐููุฉ

---

## โ๏ธ **ุชุญุฐูุฑุงุช ูุงูุฉ**

### **๐ด ูุง ุชูู ุจู:**
- โ ุชุฎุฒูู ููุงุชูุญ ุงูุชุดููุฑ ูู ุงูููุฏ
- โ ุญุฐู ุณุฌูุงุช ุงูู Audit Log
- โ ุชุนุทูู RLS Policies
- โ ูุดุงุฑูุฉ ุฑูุงุจุท ูู ุงูุชุดููุฑ ุงููุจุงุดุฑุฉ
- โ ุชุฎุทู ุนูููุฉ Checksum Verification

### **๐ก ุงูุชุจู ุฅูู:**
- โ๏ธ ุงููููุงุช ุงููุจูุฑุฉ (> 50MB) ูุฏ ุชุณุชุบุฑู ููุชุงู
- โ๏ธ ุงูุชุดููุฑ ูุฒูุฏ ุงูุญุฌู ุจูุณุจุฉ ~5-10%
- โ๏ธ ุนูููุงุช ูู ุงูุชุดููุฑ ุงููุชุฒุงููุฉ ุชุณุชููู ููุงุฑุฏ
- โ๏ธ ุงููููุงุช ููุชููุฉ ุงูุตูุงุญูุฉ ุชูุญุฐู ุชููุงุฆูุงู

---

## ๐ **ุงูุฏุนู ูุงูุตูุงูุฉ**

### **ูู ุญุงูุฉ ุงููุดุงูู:**
1. **ูุดู ุงูุชุดููุฑ:** ุชุญูู ูู ุญุฌู ุงูููู ูุตูุงุญูุงุช Storage
2. **ูุดู ูู ุงูุชุดููุฑ:** ุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู ูุตูุงุญูุฉ ุงูููู
3. **ูุดู ุงูุญุฐู:** ุชุญูู ูู ุณูุงุณุงุช ุงูุงุญุชูุงุธ ูุงูููุงููุงุช ุงููุทููุจุฉ
4. **ุจุทุก ุงูุฃุฏุงุก:** ุฑุงุฌุน Edge Function Logs ูุฒุฏ Timeout

### **ุตูุงูุฉ ุฏูุฑูุฉ:**
- ๐ง ุงุฎุชุจุงุฑ ุดูุฑู ูุนูููุฉ Encrypt/Decrypt
- ๐ง ูุฑุงุฌุนุฉ ุฑุจุน ุณูููุฉ ูุณูุงุณุงุช ุงูุงุญุชูุงุธ
- ๐ง ุชุฏููุฑ ุงูููุงุชูุญ ูู 90 ููู
- ๐ง ุชูุธูู ูุฏูู ูููููุงุช ุงููุฏููุฉ

---

## โ **ุงูุญุงูุฉ ุงูููุงุฆูุฉ**

### **ูุง ุชู ุชูููุฐู:**
โ 8 ุฌุฏุงูู ูุงุนุฏุฉ ุจูุงูุงุช ูุน RLS ูุญููุฉ  
โ 4 Edge Functions ููุชุดููุฑ ูุงูุญุฐู  
โ React Hook (useEncryption) ููุงุณุชุฎุฏุงู ุงูุณูู  
โ 5 ุณูุงุณุงุช ุงุญุชูุงุธ ุงูุชุฑุงุถูุฉ  
โ ุณุฌู Audit ุดุงูู ูุฏุงุฆู  
โ ูุธุงู ุญุฐู ุจููุงููุงุช ูุชุนุฏุฏุฉ ุงููุณุชููุงุช  
โ ุชูุธูู ุชููุงุฆู ูุฌุฏูู  

### **ุงูุฃูุงู:**
๐ AES-256-GCM Encryption  
๐ SHA-256 Checksum Verification  
๐ Row Level Security (RLS)  
๐ Access Logging ููุจูุงูุงุช ุงูุญุณุงุณุฉ  
๐ Multi-level Approval Workflow  
๐ Audit Trail ุฏุงุฆู  

---

## ๐ **ูุฑุงุฌุน ุฅุถุงููุฉ**

- [Web Crypto API Documentation](https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API)
- [AES-GCM Encryption](https://en.wikipedia.org/wiki/Galois/Counter_Mode)
- [Supabase Storage Documentation](https://supabase.com/docs/guides/storage)
- [Row Level Security Best Practices](https://supabase.com/docs/guides/auth/row-level-security)

---

**ุชุงุฑูุฎ ุงูุชูููุฐ:** 2025-01-22  
**ุงูุฅุตุฏุงุฑ:** 1.0.0  
**ุงูุญุงูุฉ:** โ ููููุฐ ุจุงููุงูู ูุฌุงูุฒ ููุฅูุชุงุฌ
