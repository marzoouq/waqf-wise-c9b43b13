# Truth Map - ุฎุฑูุทุฉ ูุตุงุฏุฑ ุงูุญูููุฉ
> ุขุฎุฑ ุชุญุฏูุซ: 2026-01-17

## ๐ ูุตุงุฏุฑ ุงูุจูุงูุงุช ุงูููุญุฏุฉ

ูุฐุง ุงูููู ููุซู ูุตุฏุฑ ูู ุฑูู/ูุคุดุฑ ูู ุงููุธุงู ูุถูุงู ุงูุชูุงุณู ูุชุณููู ุงูุชุชุจุน.

---

## 1. ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ (KPIs)

### 1.1 ุงููุณุชููุฏูู ุงููุดุทูู
| ุงูุนูุตุฑ | ุงููููุฉ |
|--------|--------|
| **ุงูููุญุงุช** | Admin, Nazer, Beneficiaries |
| **ุงูุฌุฏูู** | `beneficiaries` |
| **ุงูููุชุฑ** | `status = 'ูุดุท' OR status = 'active'` |
| **ุงูุฎุฏูุฉ** | `KPIService.getUnifiedKPIs()` |
| **Hook** | `useUnifiedKPIs` |
| **ุงูุซุงุจุช** | `matchesStatus(status, 'active')` |

### 1.2 ุฅุฌูุงูู ุงูุชุญุตูู
| ุงูุนูุตุฑ | ุงููููุฉ |
|--------|--------|
| **ุงูููุญุงุช** | Admin, Nazer, Properties |
| **ุงูุฌุฏูู** | `payment_vouchers` |
| **ุงูููุชุฑ** | `type = 'ูุจุถ' OR type = 'receipt', status = 'paid'` |
| **ุงูุฎุฏูุฉ** | `PropertyStatsService.getCollectionStats()` |
| **Hook** | `useCollectionStats` |
| **ุงูุซุงุจุช** | `COLLECTION_SOURCE` |

### 1.3 ุทูุจุงุช ุงูุตูุงูุฉ ุงูููุชูุญุฉ
| ุงูุนูุตุฑ | ุงููููุฉ |
|--------|--------|
| **ุงูููุญุงุช** | Admin, Properties |
| **ุงูุฌุฏูู** | `maintenance_requests` |
| **ุงูููุชุฑ** | `status IN ('ุฌุฏูุฏ', 'ููุฏ ุงูุชูููุฐ', 'ูู ุงูุงูุชุธุงุฑ', 'ุชุญุช ุงููุฑุงุฌุนุฉ')` |
| **ุงูุฎุฏูุฉ** | `MaintenanceService.getStats()` |
| **Hook** | `useMaintenanceStats` |
| **ุงูุซุงุจุช** | `MAINTENANCE_OPEN_STATUSES` |

### 1.4 ุงูุนููุฏ ุงููุดุทุฉ
| ุงูุนูุตุฑ | ุงููููุฉ |
|--------|--------|
| **ุงูููุญุงุช** | Admin, Nazer, Properties |
| **ุงูุฌุฏูู** | `contracts` |
| **ุงูููุชุฑ** | `status = 'ูุดุท' OR status = 'active'` |
| **ุงูุฎุฏูุฉ** | `KPIService.getUnifiedKPIs()` |
| **Hook** | `useUnifiedKPIs` |
| **ุงูุซุงุจุช** | `matchesStatus(status, 'active')` |

### 1.5 ุงููุณุชุฃุฌุฑูู ุงููุดุทูู
| ุงูุนูุตุฑ | ุงููููุฉ |
|--------|--------|
| **ุงูููุญุงุช** | Admin, Properties, Tenants |
| **ุงูุฌุฏูู** | `tenants` |
| **ุงูููุชุฑ** | `status = 'ูุดุท' OR status = 'active'` |
| **ุงูุฎุฏูุฉ** | `TenantService.getStats()` |
| **Hook** | `useTenants` |
| **ุงูุซุงุจุช** | `matchesStatus(status, 'active')` |

### 1.6 ุงูุนูุงุฑุงุช
| ุงูุนูุตุฑ | ุงููููุฉ |
|--------|--------|
| **ุงูููุญุงุช** | Admin, Properties |
| **ุงูุฌุฏูู** | `properties` |
| **ุงูููุชุฑ** | `status = 'ูุคุฌุฑ' OR status = 'rented'` |
| **ุงูุฎุฏูุฉ** | `PropertyStatsService.getBasicStats()` |
| **Hook** | `usePropertiesStats` |
| **ุงูุซุงุจุช** | `matchesStatus(status, 'rented')` |

---

## 2. ุงูุซูุงุจุช ุงููุณุชุฎุฏูุฉ

### 2.1 ุญุงูุงุช ุงููุณุชููุฏูู (`BENEFICIARY_STATUS`)
```typescript
ACTIVE: 'ูุดุท',
INACTIVE: 'ุบูุฑ ูุดุท',
SUSPENDED: 'ููููู',
PENDING: 'ูุนูู',
DECEASED: 'ูุชููู'
```

### 2.2 ุญุงูุงุช ุงูุนููุฏ (`CONTRACT_STATUS`)
```typescript
ACTIVE: 'ูุดุท',
EXPIRED: 'ููุชูู',
TERMINATED: 'ููุบู',
PENDING: 'ูุนูู',
DRAFT: 'ูุณูุฏุฉ'
```

### 2.3 ุญุงูุงุช ุงููุณุชุฃุฌุฑูู (`TENANT_STATUS`)
```typescript
ACTIVE: 'ูุดุท',
ACTIVE_EN: 'active',
INACTIVE: 'ุบูุฑ ูุดุท',
INACTIVE_EN: 'inactive',
SUSPENDED: 'ููููู',
SUSPENDED_EN: 'suspended'
```

### 2.4 ุญุงูุงุช ุงูุตูุงูุฉ
```typescript
MAINTENANCE_OPEN_STATUSES: ['ุฌุฏูุฏ', 'ููุฏ ุงูุชูููุฐ', 'ูู ุงูุงูุชุธุงุฑ', 'ุชุญุช ุงููุฑุงุฌุนุฉ']
MAINTENANCE_CLOSED_STATUSES: ['ููุชูู', 'ููุบู', 'ูุฑููุถ']
```

### 2.5 ุญุงูุงุช ุงูุณูุฏุงุช (`VOUCHER_STATUS`)
```typescript
DRAFT: 'draft',
PENDING: 'pending',
PAID: 'paid',
CANCELLED: 'cancelled',
CONFIRMED: 'confirmed'
```

### 2.6 ุญุงูุงุช ุณูุฑ ุนูู ุงูููุงููุงุช (`APPROVAL_WORKFLOW_STATUS`)
```typescript
PENDING: 'pending',
IN_PROGRESS: 'in_progress',
APPROVED: 'approved',
REJECTED: 'rejected',
COMPLETED: 'completed',
ESCALATED: 'escalated'
```

---

## 3. ุชุฏูู ุงูุจูุงูุงุช

```
โโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโ
โ   Database  โโโโโถโ   Service   โโโโโถโ    Hook     โโโโโถโ  Component  โ
โ  (Supabase) โ    โ  (*.service)โ    โ  (use*.ts)  โ    โ   (*.tsx)   โ
โโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโ
       โ                  โ                  โ                  โ
       โ                  โ                  โ                  โ
       โผ                  โผ                  โผ                  โผ
  โโโโโโโโโโโ       โโโโโโโโโโโ       โโโโโโโโโโโ       โโโโโโโโโโโ
  โ  Tables โ       โConstantsโ       โ  Cache  โ       โ   UI    โ
  โ   RLS   โ       โ Filters โ       โstaleTimeโ       โ Display โ
  โโโโโโโโโโโ       โโโโโโโโโโโ       โโโโโโโโโโโ       โโโโโโโโโโโ
```

---

## 4. ุงูุฎุฏูุงุช ุงูููุญุฏุฉ

| ุงูุฎุฏูุฉ | ุงููุธููุฉ | withRetry | matchesStatus |
|--------|---------|:---------:|:-------------:|
| `KPIService` | ุงููุคุดุฑุงุช ุงูููุญุฏุฉ | โ | โ |
| `PropertyStatsService` | ุฅุญุตุงุฆูุงุช ุงูุนูุงุฑุงุช | โ | โ |
| `TenantService` | ุฅุญุตุงุฆูุงุช ุงููุณุชุฃุฌุฑูู | โ | โ |
| `MaintenanceService` | ุฅุญุตุงุฆูุงุช ุงูุตูุงูุฉ | โ | โ |
| `BeneficiaryCoreService` | ุฅุญุตุงุฆูุงุช ุงููุณุชููุฏูู | โ | โ |
| `LoansService` | ุฅุญุตุงุฆูุงุช ุงููุฑูุถ | โ | โ |

---

## 5. ุงูููุญุงุช ููุตุงุฏุฑูุง

| ุงูููุญุฉ | Hook ุงูุฑุฆูุณู | ุงูุจูุงูุงุช |
|--------|-------------|----------|
| AdminDashboard | `useUnifiedKPIs` | KPIs + Charts |
| NazerDashboard | `useUnifiedKPIs` | KPIs + Distribution + Activity |
| AccountantDashboard | `useAccountantKPIs` | Journal + Approvals |
| CashierDashboard | `useCashierStats` | POS + Shifts |
| BeneficiaryPortal | `useBeneficiaryData` | Personal Data |
| TenantPortal | `useTenantData` | Contracts + Payments |
| ArchivistDashboard | `useArchiveStats` | Documents + Folders |
| DeveloperDashboard | `useSystemHealth` | Monitoring + Logs |

---

## 6. ููุงุนุฏ ุงูุชุญูู ูู ุงูุญุงูุงุช

### ุงุณุชุฎุฏุงู `matchesStatus()`
```typescript
import { matchesStatus } from '@/lib/constants';

// โ ุตุญูุญ - ูุฏุนู ุงููุบุชูู
const isActive = matchesStatus(tenant.status, 'active');

// โ ุฎุงุทุฆ - ูุง ูุฏุนู ุงููุบุชูู
const isActive = tenant.status === 'ูุดุท';
```

---

## 7. ููุงุญุธุงุช ูููุฉ

1. **ุงูุชูุงุณู**: ุฌููุน ุงูุฃุฑูุงู ูุฌุจ ุฃู ุชุฃุชู ูู ููุณ ุงููุตุฏุฑ
2. **ุงูุซูุงุจุช**: ุงุณุชุฎุฏู `matchesStatus()` ุฏุงุฆูุงู ููููุงุฑูุงุช
3. **ุงููุงุด**: `staleTime` ููุญุฏ ูู `QUERY_CONFIG`
4. **Retry**: ุฌููุน ุงูุฎุฏูุงุช ุงูุญุฑุฌุฉ ุชุณุชุฎุฏู `withRetry`
5. **RLS**: ุชุฃูุฏ ูู ุณูุงุณุงุช ุงููุตูู ูุจู ุงูุงุณุชุนูุงู

---

## 8. ุงูุชุญุฏูุซุงุช

| ุงูุชุงุฑูุฎ | ุงูุชุบููุฑ |
|---------|---------|
| 2026-01-17 | ุฅูุดุงุก ุงูููู ุงูุฃููู |
| 2026-01-17 | ุฅุถุงูุฉ `withRetry` ููุฎุฏูุงุช ุงูุญุฑุฌุฉ |
| 2026-01-17 | ุชูุญูุฏ ุญุงูุงุช ุงููุณุชุฃุฌุฑูู (ุนุฑุจู/ุฅูุฌููุฒู) |
| 2026-01-17 | ุฅุถุงูุฉ `VOUCHER_STATUS` ู `APPROVAL_WORKFLOW_STATUS` |
| 2026-01-17 | ูุญุต ุดุงูู ูู 56 Edge Function - ุณูููุฉ |
| 2026-01-17 | ูุญุต RLS - 10 ุณูุงุณุงุช ููุชูุญุฉ (ููุจููุฉ) |
| 2026-01-17 | ุชุทุจูู `matchesStatus` ุนูู 20+ ููู |
| 2026-01-17 | ุชุญุฏูุซ ContractService ู TrialBalanceService ุจู withRetry |
| 2026-01-17 | ุชุญุฏูุซ FamiliesStats, RentalPaymentDialog, CreateDistributionDialog, ReportsMenu |
| 2026-01-17 | **ุฅููุงู ุงููุฑุญูุฉ 1**: ุชุญุฏูุซ 12 ููู ุฅุถุงูู ูุงุณุชุฎุฏุงู `matchesStatus()` |
| 2026-01-17 | ุฅุถุงูุฉ ุญุงูุงุช ุงููุธุงู ุฅูู STATUS_MAPPINGS: healthy, acknowledged, stopped, standby, resolved |
| 2026-01-17 | ุงููููุงุช ุงููุญุฏุซุฉ: PropertiesListView, BeneficiariesTable, FamilyMembersDialog, TenantContracts |
| 2026-01-17 | ุงููููุงุช ุงููุญุฏุซุฉ: CreateMaintenanceRequestDialog, AdminAlertsPanel, SelfHealingToolsPanel |
| 2026-01-17 | ุงููููุงุช ุงููุญุฏุซุฉ: useAdminAlerts, useBeneficiariesFilters |
| 2026-01-17 | **ุฅููุงู ุงููุญุต ุงูููุงุฆู ูููุฑุญูุฉ 1**: WaqfUnitDetailsDialog, system.service, monitoring.service |
| 2026-01-17 | **ุงููุฑุญูุฉ 2 ููุชููุฉ**: ูุญุต 8 ููุญุงุช ุชุญูู - ุฌููุนูุง ุชุณุชุฎุฏู useUnifiedKPIs ู Realtime hooks |
| 2026-01-17 | **ุงููุฑุญูุฉ 3 ููุชููุฉ**: ูุญุต ุงูุตูุญุงุช ุงูุฏุงุฎููุฉ - ุชู ุชุญุฏูุซ 8 ุตูุญุงุช: |
| 2026-01-17 | โ EmergencyAidManagement, AllTransactions, Loans, Support |
| 2026-01-17 | โ GovernanceDecisions, Invoices + ุฅุถุงูุฉ ุญุงูุงุช ุงูุญูููุฉ ููุซูุงุจุช |
| 2026-01-17 | **ุงููุฑุญูุฉ 4 ููุชููุฉ**: ูุญุต ุงูุฎุฏูุงุช - ุชู ุชุญุฏูุซ 7 ุฎุฏูุงุช: |
| 2026-01-17 | โ unified-financial, invoice, maintenance, voucher, payment, approval, analysis |
| 2026-01-17 | **ุงููุฑุญูุฉ 5 ููุชููุฉ**: ูุญุต ุงูู Hooks - ุชู ุชุญุฏูุซ 14 Hook: |
| 2026-01-17 | โ useSystemMonitoring, useDistributionApprovals, useContractRequests, useContractNotifications |
| 2026-01-17 | โ useRequestApprovals, useBeneficiaryPersonalReportsData, useSystemErrorLogsData, useLoanApprovals |
| 2026-01-17 | โ useMyBeneficiaryRequests, useCollectionStats, useTransferStatusTracker, usePaymentVouchersData, useBatchPayments |
| 2026-01-17 | **ุงููุฑุญูุฉ 6 ููุชููุฉ**: ูุญุต ุงูุซูุงุจุช - ุชู ุฅุถุงูุฉ ูุชุญุฏูุซ: |
| 2026-01-17 | โ ุซูุงุจุช ุฌุฏูุฏุฉ: OCCUPANCY_STATUS, TICKET_STATUS, TRANSFER_STATUS, DISTRIBUTION_STATUS |
| 2026-01-17 | โ ุซูุงุจุช ุฌุฏูุฏุฉ: DISCLOSURE_STATUS, ZATCA_CHECK_STATUS |
| 2026-01-17 | โ ุชุญุฏูุซ STATUS_MAPPINGS: ุฅุถุงูุฉ occupied/vacant/published/posted/ููุงูู |
| 2026-01-17 | โ ุงูููููุงุช ุงููุญุฏุซุฉ: PropertyAccordionView, ViewJournalEntryDialog, AccountingKPIs |
| 2026-01-17 | โ ุงูููููุงุช ุงููุญุฏุซุฉ: PaymentApprovalsTab, DistributionApprovalsTab, EnhancedDisclosuresTab |
---

## 9. ุฅุญุตุงุฆูุงุช ุงููุธุงู ุงูุญุงููุฉ

| ุงููููุงุณ | ุงููููุฉ | ุงูุญุงูุฉ |
|---------|--------|--------|
| ุงูุนูุงุฑุงุช | 1 | โ ุณููู |
| ุงููุญุฏุงุช | 1 | โ ุณููู |
| ุงูุนููุฏ ุงููุดุทุฉ | 1 | โ ุณููู (ููุชูู ููููุจุฑ 2026) |
| ุงููุณุชุฃุฌุฑูู | 2 | โ ุณููู |
| ุงููุณุชููุฏูู ุงููุดุทูู | 14 | โ ุณููู |
| ุงูุนุงุฆูุงุช | 1 | โ ุณููู |
| ุทูุจุงุช ุงูุตูุงูุฉ ุงูููุชูุญุฉ | 2 | โ ุณููู |
| ุฅุฌูุงูู ุงูุชุญุตูู | 1,300 ุฑ.ุณ | โ ุณููู |
| Edge Functions | 56 | โ ุณูููุฉ |
| ุฃุฎุทุงุก ุงููุธุงู (7 ุฃูุงู) | 15 | โ ูุง ููุฌุฏ critical |
| ุงูุตูุญุงุช | 83 | โ ุณูููุฉ |
| ุงูุฎุฏูุงุช | 51+ | โ ูุน withRetry |
| ุงูู Hooks | 200+ | โ ูุน staleTime |

---

## 10. ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุงููุฑุญูุฉ 7)

### 10.1 ุงูุญุงูุงุช ุงููุนููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

| ุงูุฌุฏูู | ุงูุญูู | ุงููููุฉ ุงููุนููุฉ | ุงููุบุฉ | ููุงุญุธุงุช |
|--------|-------|---------------|-------|---------|
| `tenants` | `status` | `ูุดุท` | ุนุฑุจู โ | 2 ุณุฌูุงุช |
| `contracts` | `status` | `ูุดุท` | ุนุฑุจู โ | 1 ุณุฌู |
| `beneficiaries` | `status` | `ูุดุท` | ุนุฑุจู โ | 14 ุณุฌู |
| `maintenance_requests` | `status` | `ุฌุฏูุฏ` | ุนุฑุจู โ | 2 ุณุฌูุงุช |
| `payment_vouchers` | `status` | `paid` | ุฅูุฌููุฒู โ๏ธ | 1 ุณุฌู |
| `properties` | `status` | `ูุคุฌุฑ` | ุนุฑุจู โ | 1 ุณุฌู |
| `property_units` | `occupancy_status` | `ูุดุบูู` | ุนุฑุจู โ | 1 ุณุฌู |
| `journal_entries` | `status` | `posted` | ุฅูุฌููุฒู โ๏ธ | 1 ุณุฌู |
| `fiscal_years` | `is_active/is_closed` | boolean | - | 2 ุณุฌูุงุช |

### 10.2 ุณูุงูุฉ ุงูุนูุงูุงุช

| ุงููุญุต | ุงููุชูุฌุฉ |
|-------|---------|
| ุนููุฏ ุจุฏูู ูุณุชุฃุฌุฑูู | 0 โ |
| ุนููุฏ ุจุฏูู ูุญุฏุงุช | 0 โ |
| ุณูุฏุงุช ุจุฏูู ุนููุฏ | 0 โ |
| ูุณุชููุฏูู ุจุฏูู ุนุงุฆูุงุช | 0 โ |
| ุณุทูุฑ ูููุฏ ูุชููุฉ | 0 โ |

### 10.3 ููุฎุต ุงูุงูุชุดุงูุงุช

**โ ุฅูุฌุงุจู:**
- ุฌููุน ุงูุจูุงูุงุช ุชุณุชุฎุฏู ุงูุญุงูุงุช ุงูุนุฑุจูุฉ (`ูุดุท`, `ุฌุฏูุฏ`, `ูุดุบูู`, `ูุคุฌุฑ`)
- ูุง ุชูุฌุฏ ุณุฌูุงุช ูุชููุฉ (orphaned records)
- ุงูุนูุงูุงุช ุณูููุฉ 100%
- ุงูุจูุงูุงุช ูุชุณูุฉ

**โ๏ธ ููุงุญุธุงุช:**
- `payment_vouchers.status` = `paid` (ุฅูุฌููุฒู) - ููุจูู ูุฃู `matchesStatus()` ูุฏุนููุง
- `journal_entries.status` = `posted` (ุฅูุฌููุฒู) - ููุจูู ูุฃู `matchesStatus()` ูุฏุนููุง
- `fiscal_years` ุชุณุชุฎุฏู `is_active/is_closed` ุจุฏูุงู ูู `status` - ุชุตููู ูุฎุชูู

### 10.4 ุงูุณููุงุช ุงููุงููุฉ

| ุงููุนุฑู | ุงูุงุณู | ูุดุทุฉ | ูุบููุฉ |
|--------|-------|------|-------|
| `e255...` | Test Update | โ | โ |
| `a519...` | ุงูุณูุฉ ุงููุงููุฉ 2025-2026 | โ | โ |

---

## 11. ูุญุต ุงูุตูุงุญูุงุช (ุงููุฑุญูุฉ 8)

### 11.1 ุชูุฒูุน ุงูุฃุฏูุงุฑ ูู ุงููุธุงู

| ุงูุฏูุฑ | ุนุฏุฏ ุงููุณุชุฎุฏููู | ุนุฏุฏ ุงูุตูุงุญูุงุช | ุงููุฆุงุช |
|-------|----------------|---------------|--------|
| `nazer` | 2 | 201 | 8 |
| `admin` | 3 | 201 | 8 |
| `accountant` | 1 | 87 | 4 |
| `waqf_heir` | 14 | 36 | 7 |
| `archivist` | 1 | 25 | 3 |
| `cashier` | 1 | 15 | 6 |
| `beneficiary` | 2 | 9 | 3 |
| `user` | 3 | 6 | 2 |
| **ุงูุฅุฌูุงูู** | **27** | - | - |

### 11.2 ุญูุงูุฉ ุงููุณุงุฑุงุช

| ููุน ุงูุญูุงูุฉ | ุงูุชูููุฐ | ุงูุญุงูุฉ |
|-------------|---------|--------|
| `ProtectedRoute` | ุฌููุน ุงููุณุงุฑุงุช ุงูุญุณุงุณุฉ | โ |
| `requiredRole` | ุงูููุญุงุช ุงูุฎุงุตุฉ ุจุงูุฃุฏูุงุฑ | โ |
| `requiredRoles` | ุงูุตูุญุงุช ูุชุนุฏุฏุฉ ุงูุฃุฏูุงุฑ | โ |
| `requiredPermission` | ุบูุฑ ูุณุชุฎุฏู ุญุงููุงู | โ๏ธ |
| `PermissionGate` | ููุฌูุฏ ููู ุบูุฑ ูุณุชุฎุฏู | โ๏ธ |

### 11.3 ุชูุฌูู ุงูููุญุงุช

| ุงูุฏูุฑ | ุงููุณุงุฑ | ุงูุญูุงูุฉ |
|-------|--------|---------|
| `nazer` | `/nazer-dashboard` | `requiredRole="nazer"` โ |
| `admin` | `/admin-dashboard` | `requiredRole="admin"` โ |
| `accountant` | `/accountant-dashboard` | `requiredRole="accountant"` โ |
| `cashier` | `/cashier-dashboard` | `requiredRole="cashier"` โ |
| `archivist` | `/archivist-dashboard` | `requiredRole="archivist"` โ |
| `beneficiary` | `/beneficiary-portal` | `requiredRoles` โ |
| `waqf_heir` | `/beneficiary-portal` | `requiredRoles` โ |

### 11.4 ุงูุตูุญุงุช ุงูุญุณุงุณุฉ ูุญูุงูุชูุง

| ุงูุตูุญุฉ | ุงููุณุงุฑ | ุงูุฃุฏูุงุฑ ุงููุณููุญุฉ |
|--------|--------|-----------------|
| ุงููุณุชุฎุฏููู | `/users` | admin, nazer |
| ุงูุฃุฏูุงุฑ | `/settings/roles` | admin, nazer |
| ุงูุตูุงุญูุงุช | `/settings/permissions` | admin, nazer |
| ุณุฌูุงุช ุงูุชุฏููู | `/audit-logs` | admin, nazer |
| ุงููุณุชููุฏูู | `/beneficiaries` | admin, nazer, accountant |
| ุงููุญุงุณุจุฉ | `/accounting` | admin, nazer, accountant |
| ุงูุนูุงุฑุงุช | `/properties` | admin, nazer, accountant |
| ุงููุณุชุฃุฌุฑูู | `/tenants` | admin, nazer, accountant, cashier |
| ููุทุฉ ุงูุจูุน | `/pos` | nazer, accountant, cashier |

### 11.5 ููุฎุต ุงูุตูุงุญูุงุช

**โ ุฅูุฌุงุจู:**
- ุฌููุน ุงููุณุงุฑุงุช ุงูุญุณุงุณุฉ ูุญููุฉ ุจู `ProtectedRoute`
- ุงูุฃุฏูุงุฑ ููุตููุฉ ูู ุฌุฏูู ูููุตู (`user_roles`)
- ูุง ุชูุฌุฏ ุตูุงุญูุงุช ูู localStorage (ุฃูุงู)
- ูุธุงู timeout ููุชุญููู (3 ุซูุงูู)

**โ๏ธ ููุงุญุธุงุช:**
- `PermissionGate` ุบูุฑ ูุณุชุฎุฏู ูู ุงูููููุงุช (ูููู ุงุณุชุฎุฏุงูู ููุฃุฒุฑุงุฑ ุงูุญุณุงุณุฉ)
- `requiredPermission` ุบูุฑ ูุณุชุฎุฏู (ูุนุชูุฏ ุนูู ุงูุฃุฏูุงุฑ ููุท)

**๐ก ุชูุตูุงุช:**
- ุงุณุชุฎุฏุงู `PermissionGate` ููุฃุฒุฑุงุฑ ุงูุญุณุงุณุฉ (ุญุฐูุ ุชุนุฏูู)
- ุฅุถุงูุฉ ูุญุต ุตูุงุญูุงุช ุฏูููุฉ ุจุงุณุชุฎุฏุงู `requiredPermission`

---

## 12. ูุญุต Edge Functions (ุงููุฑุญูุฉ 9)

### 12.1 ููุฎุต ุงููุธุงุฆู

| ุงููุฆุฉ | ุงูุนุฏุฏ | verify_jwt = true | verify_jwt = false |
|-------|-------|-------------------|-------------------|
| ุงูุฐูุงุก ุงูุงุตุทูุงุนู | 5 | 4 | 1 |
| ุงููุงููุฉ | 6 | 5 | 1 |
| ุงูุฅุดุนุงุฑุงุช | 6 | 4 | 2 |
| ุงููุณุฎ/ุงูุงุณุชุนุงุฏุฉ | 3 | 2 | 1 |
| ุงูุตูุงูุฉ | 5 | 0 | 5 |
| ุงููุณุชูุฏุงุช | 4 | 3 | 1 |
| ุงููุณุชุฃุฌุฑูู | 3 | 0 | 3 |
| ุงูุฃุฎุฑู | 24 | 15 | 9 |
| **ุงูุฅุฌูุงูู** | **56** | **33** | **23** |

### 12.2 ูุธุงุฆู ุงูุฐูุงุก ุงูุงุตุทูุงุนู

| ุงููุธููุฉ | ุงููุตู | JWT | Health Check |
|---------|-------|-----|--------------|
| `chatbot` | ุงููุณุงุนุฏ ุงูุฐูู | โ | โ |
| `generate-ai-insights` | ุงูุฑุคู ุงูุฐููุฉ | โ | โ |
| `ai-system-audit` | ุชุฏููู ุงููุธุงู | โ | โ |
| `intelligent-search` | ุงูุจุญุซ ุงูุฐูู | โ | โ |
| `property-ai-assistant` | ูุณุงุนุฏ ุงูุนูุงุฑุงุช | โ | โ |

### 12.3 ูุธุงุฆู ุงููุงููุฉ

| ุงููุธููุฉ | ุงููุตู | JWT | Rate Limit |
|---------|-------|-----|------------|
| `distribute-revenue` | ุชูุฒูุน ุงูุฅูุฑุงุฏุงุช | โ | 3/ุณุงุนุฉ |
| `simulate-distribution` | ูุญุงูุงุฉ ุงูุชูุฒูุน | โ | - |
| `auto-create-journal` | ุงูููุฏ ุงูุขูู | โ | โ |
| `publish-fiscal-year` | ูุดุฑ ุงูุณูุฉ ุงููุงููุฉ | โ | โ |
| `auto-close-fiscal-year` | ุฅููุงู ุงูุณูุฉ ุงููุงููุฉ | โ | โ |
| `zatca-submit` | ุฅุฑุณุงู ZATCA | โ | โ |

### 12.4 ูุธุงุฆู ุงูุตูุงูุฉ (scheduled)

| ุงููุธููุฉ | ุงููุตู | JWT | CRON |
|---------|-------|-----|------|
| `backup-database` | ุงููุณุฎ ุงูุงุญุชูุงุทู | โ | - |
| `weekly-maintenance` | ุงูุตูุงูุฉ ุงูุฃุณุจูุนูุฉ | โ | โ |
| `scheduled-cleanup` | ุงูุชูุธูู ุงููุฌุฏูู | โ | โ |
| `run-vacuum` | ุชูุธูู ูุงุนุฏุฉ ุงูุจูุงูุงุช | โ | โ |
| `db-health-check` | ูุญุต ุตุญุฉ DB | โ | โ |

### 12.5 ูุธุงุฆู ุจูุงุจุฉ ุงููุณุชุฃุฌุฑูู

| ุงููุธููุฉ | ุงููุตู | JWT | Session Token |
|---------|-------|-----|---------------|
| `tenant-portal` | API ุจูุงุจุฉ ุงููุณุชุฃุฌุฑ | โ | `x-tenant-session` |
| `tenant-send-otp` | ุฅุฑุณุงู OTP | โ | - |
| `tenant-verify-otp` | ุงูุชุญูู ูู OTP | โ | - |

### 12.6 ุงูุฃูุงู ูุงูุญูุงูุฉ

**โ ุฅูุฌุงุจู:**
- 51/56 ูุธููุฉ ูุฏููุง Health Check endpoint
- Rate Limiting ููุนู ุนูู ุงููุธุงุฆู ุงูุญุณุงุณุฉ
- CORS headers ููุญุฏุฉ ุนุจุฑ `_shared/cors.ts`
- ูุญุต ุงูุฃุฏูุงุฑ (`admin`/`nazer`) ูููุธุงุฆู ุงูุญุณุงุณุฉ

**โ๏ธ ููุงุญุธุงุช:**
- 5 ูุธุงุฆู ุจุฏูู Health Check (ูุงูุตุฉ)
- ุจุนุถ ุงููุธุงุฆู ุชุณุชุฎุฏู `verify_jwt = false` ูุฃููุง ุชูุญุต JWT ูุฏููุงู

**๐ ุงููุธุงุฆู ุงููุถุงูุฉ ููุชูููู:**
- `tenant-portal` (verify_jwt = false)
- `tenant-send-otp` (verify_jwt = false)
- `tenant-verify-otp` (verify_jwt = false)
- `auto-close-fiscal-year` (verify_jwt = true)
- `scheduled-tests` (verify_jwt = false)

---

## 13. ูุญุต ุงูุฃุฏุงุก (ุงููุฑุญูุฉ 10)

### 13.1 ุฅุนุฏุงุฏุงุช Cache (staleTime)

| ุงููุฆุฉ | staleTime | refetchInterval | ุงูุงุณุชุฎุฏุงู |
|-------|-----------|-----------------|-----------|
| `DEFAULT` | 2 ุฏูุงุฆู | - | ุงูุงุณุชุนูุงูุงุช ุงูุนุงูุฉ |
| `REALTIME` | 30 ุซุงููุฉ | - | ุงูุจูุงูุงุช ุงูุญูุฉ |
| `STATIC` | 30 ุฏูููุฉ | - | ุงูุจูุงูุงุช ุงูุซุงุจุชุฉ |
| `DASHBOARD_KPIS` | 2 ุฏูุงุฆู | 5 ุฏูุงุฆู | ูุคุดุฑุงุช ุงูุฃุฏุงุก |
| `REPORTS` | 2 ุฏูุงุฆู | โ ูุฏูู | ุงูุชูุงุฑูุฑ |
| `CHARTS` | 1 ุณุงุนุฉ | โ | ุงูุฑุณูู ุงูุจูุงููุฉ |
| `LOANS` | 1 ุณุงุนุฉ | โ | ุงููุฑูุถ |

**โ ุฅูุฌุงุจู:**
- ุฅุนุฏุงุฏุงุช ููุญุฏุฉ ุนุจุฑ `src/infrastructure/react-query/queryConfig.ts`
- 86 ููู ูุณุชุฎุฏู staleTime ุจุดูู ุตุญูุญ
- gcTime ูุญุฏุฏ ูููุน ุชุฑุงูู ุงูุฐุงูุฑุฉ

### 13.2 ุขููุฉ Retry

| ุงูุฎุฏูุฉ | withRetry | ุงููุญุงููุงุช | ุงูุชุฃุฎูุฑ |
|--------|-----------|-----------|---------|
| `kpi.service.ts` | โ | 3 | 500ms-5s |
| `property-stats.service.ts` | โ | 3 | 500ms-5s |
| `maintenance.service.ts` | โ | 3 | 500ms-5s |
| `contract.service.ts` | โ | 3 | 500ms-5s |
| `beneficiary/core.service.ts` | โ | 3 | 500ms-5s |
| `trial-balance.service.ts` | โ | 3 | 500ms-5s |

**ุงูุฅุนุฏุงุฏุงุช (`SUPABASE_RETRY_OPTIONS`):**
```typescript
{
  maxRetries: 3,
  initialDelay: 500,
  backoffMultiplier: 2,
  maxDelay: 5000,
  shouldRetry: (error) => {
    // ูุง ูุนูุฏ ุงููุญุงููุฉ ูุฃุฎุทุงุก RLS/401
    // ูุนูุฏ ุงููุญุงููุฉ ูู: failed to fetch, network, timeout
  }
}
```

### 13.3 Pagination

| ุงูุตูุญุฉ | Pagination | PageSize | ุงูุชูููู |
|--------|------------|----------|---------|
| `GovernanceDecisions` | โ | 15 | ููุชุงุฒ |
| `AllTransactions` | โ | ูุชุบูุฑ | ููุชุงุฒ |
| `AuditLogs` | โ | 50-100 | ุฌูุฏ |
| `Beneficiaries` | โ | ุนุจุฑ filters | ุฌูุฏ |
| `Contracts` | โ | getPaginated | ููุชุงุฒ |

**ุฅุนุฏุงุฏุงุช Pagination:**
- `DEFAULT_PAGE_SIZE`: 15
- `PAGE_SIZE_OPTIONS`: [10, 15, 25, 50, 100]

### 13.4 ุฃุญุฌุงู ุงูุฌุฏุงูู ุงููุจูุฑุฉ

| ุงูุฌุฏูู | ุงูุญุฌู | ุงูุณุฌูุงุช | ููุงุญุธุงุช |
|--------|-------|---------|---------|
| `audit_logs_archive` | 7.3 MB | 1,256 | โ๏ธ ูุญุชุงุฌ ุฃุฑุดูุฉ ุฏูุฑูุฉ |
| `audit_logs` | 5.7 MB | 2,904 | โ๏ธ ูุญุชุงุฌ ุชูุธูู |
| `beneficiary_activity_log` | 2.5 MB | 1,384 | ุทุจูุนู |
| `system_alerts` | 1.9 MB | 31 | ุทุจูุนู |
| `notifications` | 440 KB | 686 | ุทุจูุนู |

### 13.5 ุฃุฎุทุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฃุฎูุฑุฉ

| ุงูุฎุทุฃ | ุงูููุน | ุงูุชูุตูุฉ |
|-------|-------|---------|
| `column "status" does not exist` | ERROR | ูุญุต ุงูุงุณุชุนูุงู |
| `UNION types text and entry_status cannot be matched` | ERROR | ุชูุญูุฏ ุงูุฃููุงุน |

### 13.6 ููุฒุงููุฉ ุงูุฃุฏุงุก (performance-budget.json)

| ุงููููุงุณ | ุงููุฏู | ุงูุญุงูุฉ |
|---------|-------|--------|
| JavaScript Initial | 250KB | โ |
| CSS Total | 100KB | โ |
| FCP | 1.5s | โ |
| LCP | 2.5s | โ |
| TTI | 3s | โ |
| Max API Calls | 10 | โ |
| Max Rerenders | 3 | โ |

### 13.7 ุชูุตูุงุช ุงูุชุญุณูู

**โ ูุทุจู:**
- withRetry ุนูู ุงูุฎุฏูุงุช ุงูุญุฑุฌุฉ
- staleTime ููุญุฏ ุนุจุฑ QUERY_CONFIG
- Pagination ูู ุงูููุงุฆู ุงููุจูุฑุฉ
- Lazy loading ููุตูุญุงุช (lazyWithRetry)

**โ ุชู ุชุทุจูููุง:**
1. โ ุฅุถุงูุฉ ููุงุฑุณ ูุฌุฏูู `audit_logs` ุนูู `created_at` + `action_type` + `table_name` + `user_id`
2. โ ุฅูุดุงุก ุฏุงูุฉ `archive_old_audit_logs(months_old)` ููุฃุฑุดูุฉ ุงูุชููุงุฆูุฉ
3. โ ุชูุนูู `refetchOnWindowFocus: false` ููุตูุญุงุช ุบูุฑ ุงูุญุณุงุณุฉ
4. โ ุฅุถุงูุฉ `gcTime` ูุฌููุน ุงูุฅุนุฏุงุฏุงุช ูู `QUERY_CONFIG`
5. โ ุฅุถุงูุฉ ููุงุฑุณ ูุฌุฏุงูู: `beneficiary_activity_log`, `notifications`, `system_alerts`
6. โ ุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช ุฌุฏูุฏุฉ: `REFERENCE_DATA`, `PAGINATED_LIST`, `SENSITIVE`

---

## 14. ูุญุต ุตุญุฉ ุงููุธุงู (ุงููุฑุญูุฉ 11)

### 14.1 ุงูุญุงูุฉ ุงูุนุงูุฉ ูููุธุงู

| ุงููููุงุณ | ุงููููุฉ | ุงูุญุงูุฉ |
|---------|--------|--------|
| ูุณุจุฉ Cache Hit | 99.98% | โ ููุชุงุฒ |
| ุงูุนููุฏ ุงูููุชููุฉ ุฎูุงู 30 ููู | 0 | โ |
| ุทูุจุงุช ุงูุตูุงูุฉ ุงููุชุฃุฎุฑุฉ (>7 ุฃูุงู) | 0 | โ |
| ุงูุชูุจููุงุช ุงููุดุทุฉ | 0 | โ |
| ุนููุฏ ุจุฏูู ูุณุชุฃุฌุฑ | 0 | โ |
| ูุณุชููุฏูู ุจุฏูู ุนุงุฆูุฉ | 0 | โ |
| ูุญุฏุงุช ุจุฏูู ุนูุงุฑ | 0 | โ |

### 14.2 ุฃุญุฌุงู ุงูุฌุฏุงูู ุงููุจูุฑุฉ

| ุงูุฌุฏูู | ุงูุญุฌู | ููุงุญุธุงุช |
|--------|-------|---------|
| `audit_logs_archive` | 7.3 MB | โ๏ธ ูุญุชุงุฌ ุฃุฑุดูุฉ ุฏูุฑูุฉ |
| `audit_logs` | 5.8 MB | โ๏ธ ุชุดุบูู `archive_old_audit_logs(3)` |
| `beneficiary_activity_log` | 2.6 MB | ุทุจูุนู |
| `system_alerts` | 1.9 MB | ุทุจูุนู |
| `system_health_checks` | 1.7 MB | ุทุจูุนู |
| `system_error_logs` | 856 KB | ุทุจูุนู |

### 14.3 ุงูุฃุฎุทุงุก ุงูุฃุฎูุฑุฉ (7 ุฃูุงู)

| ุงูุฎุทูุฑุฉ | ุงูุนุฏุฏ | ุขุฎุฑ ุญุฏูุซ |
|---------|-------|----------|
| `high` | 13 | 2026-01-17 14:01 |
| `medium` | 2 | 2026-01-16 00:57 |

### 14.4 ูุดุงุท ุงูุชุฏููู (24 ุณุงุนุฉ)

| ููุน ุงูุนูููุฉ | ุงูุนุฏุฏ |
|-------------|-------|
| `UPDATE` | 41 |
| `db_health_check` | 29 |
| `PASSWORD_RESET` | 1 |

### 14.5 ุงูููุงุฑุณ ุบูุฑ ุงููุณุชุฎุฏูุฉ

| ุงูุฌุฏูู | ุงูููุฑุณ | ุงูุญุฌู | ููุงุญุธุงุช |
|--------|--------|-------|---------|
| `audit_logs` | `audit_logs_pkey` | 144 KB | ุทุจูุนู - ููุชุงุญ ุฃุณุงุณู |
| `audit_logs` | `idx_audit_logs_user_created` | 104 KB | โ ุฌุฏูุฏ - ุณููุณุชุฎุฏู |
| `beneficiary_activity_log` | `idx_beneficiary_activity_beneficiary` | 72 KB | โ ุฌุฏูุฏ |
| `notifications` | `idx_notifications_user_unread` | 56 KB | โ ุฌุฏูุฏ |

### 14.6 Edge Function ููุญุต ุงูุตุญุฉ

- **db-health-check**: ููุญุต ุตุญุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุดุงููุงู
  - ูุญูู ุจู JWT + Role Check (admin/nazer)
  - Rate Limit: 10 ุทูุจุงุช/ุณุงุนุฉ
  - ููุญุต: ุงูููุงุฑุณ ุงูููุฑุฑุฉุ ุณูุงุณุงุช RLS ุงูููุฑุฑุฉุ ุงูุตููู ุงูููุชุฉุ ุฃุฎุทุงุก ุงูุงุณุชุนูุงูุงุช

### 14.7 ุฏุงูุฉ ุงูุฃุฑุดูุฉ ุงูุฌุฏูุฏุฉ

```sql
-- ุฃุฑุดูุฉ ุงูุณุฌูุงุช ุฃูุฏู ูู 3 ุฃุดูุฑ
SELECT archive_old_audit_logs(3);
```

---

## โ ููุฎุต ุงููุฑุงุญู ุงูููุชููุฉ

| ุงููุฑุญูุฉ | ุงููุตู | ุงูุญุงูุฉ |
|---------|-------|--------|
| 1 | ุฅุตูุงุญ ุงููุดุงูู ุงูุญุฑุฌุฉ | โ ููุชูู |
| 2 | ูุญุต ููุญุงุช ุงูุชุญูู | โ ููุชูู |
| 3 | ูุญุต ุงูุตูุญุงุช | โ ููุชูู |
| 4 | ูุญุต ุงูุฎุฏูุงุช | โ ููุชูู |
| 5 | ูุญุต ุงูู Hooks | โ ููุชูู |
| 6 | ูุญุต ุงูุซูุงุจุช | โ ููุชูู |
| 7 | ูุญุต ูุงุนุฏุฉ ุงูุจูุงูุงุช | โ ููุชูู |
| 8 | ูุญุต ุงูุตูุงุญูุงุช | โ ููุชูู |
| 9 | ูุญุต Edge Functions | โ ููุชูู |
| 10 | ูุญุต ุงูุฃุฏุงุก | โ ููุชูู - ุงูุชูุตูุงุช ููุทุจูุฉ |
| 11 | ูุญุต ุตุญุฉ ุงููุธุงู | โ ููุชูู |
| 12 | ุงูุชูุซูู ุงูููุงุฆู | โณ ููุฏ ุงูุชูููุฐ |
