# 🔗 دليل التكاملات الشامل | Integrations Guide

**تاريخ الإنشاء:** 2025-11-29  
**الإصدار:** 1.0.0

---

## 📋 جدول المحتويات

1. [التكاملات الموجودة](#-التكاملات-الموجودة-حالياً)
2. [تكاملات الذكاء الاصطناعي](#-تكاملات-الذكاء-الاصطناعي)
3. [تكاملات الدفع والبنوك](#-تكاملات-الدفع-والبنوك)
4. [تكاملات حكومية](#-تكاملات-حكومية)
5. [التكاملات المقترحة](#-التكاملات-المقترحة-للإضافة)
6. [إعداد مفاتيح API](#-إعداد-مفاتيح-api)
7. [قوالب الطلبات](#-قوالب-الطلبات-prompts)
8. [بنية التكاملات](#-بنية-التكاملات)

---

## 📊 التكاملات الموجودة حالياً

### نظرة عامة

```
┌─────────────────────────────────────────────────────────────────┐
│                    🔗 خريطة التكاملات                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐      │
│   │ 🤖 AI      │     │ 💳 الدفع    │     │ 🏛️ حكومية  │       │
│   │ Services   │     │ والبنوك     │     │ Services   │       │
│   └──────┬──────┘     └──────┬──────┘     └──────┬──────┘      │
│          │                   │                   │              │
│          ▼                   ▼                   ▼              │
│   ┌─────────────────────────────────────────────────────┐      │
│   │                  ⚡ Edge Functions                   │      │
│   │  chatbot │ ocr-document │ zatca-submit │ ...       │      │
│   └─────────────────────────────────────────────────────┘      │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────┐      │
│   │                    💾 Supabase                       │      │
│   │  Database │ Auth │ Storage │ Realtime              │      │
│   └─────────────────────────────────────────────────────┘      │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────┐      │
│   │                    🖥️ Frontend                       │      │
│   │  React │ Components │ Hooks │ Services              │      │
│   └─────────────────────────────────────────────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🤖 تكاملات الذكاء الاصطناعي

### الجدول الشامل

| التكامل | Edge Function | الوصف | الحالة |
|---------|---------------|-------|--------|
| **المساعد الذكي** | `chatbot/` | محادثة ذكية لمساعدة المستخدمين | ✅ فعال |
| **استخراج OCR** | `ocr-document/` | قراءة النصوص من المستندات والصور | ✅ فعال |
| **تحليلات AI** | `generate-ai-insights/` | توليد رؤى وتحليلات من البيانات | ✅ فعال |
| **مساعد العقارات** | `property-ai-assistant/` | تحليل وتوصيات عقارية | ✅ فعال |
| **البحث الذكي** | `intelligent-search/` | بحث دلالي متقدم | ✅ فعال |
| **استخراج الفواتير** | `extract-invoice-data/` | قراءة بيانات الفواتير تلقائياً | ✅ فعال |

### Edge Function: chatbot

```typescript
// supabase/functions/chatbot/index.ts
// استخدام Lovable AI Gateway

const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
  method: "POST",
  headers: {
    Authorization: `Bearer ${Deno.env.get("LOVABLE_API_KEY")}`,
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    model: "google/gemini-2.5-flash", // النموذج الافتراضي
    messages: [
      { role: "system", content: systemPrompt },
      ...userMessages,
    ],
    stream: true,
  }),
});
```

### النماذج المتاحة عبر Lovable AI

| النموذج | الاستخدام الأمثل | السعر |
|---------|-----------------|-------|
| `google/gemini-2.5-flash` | **افتراضي** - سريع ومتوازن | متوسط |
| `google/gemini-2.5-pro` | مهام معقدة، تحليل صور | أعلى |
| `google/gemini-2.5-flash-lite` | مهام بسيطة، تصنيف | أقل |
| `openai/gpt-5` | دقة عالية، استدلال معقد | أعلى |
| `openai/gpt-5-mini` | توازن بين السرعة والدقة | متوسط |

### مثال: استخدام OCR

```typescript
// في الـ Frontend
const { data, error } = await supabase.functions.invoke('ocr-document', {
  body: { 
    imageUrl: documentUrl,
    language: 'ar' // دعم اللغة العربية
  }
});

// النتيجة
{
  text: "محتوى المستند المستخرج...",
  confidence: 0.95,
  blocks: [...]
}
```

---

## 💳 تكاملات الدفع والبنوك

### البنوك المدعومة

| البنك | الكود | الوظائف المدعومة |
|-------|-------|------------------|
| **الراجحي** | `RJHI` | استعلام، تحويل، كشف |
| **الأهلي** | `NCBK` | استعلام، تحويل، كشف |
| **البلاد** | `ALBI` | استعلام، تحويل |
| **الإنماء** | `INMA` | استعلام، تحويل |
| **سامبا** | `SAMBA` | استعلام، تحويل |

### جدول bank_integrations

```sql
CREATE TABLE bank_integrations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  bank_code VARCHAR(10) NOT NULL,
  bank_name VARCHAR(100) NOT NULL,
  api_endpoint TEXT,
  auth_method VARCHAR(50),
  supports_transfers BOOLEAN DEFAULT true,
  supports_balance_inquiry BOOLEAN DEFAULT true,
  supports_statement BOOLEAN DEFAULT true,
  is_active BOOLEAN DEFAULT true,
  last_sync_at TIMESTAMPTZ,
  configuration JSONB
);
```

### بوابات الدفع

| البوابة | الأنواع المدعومة | الحالة |
|---------|------------------|--------|
| **مدى** | بطاقات مدى المحلية | ✅ |
| **VISA/Mastercard** | بطاقات ائتمان دولية | ✅ |
| **Apple Pay** | الدفع عبر Apple | ✅ |
| **STC Pay** | محفظة رقمية | 🔄 قيد التطوير |

### تصدير ملفات التحويل البنكي

```typescript
// إنشاء ملف تحويل بنكي ISO20022
const transferFile = await BankTransferService.generateTransferFile({
  bankAccountId: "...",
  distributionId: "...",
  format: "ISO20022" // أو "CSV", "MT940"
});

// النتيجة
{
  fileNumber: "TRF-2025-001234",
  totalAmount: 150000,
  totalTransactions: 45,
  filePath: "/transfers/TRF-2025-001234.xml"
}
```

---

## 🏛️ تكاملات حكومية

### الخدمات المتاحة

| الخدمة | الوصف | الجدول | الحالة |
|--------|-------|--------|--------|
| **أبشر** | التحقق من الهوية الوطنية | `government_integrations` | ✅ |
| **نفاذ** | الدخول الموحد الوطني | `government_integrations` | ✅ |
| **ZATCA** | الفوترة الإلكترونية | `zatca-submit/` | ✅ |
| **وزارة العدل** | التحقق من الصكوك | `government_integrations` | 🔄 |

### تكامل ZATCA (الفوترة الإلكترونية)

```typescript
// supabase/functions/zatca-submit/index.ts

// إنشاء فاتورة إلكترونية
const invoice = await ZATCAService.createInvoice({
  sellerName: "وقف الخير",
  sellerVATNumber: "300000000000003",
  invoiceDate: new Date(),
  invoiceTotal: 1000,
  vatAmount: 150,
  items: [...]
});

// إرسال للهيئة
const response = await ZATCAService.submitInvoice(invoice);
// { status: "CLEARED", clearanceId: "..." }
```

### التحقق من الهوية عبر أبشر

```typescript
// التحقق من هوية المستفيد
const verification = await AbsherService.verifyIdentity({
  nationalId: "1234567890",
  dateOfBirth: "1990-01-15"
});

// النتيجة
{
  isValid: true,
  fullName: "محمد أحمد العلي",
  status: "active"
}
```

---

## 📦 التكاملات المقترحة للإضافة

### 1. الصور والرؤية (Images & Vision)

| الاستخدام | الوصف | الأولوية |
|-----------|-------|----------|
| **تحليل صور الهويات** | التحقق التلقائي من المستندات | عالية |
| **تقييم العقارات** | تحليل صور العقارات للتقييم | متوسطة |
| **تحسين OCR** | معالجة المستندات القديمة | متوسطة |

### 2. معالجة الصوت (Audio Processing)

| الاستخدام | الوصف | الأولوية |
|-----------|-------|----------|
| **تحويل الاجتماعات لنص** | توثيق اجتماعات الناظر | منخفضة |
| **قراءة التقارير** | Text-to-Speech للتقارير | منخفضة |

### 3. الخرائط (Maps)

| الاستخدام | الوصف | الأولوية |
|-----------|-------|----------|
| **عرض مواقع العقارات** | خريطة تفاعلية للعقارات | عالية |
| **توزيع المستفيدين** | تحليل جغرافي للمستفيدين | متوسطة |

### 4. المستندات (Documents)

| الاستخدام | الوصف | الحالة |
|-----------|-------|--------|
| **تصدير PDF** | تقارير وكشوف حساب | ✅ موجود |
| **QR Codes** | رموز للسندات والمستفيدين | ✅ موجود |
| **مسح المستندات** | Document Scanner | 🔄 مقترح |

---

## 🔑 إعداد مفاتيح API

### المفاتيح المُدارة تلقائياً

| المفتاح | الوصف | الإعداد |
|---------|-------|---------|
| `LOVABLE_API_KEY` | Lovable AI Gateway | ✅ تلقائي |
| `SUPABASE_URL` | رابط Supabase | ✅ تلقائي |
| `SUPABASE_ANON_KEY` | مفتاح Supabase العام | ✅ تلقائي |
| `SUPABASE_SERVICE_ROLE_KEY` | مفتاح الخدمة | ✅ تلقائي |

### المفاتيح المطلوب إعدادها

| الخدمة | اسم المفتاح | كيفية الحصول |
|--------|-------------|---------------|
| **Mapbox** | `MAPBOX_TOKEN` | [mapbox.com/account/tokens](https://mapbox.com/account/tokens) |
| **Resend** | `RESEND_API_KEY` | [resend.com/api-keys](https://resend.com/api-keys) |
| **Twilio** | `TWILIO_AUTH_TOKEN` | [twilio.com/console](https://twilio.com/console) |

### إضافة مفتاح API

```
1. افتح إعدادات المشروع في Lovable
2. انتقل إلى "Secrets"
3. اضغط "Add Secret"
4. أدخل اسم المفتاح والقيمة
5. احفظ
```

---

## 📝 قوالب الطلبات (Prompts)

### للذكاء الاصطناعي

```markdown
# إنشاء مساعد ذكي
"أنشئ مساعد ذكي يساعد المستفيدين في:
- الاستفسار عن رصيدهم
- تتبع حالة طلباتهم
- الإجابة على الأسئلة الشائعة
استخدم Lovable AI مع النموذج google/gemini-2.5-flash"

# تحليل البيانات
"حلل بيانات التوزيعات المالية للسنة الماضية وقدم:
- ملخص الإنفاق
- اتجاهات التوزيع
- توصيات للتحسين"

# استخراج بيانات
"استخرج البيانات من الفاتورة المرفقة:
- اسم المورد
- المبلغ الإجمالي
- تاريخ الفاتورة
- بنود الفاتورة"
```

### للمستندات

```markdown
# تصدير PDF
"صدّر كشف حساب المستفيد كـ PDF يتضمن:
- بيانات المستفيد
- جدول المدفوعات
- الرصيد الحالي
- QR code للتحقق"

# إنشاء QR
"أنشئ QR code لكل سند صرف يحتوي على:
- رقم السند
- المبلغ
- تاريخ الصرف
- رابط التحقق"
```

### للخرائط

```markdown
# خريطة العقارات
"اعرض جميع عقارات الوقف على خريطة تفاعلية:
- تلوين حسب نوع العقار
- عرض معلومات عند النقر
- فلترة حسب الحالة (مؤجر/شاغر)"
```

---

## 🏗️ بنية التكاملات

### مخطط التدفق

```
┌─────────────────────────────────────────────────────────────────┐
│                         🌐 خدمات خارجية                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌───────────┐   ┌───────────┐   ┌───────────┐   ┌──────────┐ │
│   │ Lovable   │   │  Banks    │   │  ZATCA    │   │  Absher  │ │
│   │ AI        │   │  APIs     │   │  API      │   │  API     │ │
│   └─────┬─────┘   └─────┬─────┘   └─────┬─────┘   └────┬─────┘ │
│         │               │               │              │       │
└─────────┼───────────────┼───────────────┼──────────────┼───────┘
          │               │               │              │
          ▼               ▼               ▼              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      ⚡ Edge Functions Layer                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  chatbot    ocr-document    zatca-submit    verify-identity     │
│  ai-insights    property-ai    bank-transfer    ...             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
          │               │               │              │
          ▼               ▼               ▼              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        💾 Supabase Layer                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌───────────┐   ┌───────────┐   ┌───────────┐   ┌──────────┐ │
│   │ Database  │   │ Storage   │   │ Auth      │   │ Realtime │ │
│   │ Tables    │   │ Buckets   │   │ Users     │   │ Channels │ │
│   └───────────┘   └───────────┘   └───────────┘   └──────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
          │               │               │              │
          ▼               ▼               ▼              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       🖥️ Frontend Layer                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌───────────┐   ┌───────────┐   ┌───────────┐   ┌──────────┐ │
│   │ Services  │   │ Hooks     │   │Components │   │ Pages    │ │
│   └───────────┘   └───────────┘   └───────────┘   └──────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### الجداول المرتبطة بالتكاملات

| الجدول | الوصف |
|--------|-------|
| `bank_integrations` | إعدادات البنوك |
| `bank_transfer_files` | ملفات التحويل |
| `bank_transfer_details` | تفاصيل التحويلات |
| `government_integrations` | التكاملات الحكومية |
| `payment_gateways` | بوابات الدفع |
| `auto_journal_templates` | قوالب القيود التلقائية |

---

## 📚 مراجع

### التوثيق الرسمي

- [Lovable AI Documentation](https://docs.lovable.dev/features/ai)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)
- [ZATCA Developer Portal](https://zatca.gov.sa/en/E-Invoicing/Pages/default.aspx)

### الملفات الداخلية

| الملف | الوصف |
|-------|-------|
| `supabase/functions/` | جميع Edge Functions |
| `src/services/` | طبقة الخدمات |
| `src/hooks/` | Hooks للتكاملات |

---

**آخر تحديث:** 2025-11-29 (v1.0.0)  
© 2025 منصة إدارة الوقف الإلكترونية
