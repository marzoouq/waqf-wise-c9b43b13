# ๐ธ ููุฒุฉ OCR ููููุงุชูุฑ - ุงูุชูุซูู ุงูุดุงูู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ุงูููุงุชูุฑ ุชููุงุฆูุงู ูู ุงูุตูุฑ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู (Lovable AI - Google Gemini 2.5 Flash).

---

## โจ ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

### 1. **ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ุงูุชููุงุฆู**
- ุฑูุน ุตูุฑุฉ ูุงุญุฏุฉ ุฃู ุนุฏุฉ ุตูุฑ (JPG, PNG, PDF)
- ุงุณุชุฎุฑุงุฌ ุดุงูู ูุฌููุน ุจูุงูุงุช ุงููุงุชูุฑุฉ:
  - ุฑูู ุงููุงุชูุฑุฉ ูุชุงุฑูุฎูุง
  - ุจูุงูุงุช ุงูุจุงุฆุน (ุงูุงุณูุ ุงูุฑูู ุงูุถุฑูุจูุ ุงูุนููุงู)
  - ุจูุงูุงุช ุงูุนููู (ุงูุงุณูุ ุงูุฑูู ุงูุถุฑูุจูุ ุงูุนููุงู)
  - ุจููุฏ ุงููุงุชูุฑุฉ (ุงููุตูุ ุงููููุฉุ ุงูุณุนุฑุ ุงูุถุฑูุจุฉ)
  - ุงููุจุงูุบ ุงููุงููุฉ (ุงูุฅุฌูุงููุ ุงูุถุฑูุจุฉุ ุงููุฌููุน ุงูููุงุฆู)

### 2. **ูุคุดุฑุงุช ุฌูุฏุฉ ุงูุงุณุชุฎุฑุงุฌ**
- ูุณุจุฉ ุซูุฉ ููู ุญูู ูุณุชุฎุฑุฌ (0-100%)
- ุชูููู ุชููุงุฆู ุญุณุจ ูุณุชูู ุงูุซูุฉ:
  - ๐ข **ุฃุฎุถุฑ**: > 90% (ุซูุฉ ุนุงููุฉ)
  - ๐ก **ุฃุตูุฑ**: 70-90% (ุซูุฉ ูุชูุณุทุฉ - ูููุตุญ ุจุงููุฑุงุฌุนุฉ)
  - ๐ด **ุฃุญูุฑ**: < 70% (ุซูุฉ ููุฎูุถุฉ - ูุฌุจ ุงููุฑุงุฌุนุฉ)

### 3. **ุชูุงูู ูุน ZATCA**
- ุงูุชุญูู ุงูุชููุงุฆู ูู ุตุญุฉ ุงูุฃุฑูุงู ุงูุถุฑูุจูุฉ
- ุชูููุฏ QR Code ูุชูุงูู ูุน ZATCA
- ุงูุชุญูู ูู ุงูุชูุงู ุงูุจูุงูุงุช ุงูุฅูุฒุงููุฉ

### 4. **ุญูุธ ุงูุตูุฑ ุงูุฃุตููุฉ**
- ุฑูุน ุงูุตูุฑุฉ ุฅูู Supabase Storage
- ุฑุจุท ุงูุตูุฑุฉ ุจุณุฌู ุงููุงุชูุฑุฉ
- ุนุฑุถ ุงูุตูุฑุฉ ุงูุฃุตููุฉ ูู ูุงุฌูุฉ ุงููุงุชูุฑุฉ

### 5. **ูุนุงูุฌุฉ ุงูุฏููุนุงุช**
- ุฑูุน ุนุฏุฉ ููุงุชูุฑ ุฏูุนุฉ ูุงุญุฏุฉ
- ูุนุงูุฌุฉ ูุชูุงุฒูุฉ ูุชุณุฑูุน ุงูุฃุฏุงุก
- ุนุฑุถ ุชูุฏู ุงููุนุงูุฌุฉ ููู ูุงุชูุฑุฉ

---

## ๐๏ธ ุงูุจููุฉ ุงูุชูููุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### ุฌุฏูู `invoices` - ุญููู ุฅุถุงููุฉ:
```sql
source_image_url TEXT          -- ุฑุงุจุท ุงูุตูุฑุฉ ุงูุฃุตููุฉ
ocr_extracted BOOLEAN          -- ูู ุชู ุงูุงุณุชุฎุฑุงุฌ ุจู OCR
ocr_confidence_score NUMERIC   -- ูุณุจุฉ ุงูุซูุฉ ุงูุฅุฌูุงููุฉ
ocr_processed_at TIMESTAMPTZ   -- ููุช ุงููุนุงูุฌุฉ
```

#### ุฌุฏูู `ocr_corrections`:
```sql
CREATE TABLE ocr_corrections (
  id UUID PRIMARY KEY,
  invoice_id UUID REFERENCES invoices(id),
  field_name TEXT,
  ocr_value TEXT,
  corrected_value TEXT,
  corrected_by UUID,
  corrected_at TIMESTAMPTZ
);
```

### Edge Function

**ุงููุณุงุฑ**: `supabase/functions/extract-invoice-data/index.ts`

**ุงููุฏุฎูุงุช**:
```typescript
{
  image_base64: string,  // ุตูุฑุฉ ุจุตูุบุฉ Base64
  image_url?: string     // ุฃู ุฑุงุจุท ุงูุตูุฑุฉ
}
```

**ุงููุฎุฑุฌุงุช**:
```typescript
{
  success: boolean,
  data: {
    invoice_number: string,
    invoice_date: string,
    vendor_name: string,
    vendor_vat_number: string,
    customer_name: string,
    customer_vat_number: string,
    items: [
      {
        description: string,
        quantity: number,
        unit_price: number,
        tax_rate: number,
        total: number
      }
    ],
    subtotal: number,
    tax_amount: number,
    total_amount: number,
    confidence_scores: {
      [key: string]: number
    },
    overall_confidence: number
  }
}
```

**ุงูุฃูุงู**:
- ุงูุชุญูู ูู JWT token
- ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู (admin, nazer, accountant)
- ูุนุงูุฌุฉ ุขููุฉ ููุฃุฎุทุงุก

---

## ๐ฆ ุงูููููุงุช

### 1. `InvoiceOCRUpload.tsx`
ุฑูุน ููุนุงูุฌุฉ ูุงุชูุฑุฉ ูุงุญุฏุฉ.

**ุงูุฎุตุงุฆุต**:
```typescript
interface InvoiceOCRUploadProps {
  onDataExtracted: (data: ExtractedInvoiceData, imageUrl: string) => void;
  onCancel: () => void;
}
```

**ุงูููุฒุงุช**:
- Drag & Drop ูุฑูุน ุงูุตูุฑ
- ูุนุงููุฉ ุงูุตูุฑุฉ ูุจู ุงููุนุงูุฌุฉ
- ุนุฑุถ ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ ูุน ูุคุดุฑุงุช ุงูุซูุฉ
- ุฅููุงููุฉ ุงูุชุนุฏูู ูุจู ุงูุงุณุชุฎุฏุงู

### 2. `BatchInvoiceOCR.tsx`
ูุนุงูุฌุฉ ุนุฏุฉ ููุงุชูุฑ ุฏูุนุฉ ูุงุญุฏุฉ.

**ุงูุฎุตุงุฆุต**:
```typescript
interface BatchInvoiceOCRProps {
  onComplete: (results: ExtractedInvoiceData[]) => void;
  onCancel: () => void;
}
```

**ุงูููุฒุงุช**:
- ุฑูุน ุญุชู 10 ุตูุฑ ูู ููุณ ุงูููุช
- ูุนุงูุฌุฉ ูุชูุงุฒูุฉ
- ุนุฑุถ ุชูุฏู ูู ูุงุชูุฑุฉ
- ุญูุธ ุชููุงุฆู ููููุงุชูุฑ ุงููุงุฌุญุฉ

### 3. `OCRConfidenceIndicator.tsx`
ุนุฑุถ ูุคุดุฑ ุงูุซูุฉ ููู ุญูู.

**ุงูุฎุตุงุฆุต**:
```typescript
interface OCRConfidenceIndicatorProps {
  confidence: number;
  fieldName: string;
  className?: string;
}
```

### 4. `useInvoiceOCR.ts`
Hook ูุฎุตุต ูุฅุฏุงุฑุฉ ุญุงูุฉ OCR.

**ุงููุธุงุฆู**:
```typescript
const {
  extractInvoiceData,  // ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช
  isProcessing,        // ุญุงูุฉ ุงููุนุงูุฌุฉ
  extractedData,       // ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ
  error,               // ุฑุณุงุฆู ุงูุฎุทุฃ
  imageUrl,            // ุฑุงุจุท ุงูุตูุฑุฉ ุงููุฑููุนุฉ
  reset                // ุฅุนุงุฏุฉ ุงูุถุจุท
} = useInvoiceOCR();
```

---

## ๐ ุชุฏูู ุงูุนูู

```
1. ุงููุณุชุฎุฏู ูุฑูุน ุตูุฑุฉ ูุงุชูุฑุฉ
   โ
2. ุฑูุน ุงูุตูุฑุฉ ุฅูู Storage (bucket: documents)
   โ
3. ุชุญููู ุงูุตูุฑุฉ ุฅูู Base64
   โ
4. ุงุณุชุฏุนุงุก Edge Function (extract-invoice-data)
   โ
5. Lovable AI ูุญูู ุงูุตูุฑุฉ (Gemini 2.5 Flash)
   โ
6. ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช + ุญุณุงุจ ูุณุจ ุงูุซูุฉ
   โ
7. ุนุฑุถ ุงูุจูุงูุงุช ูุน ูุคุดุฑุงุช ุงูุซูุฉ
   โ
8. ุงููุณุชุฎุฏู ูุฑุงุฌุน ููุตุญุญ (ุฅู ูุฒู)
   โ
9. ุงูุชุญูู ูู ZATCA (ุงูุฑูู ุงูุถุฑูุจู)
   โ
10. ุญูุธ ุงููุงุชูุฑุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    - ุฑุจุท ุงูุตูุฑุฉ ุงูุฃุตููุฉ
    - ุญูุธ ูุณุจุฉ ุงูุซูุฉ
    - ุชูููุฏ QR Code
```

---

## ๐งช ุงูุงุฎุชุจุงุฑุงุช

### Integration Tests
**ุงููุณุงุฑ**: `src/__tests__/integration/finance/invoice-ocr.test.ts`

**ุงูุณููุงุฑูููุงุช**:
- โ ุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ูู ุตูุฑุฉ ุตุงูุญุฉ
- โ ุงูุชุนุงูู ูุน ุตูุฑุฉ ุบูุฑ ุตุงูุญุฉ
- โ ููุก ุงููููุฐุฌ ุชููุงุฆูุงู
- โ ุงูุชุนุงูู ูุน ูุดู ุงูู API
- โ ุงูุชุญูู ูู ุงูุตูุงุญูุงุช

### E2E Tests
**ุงููุณุงุฑ**: `src/__tests__/e2e/finance/invoice-ocr.spec.ts`

**ุงูุณููุงุฑูููุงุช**:
- ุฑุญูุฉ ูุงููุฉ: ุฑูุน โ ุงุณุชุฎุฑุงุฌ โ ูุฑุงุฌุนุฉ โ ุญูุธ
- ุงูุชุญูู ูู ุนุฑุถ ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ
- ุงูุชุญูู ูู ุงูุชุนุฏูู ูุจู ุงูุญูุธ
- ุงูุชุญูู ูู validation ุงูุฑูู ุงูุถุฑูุจู

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ูุงูุชูุงุฑูุฑ

### ุงูุจูุงูุงุช ุงููุชุชุจุนุฉ:
- ุนุฏุฏ ุงูููุงุชูุฑ ุงููุณุชุฎุฑุฌุฉ ุจู OCR
- ูุชูุณุท ูุณุจุฉ ุงูุฏูุฉ
- ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ
- ุชูููุฑ ุงูููุช ููุงุฑูุฉ ุจุงูุฅุฏุฎุงู ุงููุฏูู

### ุงูุงุณุชุนูุงูุงุช ุงููููุฏุฉ:

```sql
-- ุนุฏุฏ ุงูููุงุชูุฑ ุงููุณุชุฎุฑุฌุฉ ุจู OCR
SELECT COUNT(*) FROM invoices WHERE ocr_extracted = true;

-- ูุชูุณุท ูุณุจุฉ ุงูุซูุฉ
SELECT AVG(ocr_confidence_score) FROM invoices WHERE ocr_extracted = true;

-- ุงูููุงุชูุฑ ุจุซูุฉ ููุฎูุถุฉ (< 80%)
SELECT * FROM invoices 
WHERE ocr_extracted = true 
AND ocr_confidence_score < 80
ORDER BY ocr_processed_at DESC;

-- ุฃูุซุฑ ุงูุญููู ุชุตุญูุญุงู
SELECT field_name, COUNT(*) as correction_count
FROM ocr_corrections
GROUP BY field_name
ORDER BY correction_count DESC;
```

---

## ๐ ุงูุฃูุงู

### ุงูุชุญูู ูู ุงูุตูุงุญูุงุช:
- ูุฌุจ ุฃู ูููู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
- ุงูุฃุฏูุงุฑ ุงููุณููุญุฉ: admin, nazer, accountant

### ุญูุงูุฉ ุงูุจูุงูุงุช:
- ุงูุตูุฑ ุงููุฑููุนุฉ ูุญููุฉ ูู Storage
- RLS policies ุนูู ุฌููุน ุงูุฌุฏุงูู
- ุชุดููุฑ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ

### Rate Limiting:
- ุญุฏ ุฃูุตู 10 ุตูุฑ ูู ุงูุฏูุนุฉ ุงููุงุญุฏุฉ
- ุญุฌู ุงูุตูุฑุฉ ุงููุงุญุฏุฉ: 10MB
- ุฃููุงุน ุงููููุงุช ุงููุณููุญุฉ: JPG, PNG, PDF

---

## ๐ฏ ุฃูุถู ุงูููุงุฑุณุงุช

### ูููุณุชุฎุฏููู:
1. **ุฌูุฏุฉ ุงูุตูุฑุฉ**: ุงุณุชุฎุฏู ุตูุฑ ุนุงููุฉ ุงููุถูุญ
2. **ุงูุฅุถุงุกุฉ**: ุชุฃูุฏ ูู ูุถูุญ ุงููุต
3. **ุงูุฒุงููุฉ**: ุงูุชูุท ุงูุตูุฑุฉ ุจุฒุงููุฉ ูุณุชูููุฉ
4. **ุงููุฑุงุฌุนุฉ**: ุฑุงุฌุน ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ ุฏุงุฆูุงู
5. **ุงูุชุตุญูุญ**: ุตุญุญ ุงูุญููู ุฐุงุช ุงูุซูุฉ ุงูููุฎูุถุฉ

### ูููุทูุฑูู:
1. **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก**: ุงุณุชุฎุฏู try-catch ูู ุฌููุน ุงูุนูููุงุช
2. **ุงูุชุญูู ูู ุงูุจูุงูุงุช**: ุงุณุชุฎุฏู `validateOCRExtractedData`
3. **ุงูุฃุฏุงุก**: ุงุณุชุฎุฏู ูุนุงูุฌุฉ ูุชูุงุฒูุฉ ููุฏูุนุงุช
4. **ุงูุชุณุฌูู**: ุณุฌู ุฌููุน ุงูุนูููุงุช ููุชุญููู
5. **ุงูุงุฎุชุจุงุฑ**: ุงุฎุชุจุฑ ูุน ุฃููุงุน ูุฎุชููุฉ ูู ุงูููุงุชูุฑ

---

## ๐ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ

### ูุตูุฑุฉ ุงููุฏู:
- [ ] ุฏุนู PDF ูุชุนุฏุฏ ุงูุตูุญุงุช
- [ ] ุชุญุณูู ุฏูุฉ ุงุณุชุฎุฑุงุฌ ุงูุฌุฏุงูู ุงููุนูุฏุฉ
- [ ] ุฏุนู ุฃููุงุน ุฅุถุงููุฉ ูู ุงููุณุชูุฏุงุช

### ูุชูุณุทุฉ ุงููุฏู:
- [ ] ุงูุชุนูู ูู ุงูุชุตุญูุญุงุช (Machine Learning)
- [ ] ุงุณุชูุฑุงุฏ ูู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- [ ] OCR ููุนููุฏ ูุงูุงุชูุงููุงุช

### ุทูููุฉ ุงููุฏู:
- [ ] ุชุฏุฑูุจ ูููุฐุฌ ูุฎุตุต ููููุงุชูุฑ ุงูุนุฑุจูุฉ
- [ ] ูุนุงูุฌุฉ ุงูููุงุชูุฑ ุงูููุชูุจุฉ ุจุฎุท ุงููุฏ
- [ ] ุชูุงูู ูุน ุฃูุธูุฉ ERP ุฎุงุฑุฌูุฉ

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ูุดููุฉ: ูุณุจุฉ ุงูุซูุฉ ููุฎูุถุฉ
**ุงูุญู**:
- ุชุญุณูู ุฌูุฏุฉ ุงูุตูุฑุฉ
- ุฅุนุงุฏุฉ ุงูุชูุงุท ุงูุตูุฑุฉ ุจุฅุถุงุกุฉ ุฃูุถู
- ุงุณุชุฎุฏุงู ูุงุณุญ ุถูุฆู ุจุฏูุงู ูู ุงููุงููุฑุง

### ูุดููุฉ: ูุดู ุงูุงุณุชุฎุฑุงุฌ
**ุงูุญู**:
- ุงูุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช
- ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู
- ูุฑุงุฌุนุฉ console logs ููุชูุงุตูู

### ูุดููุฉ: ุจูุงูุงุช ุบูุฑ ุฏูููุฉ
**ุงูุญู**:
- ูุฑุงุฌุนุฉ ูุชุตุญูุญ ุงูุจูุงูุงุช ูุฏููุงู
- ุชูุฏูู feedback ูุชุญุณูู ุงููููุฐุฌ
- ุงุณุชุฎุฏุงู ุฃููุงุน ูููุงุช ุฃูุถู (PDF ุจุฏูุงู ูู ุตูุฑ)

---

## ๐ ุงูุฏุนู

ูููุณุงุนุฏุฉ ุฃู ุงูุฅุจูุงุบ ุนู ูุดุงูู:
- ุฑุงุฌุน ุณุฌู ุงูุฃุฎุทุงุก ูู console
- ุชุญูู ูู ุดุฑูุท ุงูุงุณุชุฎุฏุงู
- ุชูุงุตู ูุน ูุฑูู ุงูุชุทููุฑ

---

## ๐ ุงูููุงุญุธุงุช

- ุงูููุฒุฉ ุชุณุชุฎุฏู Lovable AI ุงูุฐู ูุชุทูุจ ุงุชุตุงู ุจุงูุฅูุชุฑูุช
- ุฏูุฉ ุงูุงุณุชุฎุฑุงุฌ ุชุนุชูุฏ ุนูู ุฌูุฏุฉ ุงูุตูุฑุฉ
- ูููุตุญ ุฏุงุฆูุงู ุจูุฑุงุฌุนุฉ ุงูุจูุงูุงุช ุงููุณุชุฎุฑุฌุฉ
- ุงููุธุงู ูุฏุนู ุงููุบุฉ ุงูุนุฑุจูุฉ ูุงูุฅูุฌููุฒูุฉ

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ**: 2024-01-15  
**ุงูุฅุตุฏุงุฑ**: 1.0.0  
**ุงูุญุงูุฉ**: โ ุฌุงูุฒ ููุฅูุชุงุฌ
