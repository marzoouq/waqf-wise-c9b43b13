# توثيق إصلاحات لوحة تحكم الناظر

## تاريخ التوثيق: 2024-11-29

---

## ملخص الإصلاحات

### 1. إصلاح usePendingApprovals.ts
**المشكلة:** الـ hook كان يبحث عن `status = 'معلق'` في جدول `approvals` بينما القيم الفعلية هي `pending`

**الإصلاح:**
```typescript
// قبل
.eq('status', 'معلق')

// بعد
.eq('status', 'pending')
```

**الملف:** `src/hooks/usePendingApprovals.ts` (السطر 103)

---

### 2. إصلاح useSmartAlerts.ts
**المشكلة 1:** استعلام القروض يبحث عن `status = 'pending'` بينما القيم الفعلية هي `overdue` و `paid`

**الإصلاح:**
```typescript
// قبل
.eq('status', 'pending')

// بعد
.in('status', ['overdue', 'pending', 'معلق'])
```

**المشكلة 2:** عرض الوصف لم يتضمن المبلغ بشكل صحيح

**الإصلاح:**
```typescript
// إضافة منطق للتحقق من حالة التأخر وعرض المبلغ
const isOverdue = installment.status === 'overdue' || daysUntilDue < 0;
const amount = installment.total_amount || installment.principal_amount || 0;
```

**الملف:** `src/hooks/useSmartAlerts.ts` (السطور 79-110)

---

### 3. تحديث بيانات العقارات
**المشكلة:** العقارات كانت بحالة `active` بينما النظام يبحث عن `نشط`

**الإصلاح:**
```sql
UPDATE properties SET status = 'نشط' WHERE status = 'active';
```

---

## البيانات المضافة للاختبار

### 1. قيود الإيرادات (6 أشهر)
| الشهر | رقم القيد | المبلغ |
|-------|-----------|--------|
| يونيو 2024 | JE-REV-2024-06 | 45,000 ر.س |
| يوليو 2024 | JE-REV-2024-07 | 52,000 ر.س |
| أغسطس 2024 | JE-REV-2024-08 | 48,000 ر.س |
| سبتمبر 2024 | JE-REV-2024-09 | 55,000 ر.س |
| أكتوبر 2024 | JE-REV-2024-10 | 58,000 ر.س |
| نوفمبر 2024 | JE-REV-2024-11 | 62,000 ر.س |
| **الإجمالي** | | **320,000 ر.س** |

### 2. قيود المصروفات (6 أشهر)
| الشهر | رقم القيد | المبلغ |
|-------|-----------|--------|
| يونيو 2024 | JE-EXP-2024-06 | 15,000 ر.س |
| يوليو 2024 | JE-EXP-2024-07 | 18,000 ر.س |
| أغسطس 2024 | JE-EXP-2024-08 | 12,000 ر.س |
| سبتمبر 2024 | JE-EXP-2024-09 | 20,000 ر.س |
| أكتوبر 2024 | JE-EXP-2024-10 | 16,000 ر.س |
| نوفمبر 2024 | JE-EXP-2024-11 | 22,000 ر.س |
| **الإجمالي** | | **103,000 ر.س** |

### 3. موافقات معلقة للناظر (المستوى 3)
| النوع | المرجع | المبلغ | الحالة |
|-------|--------|--------|--------|
| توزيع | Q4 2024 | 155,000 ر.س | معلق |
| طلب | REQ-25-000007 | 5,000 ر.س | معلق |
| قيد محاسبي | JE-2024-003 | - | pending |

### 4. تنبيهات ذكية
| النوع | العدد | التفاصيل |
|-------|-------|----------|
| إيجارات متأخرة | 2 | RP-2024-014, RP-2024-015 |
| أقساط قروض متأخرة | 3 | LN-2024-0001, LN-2024-0002, LN-2024-0004 |
| طلبات متأخرة | 1 | REQ-25-000002 |
| عقود منتهية قريباً | 0 | - |

---

## مؤشرات الأداء الرئيسية (KPIs) النهائية

| المؤشر | القيمة |
|--------|--------|
| المستفيدون النشطون | 14 |
| العقارات النشطة | 5 |
| العقود النشطة | 3 |
| القروض النشطة | 4 |
| الميزانية المتاحة | 1,550,000 ر.س |
| إجمالي الإيرادات | 320,000 ر.س |
| إجمالي المصروفات | 170,500 ر.س |
| صافي الربح | 149,500 ر.س |
| موافقات معلقة للناظر | 3 |

---

## الملفات المعدلة

1. `src/hooks/usePendingApprovals.ts` - إصلاح استعلام الموافقات
2. `src/hooks/useSmartAlerts.ts` - إصلاح استعلام التنبيهات الذكية

---

## بيانات الدخول للاختبار

| الدور | البريد الإلكتروني | كلمة المرور |
|-------|------------------|-------------|
| الناظر | nazer@waqf.sa | Test@123456 |
| المدير | admin@waqf.sa | Test@123456 |

---

## اختبارات التكامل

### ✅ KPIs
- [x] المستفيدون النشطون يظهرون بشكل صحيح
- [x] العقارات والعقود تظهر بشكل صحيح
- [x] الميزانية المتاحة تحسب من الحسابات البنكية
- [x] القروض النشطة تظهر بشكل صحيح

### ✅ الرسوم البيانية
- [x] بيانات الإيرادات الشهرية متوفرة
- [x] بيانات المصروفات الشهرية متوفرة
- [x] 6 أشهر من البيانات للعرض

### ✅ الموافقات المعلقة
- [x] موافقة توزيع على المستوى 3
- [x] موافقة طلب على المستوى 3
- [x] موافقة قيد محاسبي (pending)

### ✅ التنبيهات الذكية
- [x] إيجارات متأخرة تظهر
- [x] أقساط قروض متأخرة تظهر
- [x] طلبات متأخرة تظهر

---

## ملاحظات فنية

### الفروق في قيم Status
| الجدول | القيمة العربية | القيمة الإنجليزية |
|--------|---------------|------------------|
| distribution_approvals | معلق | - |
| request_approvals | معلق | - |
| approvals (journal) | - | pending |
| loan_installments | - | overdue, paid |
| rental_payments | متأخر | - |
| properties | نشط | - |
| contracts | نشط | - |
| beneficiaries | نشط | - |

### توصيات للتطوير المستقبلي
1. توحيد قيم الحالات بين الجداول (كلها عربية أو كلها إنجليزية)
2. إضافة constants مركزية للحالات
3. إضافة تحقق من صحة البيانات عند الإدخال
