# ุฏููู ุงูุฃูุงู - ููุตุฉ ุฅุฏุงุฑุฉ ุงูููู ุงูุฅููุชุฑูููุฉ

> **ุงูุฅุตุฏุงุฑ:** 2.6.27  
> **ุขุฎุฑ ุชุญุฏูุซ:** 2025-12-05

## ูุธุฑุฉ ุนุงูุฉ

ูุชุจุน ูุฐุง ุงูุชุทุจูู ุฃูุถู ููุงุฑุณุงุช ุงูุฃูุงู ูุญูุงูุฉ ุจูุงูุงุช ุงูููู ูุงููุณุชููุฏููุ ุจูุง ูู ุฐูู:

- **Row Level Security (RLS)** ุนูู ุฌููุน ุงูุฌุฏุงูู ุงูุญุณุงุณุฉ
- **Role-Based Access Control (RBAC)** ููุชุญูู ูู ุงููุตูู
- **ุชุดููุฑ ุงูุจูุงูุงุช** ุฃุซูุงุก ุงูููู ูุงูุชุฎุฒูู
- **ุณุฌู ุชุฏููู ุดุงูู** ูุฌููุน ุงูุนูููุงุช ุงูุญุณุงุณุฉ

---

## ุงูุฃุฏูุงุฑ ูุงูุตูุงุญูุงุช

### ุฃุฏูุงุฑ ุงููุธุงู

| ุงูุฏูุฑ | ุงููุตู | ุงูุตูุงุญูุงุช ุงูุฑุฆูุณูุฉ |
|-------|-------|-------------------|
| `admin` | ูุฏูุฑ ุงููุธุงู | ุฌููุน ุงูุตูุงุญูุงุช |
| `nazer` | ูุงุธุฑ ุงูููู | ุฅุฏุงุฑุฉ ุงูุชูุฒูุนุงุชุ ุฅููุงู ุงูุณููุงุชุ ุงูููุงููุงุช |
| `accountant` | ุงููุญุงุณุจ | ุงููููุฏ ุงููุญุงุณุจูุฉุ ุงูุชูุงุฑูุฑ ุงููุงููุฉ |
| `cashier` | ุฃููู ุงูุตูุฏูู | ุชุณุฌูู ุงููุฏููุนุงุช ูุงูุฅูุตุงูุงุช |
| `archivist` | ุงูุฃุฑุดููู | ุฅุฏุงุฑุฉ ุงููุซุงุฆู ูุงููุฑููุงุช |
| `waqf_heir` | ูุฑูุซ ุงูููู | ุงูุงุทูุงุน ุงููุงูู ุนูู ุจูุงูุงุช ุงูููู |
| `beneficiary` | ุงููุณุชููุฏ | ุงููุตูู ูุจูุงูุงุชู ููุท |

### ูุตูููุฉ ุงูุตูุงุญูุงุช ููู Edge Functions

| ุงูุฏุงูุฉ | ุงูุฃุฏูุงุฑ ุงููุณููุญุฉ |
|--------|-----------------|
| `backup-database` | admin, nazer |
| `restore-database` | admin |
| `auto-close-fiscal-year` | nazer |
| `simulate-distribution` | admin, nazer, accountant |
| `generate-ai-insights` | admin, nazer, accountant |
| `create-beneficiary-accounts` | admin, nazer |
| `reset-user-password` | admin, nazer |
| `update-user-email` | admin, nazer |

---

## ุชุฃููู Edge Functions

### ููุท ุงููุตุงุฏูุฉ ูุงูุชูููุถ

ุฌููุน Edge Functions ุงูุญุณุงุณุฉ ุชุชุจุน ูุฐุง ุงูููุท:

```typescript
// 1. ุงูุชุญูู ูู ูุฌูุฏ Authorization header
const authHeader = req.headers.get('Authorization');
if (!authHeader) {
  return forbiddenResponse('ูุทููุจ ุชุณุฌูู ุงูุฏุฎูู');
}

// 2. ุงูุชุญูู ูู ุตุญุฉ JWT token
const token = authHeader.replace('Bearer ', '');
const { data: { user }, error } = await supabaseAuth.auth.getUser(token);
if (error || !user) {
  return forbiddenResponse('ุฌูุณุฉ ุบูุฑ ุตุงูุญุฉ');
}

// 3. ุงูุชุญูู ูู ุงูุฃุฏูุงุฑ ุงููุทููุจุฉ
const { data: userRoles } = await supabase
  .from('user_roles')
  .select('role')
  .eq('user_id', user.id);

const hasPermission = userRoles?.some(r => ALLOWED_ROLES.includes(r.role));
if (!hasPermission) {
  // ุชุณุฌูู ุงููุญุงููุฉ ูู audit_logs
  await supabase.from('audit_logs').insert({
    user_id: user.id,
    action_type: 'UNAUTHORIZED_ACCESS_ATTEMPT',
    severity: 'error'
  });
  return forbiddenResponse('ููุณ ูุฏูู ุงูุตูุงุญูุฉ ุงููุทููุจุฉ');
}
```

### ุงูุฏูุงู ุงููุญููุฉ

| ุงูุฏุงูุฉ | verify_jwt | ุงูุชุญูู ูู ุงูุฃุฏูุงุฑ | ุณุฌู ุงูุชุฏููู |
|--------|-----------|------------------|-------------|
| backup-database | โ | โ admin/nazer | โ |
| restore-database | โ | โ admin | โ |
| auto-close-fiscal-year | โ | โ nazer | โ |
| simulate-distribution | โ | โ admin/nazer/accountant | โ |
| generate-ai-insights | โ | โ admin/nazer/accountant | โ |

---

## ุณูุงุณุงุช Row Level Security (RLS)

### ุงูุฌุฏุงูู ุงูุญุณุงุณุฉ ุงููุญููุฉ

#### 1. `beneficiaries` (ุงููุณุชููุฏูู)
- ุงููุณุชููุฏ ูุฑู ุจูุงูุงุชู ููุท
- ุงูููุธููู ูุฑูู ุฌููุน ุงููุณุชููุฏูู
- ุงููุฑุซุฉ ููู ุดูุงููุฉ ูุงููุฉ

#### 2. `bank_accounts` (ุงูุญุณุงุจุงุช ุงูุจูููุฉ)
- ุงููุณุชููุฏ ูุฑู ุญุณุงุจู ููุท
- ุงููุญุงุณุจ ูุงููุงุธุฑ ูุฑูู ุฌููุน ุงูุญุณุงุจุงุช

#### 3. `loans` (ุงููุฑูุถ)
- ุงููุณุชููุฏ ูุฑู ูุฑูุถู ููุท
- ุงููุญุงุณุจ ูุงููุงุธุฑ ูุฏูุฑูู ุฌููุน ุงููุฑูุถ

#### 4. `distributions` (ุงูุชูุฒูุนุงุช)
- ุงููุณุชููุฏ ูุฑู ุชูุฒูุนุงุชู ููุท
- ุงููุฑุซุฉ ููู ุดูุงููุฉ ูุงููุฉ

#### 5. `contracts` (ุงูุนููุฏ)
- ุงูููุธููู ููุท ูุฑูู ุงูุนููุฏ
- ุงููุฑุซุฉ ููู ุดูุงููุฉ ูุงููุฉ

### ุณูุงุณุงุช ููุญุฏุฉ

ุจุนุฏ ุงูุชูุธููุ ุฃุตุจุญุช ุงูุณูุงุณุงุช ูุงูุชุงูู:

#### `profiles`
- `profiles_select_own`: ุงููุณุชุฎุฏู ูุฑู ูููู
- `profiles_select_staff`: ุงูููุธููู ูุฑูู ุฌููุน ุงููููุงุช
- `profiles_insert_own`: ุงููุณุชุฎุฏู ููุดุฆ ูููู
- `profiles_update_own`: ุงููุณุชุฎุฏู ูุญุฏุซ ูููู

#### `user_roles`
- `user_roles_select_own`: ุงููุณุชุฎุฏู ูุฑู ุฃุฏูุงุฑู
- `user_roles_select_admin`: ุงููุฏูุฑ/ุงููุงุธุฑ ูุฑูู ุฌููุน ุงูุฃุฏูุงุฑ
- `user_roles_admin_manage`: ุงููุฏูุฑ/ุงููุงุธุฑ ูุฏูุฑูู ุงูุฃุฏูุงุฑ

#### `contract_units`
- `staff_view_contract_units`: ุงูููุธููู ูุงููุฑุซุฉ ููุท

---

## ุณุฌู ุงูุชุฏููู (Audit Logs)

ูุชู ุชุณุฌูู ุฌููุน ุงูุนูููุงุช ุงูุญุณุงุณุฉ ูู ุฌุฏูู `audit_logs`:

```typescript
interface AuditLog {
  user_id: string;
  user_email: string;
  action_type: string;
  table_name: string;
  record_id?: string;
  old_values?: object;
  new_values?: object;
  description: string;
  severity: 'info' | 'warn' | 'error';
  ip_address?: string;
  user_agent?: string;
}
```

### ุฃููุงุน ุงูุฃุญุฏุงุซ ุงููุณุฌูุฉ

| ููุน ุงูุญุฏุซ | ุงููุตู |
|-----------|-------|
| `BACKUP_CREATED` | ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ |
| `DATABASE_RESTORED` | ุงุณุชุนุงุฏุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช |
| `FISCAL_YEAR_CLOSED` | ุฅููุงู ุณูุฉ ูุงููุฉ |
| `DISTRIBUTION_SIMULATION` | ูุญุงูุงุฉ ุชูุฒูุน |
| `AI_INSIGHTS_GENERATED` | ุฅูุดุงุก ุชุญููู ุฐูู |
| `UNAUTHORIZED_*_ATTEMPT` | ูุญุงููุฉ ูุตูู ุบูุฑ ูุตุฑุญ |
| `USER_CREATED` | ุฅูุดุงุก ูุณุชุฎุฏู |
| `PASSWORD_RESET` | ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ูุฑูุฑ |

---

## ุฃูุถู ุงูููุงุฑุณุงุช

### ูููุทูุฑูู

1. **ูุง ุชุณุชุฎุฏู `verify_jwt = false`** ุฅูุง ููุฏูุงู ุงูุนุงูุฉ ูุนูุงู
2. **ุชุญูู ุฏุงุฆูุงู ูู ุงูุฃุฏูุงุฑ** ูุจู ุชูููุฐ ุนูููุงุช ุญุณุงุณุฉ
3. **ุณุฌูู ุฌููุน ุงููุญุงููุงุช** ุณูุงุก ูุฌุญุช ุฃู ูุดูุช
4. **ุงุณุชุฎุฏู `service_role`** ููุนูููุงุช ุงูุฏุงุฎููุฉ ููุท

### ูููุณุชุฎุฏููู

1. ุงุณุชุฎุฏู ูููุงุช ูุฑูุฑ ูููุฉ
2. ูุนูู ุงููุตุงุฏูุฉ ุงูุซูุงุฆูุฉ ุฅู ุชููุฑุช
3. ูุง ุชุดุงุฑู ุจูุงูุงุช ุงูุฏุฎูู
4. ุฃุจูุบ ุนู ุฃู ูุดุงุท ูุดุจูู

---

## ุชุญุฏูุซุงุช ุงูุฃูุงู

### ุงูุฅุตุฏุงุฑ 2.6.27 (2025-12-05) - ุฅุตูุงุญ ุฃููู ุญุฑุฌ ๐ด

โ **ุชู ุฅุตูุงุญู:**
- **ุชุญููู 90+ ุณูุงุณุฉ RLS ูู `TO public` ุฅูู `TO authenticated`**
- ุฅุตูุงุญ 15 ุฎุทุฃ ุฃููู ุญุฑุฌ ูู Security Scan
- ุญูุงูุฉ 15 ุฌุฏูู ุญุณุงุณ ูู ุงููุตูู ุงูุนุงู:
  - `beneficiaries` - ุจูุงูุงุช ุงููุณุชููุฏูู ุงูุดุฎุตูุฉ
  - `profiles` - ูููุงุช ุงููุณุชุฎุฏููู
  - `bank_accounts` - ุงูุญุณุงุจุงุช ุงูุจูููุฉ
  - `payments` - ุณุฌูุงุช ุงููุฏููุนุงุช
  - `loans` - ุงููุฑูุถ
  - `contracts` - ุงูุนููุฏ
  - `distributions` - ุงูุชูุฒูุนุงุช
  - `emergency_aid_requests` - ุทูุจุงุช ุงูุฅุนุงูุฉ ุงูุทุงุฑุฆุฉ
  - `invoices` - ุงูููุงุชูุฑ
  - `rental_payments` - ูุฏููุนุงุช ุงูุฅูุฌุงุฑ
  - `support_tickets` - ุชุฐุงูุฑ ุงูุฏุนู
  - `internal_messages` - ุงูุฑุณุงุฆู ุงูุฏุงุฎููุฉ
  - `families` - ุจูุงูุงุช ุงูุนุงุฆูุงุช
  - `properties` - ุงูุนูุงุฑุงุช
  - `maintenance_requests` - ุทูุจุงุช ุงูุตูุงูุฉ
- ุญุฐู ุงูุณูุงุณุงุช ุงูุฎุทูุฑุฉ ูุซู `enable_insert_for_all`
- ุชุจุณูุท ุงูุณูุงุณุงุช ูู 5-9 ููู ุฌุฏูู ุฅูู 2-4 ุณูุงุณุงุช ูุงุถุญุฉ

### ุงูุฅุตุฏุงุฑ 2.6.15 (2025-12-05)

โ **ุชู ุฅุตูุงุญู:**
- ุชุฃููู `backup-database` (admin/nazer)
- ุชุฃููู `restore-database` (admin ููุท)
- ุชุฃููู `auto-close-fiscal-year` (nazer)
- ุชุฃููู `simulate-distribution` (admin/nazer/accountant)
- ุชุฃููู `generate-ai-insights` (admin/nazer/accountant)
- ุชูุนูู JWT ูู `contract-renewal-alerts`
- ุชุดุฏูุฏ RLS ุนูู `contract_units` ู `tasks`
- ุชูุธูู ุณูุงุณุงุช `profiles` (14 โ 4)
- ุชูุธูู ุณูุงุณุงุช `user_roles` (8 โ 3)

---

## ุงูุฅุจูุงุบ ุนู ุซุบุฑุงุช

ุฅุฐุง ุงูุชุดูุช ุซุบุฑุฉ ุฃูููุฉุ ูุฑุฌู:

1. **ูุง ุชูุดุฑ ุงูุซุบุฑุฉ ุนููุงู**
2. ุชูุงุตู ูุน ูุฑูู ุงูุชุทููุฑ ูุจุงุดุฑุฉ
3. ูุฏู ุชูุงุตูู ูุงููุฉ ุนู ุงูุซุบุฑุฉ
4. ุงูุชุธุฑ ุงูุชุฃููุฏ ูุจู ุงูุฅูุตุงุญ

---

*ุขุฎุฑ ูุฑุงุฌุนุฉ ุฃูููุฉ: 2025-12-05*
