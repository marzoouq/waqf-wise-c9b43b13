# ğŸ“‹ Ø®Ø·Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ù„Ù‰ SaaS Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†

## Ø§Ù„Ø¥ØµØ¯Ø§Ø±: 1.0.0
## Ø§Ù„ØªØ§Ø±ÙŠØ®: 2025-12-10
## Ø§Ù„Ø­Ø§Ù„Ø©: Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚

---

# Ø§Ù„ÙÙ‡Ø±Ø³

1. [Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©](#1-Ù†Ø¸Ø±Ø©-Ø¹Ø§Ù…Ø©)
2. [Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©](#2-Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª-Ø§Ù„ØªÙ‚Ù†ÙŠØ©)
3. [Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©](#3-Ø§Ù„Ø¨Ù†ÙŠØ©-Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©)
4. [Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª](#4-Ù‚Ø§Ø¹Ø¯Ø©-Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
5. [Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø¹Ø²Ù„](#5-Ø§Ù„Ø£Ù…Ø§Ù†-ÙˆØ§Ù„Ø¹Ø²Ù„)
6. [Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ÙÙ‡Ø±Ø³Ø©](#6-Ø§Ù„Ø£Ø¯Ø§Ø¡-ÙˆØ§Ù„ÙÙ‡Ø±Ø³Ø©)
7. [Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª](#7-Ø§Ù„ØªÙˆØ¬ÙŠÙ‡-ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª)
8. [Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„ÙÙˆØªØ±Ø©](#8-Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª-ÙˆØ§Ù„ÙÙˆØªØ±Ø©)
9. [Ù„ÙˆØ­Ø© Super Admin](#9-Ù„ÙˆØ­Ø©-super-admin)
10. [Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ù„ÙÙŠ](#10-Ø§Ù„Ù‡ÙŠÙƒÙ„-Ø§Ù„Ù…Ù„ÙÙŠ)
11. [Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ](#11-Ø§Ù„Ø¬Ø¯ÙˆÙ„-Ø§Ù„Ø²Ù…Ù†ÙŠ)
12. [Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©](#12-Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±-ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©)
13. [Ø§Ù„Ù†Ø´Ø± ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©](#13-Ø§Ù„Ù†Ø´Ø±-ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©)

---

# 1. Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

## 1.1 Ø§Ù„Ù‡Ø¯Ù
ØªØ­ÙˆÙŠÙ„ ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙ‚Ù Ø§Ù„Ø­Ø§Ù„ÙŠ (Single-Tenant) Ø¥Ù„Ù‰ Ù†Ø¸Ø§Ù… SaaS Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† (Multi-Tenant) ÙŠØ³Ù…Ø­ Ù„ÙƒÙ„ ÙˆÙ‚Ù Ø¨Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© Ù…Ø¹Ø²ÙˆÙ„Ø© Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.

## 1.2 Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø®ØªØ§Ø±
| Ø§Ù„Ø¨Ù†Ø¯ | Ø§Ù„Ù‚ÙŠÙ…Ø© | Ø§Ù„Ø³Ø¨Ø¨ |
|-------|--------|-------|
| **Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø²Ù„** | Single Database + Row-Level Security | ØªÙƒÙ„ÙØ© Ø£Ù‚Ù„ØŒ ØµÙŠØ§Ù†Ø© Ø£Ø³Ù‡Ù„ØŒ Ø£Ø¯Ø§Ø¡ Ø£ÙØ¶Ù„ |
| **Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡** | Path-Based (`/tenant-slug/...`) | Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ LovableØŒ Ù„Ø§ ÙŠØªØ·Ù„Ø¨ DNS |
| **Ø§Ù„ÙÙˆØªØ±Ø©** | Stripe Subscriptions | Ù…ÙˆØ«ÙˆÙ‚ØŒ Ø¢Ù…Ù†ØŒ Ù…ØªÙƒØ§Ù…Ù„ |

## 1.3 Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
- ÙƒÙ„ Ù…Ø´ØªØ±Ùƒ Ù„Ù‡ Ù…Ø³Ø§Ø± ÙØ±Ø¹ÙŠ Ø®Ø§Øµ: `waqfapp.com/ahmed`, `waqfapp.com/mohammed`
- Ø¹Ø²Ù„ ÙƒØ§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Super Admin Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
- Ù†Ø¸Ø§Ù… Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø´Ù‡Ø±ÙŠØ© Ù…Ø¹ Ø®Ø·Ø· Ù…ØªØ¹Ø¯Ø¯Ø©
- Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù„ÙƒÙ„ Ù…Ø´ØªØ±Ùƒ

---

# 2. Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©

## 2.1 Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
```
Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:
â”œâ”€â”€ Frontend: React 18 + TypeScript + Vite
â”œâ”€â”€ Styling: Tailwind CSS + Shadcn UI
â”œâ”€â”€ State: React Query + Context API
â”œâ”€â”€ Backend: Supabase (PostgreSQL + Auth + Storage + Edge Functions)
â”œâ”€â”€ Database: 191 Ø¬Ø¯ÙˆÙ„ + 724 Ø³ÙŠØ§Ø³Ø© RLS
â””â”€â”€ Services: 52 Ø®Ø¯Ù…Ø© + 170+ hook
```

## 2.2 Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

### 2.2.1 Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
| Ø§Ù„Ù…ØªØ·Ù„Ø¨ | Ø§Ù„ØªÙØ§ØµÙŠÙ„ |
|---------|----------|
| Ø¬Ø¯Ø§ÙˆÙ„ Ø¬Ø¯ÙŠØ¯Ø© | 5 Ø¬Ø¯Ø§ÙˆÙ„ (tenants, subscription_plans, tenant_users, tenant_settings, tenant_billing) |
| Ø£Ø¹Ù…Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© | Ø¥Ø¶Ø§ÙØ© `tenant_id` Ù„Ù€ 50+ Ø¬Ø¯ÙˆÙ„ |
| Ø³ÙŠØ§Ø³Ø§Øª RLS | ØªØ­Ø¯ÙŠØ« 724 Ø³ÙŠØ§Ø³Ø© + Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø³Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© |
| ÙÙ‡Ø§Ø±Ø³ | Ø¥Ø¶Ø§ÙØ© 60+ ÙÙ‡Ø±Ø³ Ù…Ø±ÙƒØ¨ |
| Ø¯ÙˆØ§Ù„ | Ø¥Ø¶Ø§ÙØ© 15+ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© |

### 2.2.2 Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
| Ø§Ù„Ù…ØªØ·Ù„Ø¨ | Ø§Ù„ØªÙØ§ØµÙŠÙ„ |
|---------|----------|
| Context Ø¬Ø¯ÙŠØ¯ | TenantContext Ù„Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±Ùƒ |
| Middleware | TenantMiddleware Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ tenant Ù…Ù† URL |
| ØµÙØ­Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© | 10+ ØµÙØ­Ø§Øª Super Admin |
| Ù…ÙƒÙˆÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© | 15+ Ù…ÙƒÙˆÙ† Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª |

### 2.2.3 Ø§Ù„Ø®Ø¯Ù…Ø§Øª
| Ø§Ù„Ù…ØªØ·Ù„Ø¨ | Ø§Ù„ØªÙØ§ØµÙŠÙ„ |
|---------|----------|
| Services Ø¬Ø¯ÙŠØ¯Ø© | 5 Ø®Ø¯Ù…Ø§Øª (tenant, subscription, billing, super-admin, tenant-health) |
| Hooks Ø¬Ø¯ÙŠØ¯Ø© | 12+ hook Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† |
| Edge Functions | 3 ÙˆØ¸Ø§Ø¦Ù (webhook-stripe, tenant-cleanup, health-check) |

---

# 3. Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ©

## 3.1 Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø¹Ø§Ù…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶ (Presentation Layer)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Landing Page    â”‚  â”‚ Tenant App      â”‚  â”‚ Super Admin Dashboard   â”‚  â”‚
â”‚  â”‚ /               â”‚  â”‚ /:slug/*        â”‚  â”‚ /super-admin/*          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Ø·Ø¨Ù‚Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (Routing Layer)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      TenantMiddleware                           â”‚    â”‚
â”‚  â”‚  â€¢ Ø§Ø³ØªØ®Ø±Ø§Ø¬ slug Ù…Ù† URL                                          â”‚    â”‚
â”‚  â”‚  â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø´ØªØ±Ùƒ                                       â”‚    â”‚
â”‚  â”‚  â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ                                      â”‚    â”‚
â”‚  â”‚  â€¢ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Ø·Ø¨Ù‚Ø© Ø§Ù„Ø³ÙŠØ§Ù‚ (Context Layer)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AuthContext  â”‚  â”‚TenantContext â”‚  â”‚ QueryClient  â”‚  â”‚ThemeContext â”‚  â”‚
â”‚  â”‚ (Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©)   â”‚  â”‚ (Ø§Ù„Ù…Ø´ØªØ±Ùƒ)    â”‚  â”‚ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)   â”‚  â”‚ (Ø§Ù„ØªØµÙ…ÙŠÙ…)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Service Layer)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† (Tenant Services)             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  TenantService      â”‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† CRUD                       â”‚   â”‚
â”‚  â”‚  SubscriptionServiceâ”‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø®Ø·Ø·                    â”‚   â”‚
â”‚  â”‚  BillingService     â”‚ Ø§Ù„ÙÙˆØªØ±Ø© ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª                         â”‚   â”‚
â”‚  â”‚  TenantHealthServiceâ”‚ Ù…Ø±Ø§Ù‚Ø¨Ø© ØµØ­Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†                       â”‚   â”‚
â”‚  â”‚  SuperAdminService  â”‚ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (Ù…Ø¹Ø¯Ù„Ø© Ù„Ù€ tenant_id)            â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  BeneficiaryService â”‚ PropertyService â”‚ AccountingService â”‚ ...  â”‚   â”‚
â”‚  â”‚  (Ø¬Ù…ÙŠØ¹Ù‡Ø§ ØªØ³ØªÙ‚Ø¨Ù„ tenant_id ÙƒÙ…Ø¹Ø§Ù…Ù„)                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Ø·Ø¨Ù‚Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Database Layer)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                          Supabase                                â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Tables    â”‚  â”‚    RLS     â”‚  â”‚  Indexes   â”‚  â”‚ Functions  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ +tenant_id â”‚  â”‚ +tenant    â”‚  â”‚ +composite â”‚  â”‚ +tenant    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  filtering â”‚  â”‚  policies  â”‚  â”‚  indexes   â”‚  â”‚  helpers   â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3.2 ØªØ¯ÙÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ØªØ¯ÙÙ‚ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¯Ø®Ù„: waqfapp.com/ahmed/beneficiaries                     â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚  2. TenantMiddleware:                                                   â”‚
â”‚     â”œâ”€â”€ Ø§Ø³ØªØ®Ø±Ø§Ø¬ slug = "ahmed"                                         â”‚
â”‚     â”œâ”€â”€ SELECT * FROM tenants WHERE slug = 'ahmed'                     â”‚
â”‚     â”œâ”€â”€ Ø§Ù„ØªØ­Ù‚Ù‚: status = 'active' âœ“                                    â”‚
â”‚     â”œâ”€â”€ Ø§Ù„ØªØ­Ù‚Ù‚: subscription_expires_at > NOW() âœ“                      â”‚
â”‚     â””â”€â”€ ØªØ­Ù…ÙŠÙ„: TenantContext.tenant = {...}                            â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚  3. AuthMiddleware:                                                     â”‚
â”‚     â”œâ”€â”€ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„                                         â”‚
â”‚     â”œâ”€â”€ SELECT * FROM tenant_users WHERE user_id AND tenant_id         â”‚
â”‚     â””â”€â”€ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø´ØªØ±Ùƒ âœ“                            â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚  4. React Component:                                                    â”‚
â”‚     â”œâ”€â”€ const { tenant } = useTenant()                                  â”‚
â”‚     â”œâ”€â”€ useQuery(['beneficiaries', tenant.id], ...)                    â”‚
â”‚     â””â”€â”€ BeneficiaryService.getAll(tenant.id)                           â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚  5. Supabase Query:                                                     â”‚
â”‚     â”œâ”€â”€ SELECT * FROM beneficiaries                                    â”‚
â”‚     â”œâ”€â”€ RLS Policy: tenant_id = get_user_tenant_id() âœ“                 â”‚
â”‚     â””â”€â”€ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© ÙÙ‚Ø·                                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3.3 Ù…Ø®Ø·Ø· Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                        â”‚     tenants      â”‚                             â”‚
â”‚                        â”‚    (Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†)   â”‚                             â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                 â”‚                                       â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚           â”‚                     â”‚                     â”‚                 â”‚
â”‚           â–¼                     â–¼                     â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  tenant_users   â”‚  â”‚tenant_settings  â”‚  â”‚ tenant_billing  â”‚         â”‚
â”‚  â”‚(Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù…Ø´ØªØ±Ùƒ)â”‚  â”‚(Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ)â”‚  â”‚(ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±Ùƒ) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â”‚                                                             â”‚
â”‚           â”‚ user_id                                                     â”‚
â”‚           â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚  â”‚   auth.users    â”‚                                                    â”‚
â”‚  â”‚   (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)  â”‚                                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                    â”‚
â”‚                                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                         â”‚
â”‚  Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø®Ø±Ù‰ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ tenant_id:                              â”‚
â”‚                                                                         â”‚
â”‚  beneficiaries â”€â”€â”                                                      â”‚
â”‚  properties    â”€â”€â”¼â”€â”€ tenant_id â”€â”€â–º tenants.id                          â”‚
â”‚  contracts     â”€â”€â”¤                                                      â”‚
â”‚  payments      â”€â”€â”¤                                                      â”‚
â”‚  journal_entriesâ”€â”¤                                                      â”‚
â”‚  ...50+ Ø¬Ø¯ÙˆÙ„  â”€â”€â”˜                                                      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# 4. Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

## 4.1 Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

### 4.1.1 Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† (tenants)
```sql
CREATE TABLE public.tenants (
  -- Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,                    -- Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ÙØ±Ø¹ÙŠ: ahmed, mohammed
  
  -- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ
  name TEXT NOT NULL,                           -- Ø§Ø³Ù… Ø§Ù„ÙˆÙ‚Ù
  name_ar TEXT,                                 -- Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
  description TEXT,                             -- ÙˆØµÙ Ø§Ù„ÙˆÙ‚Ù
  logo_url TEXT,                                -- Ø´Ø¹Ø§Ø± Ø§Ù„ÙˆÙ‚Ù
  
  -- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
  owner_email TEXT NOT NULL,                    -- Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø§Ù„Ùƒ
  owner_phone TEXT,                             -- Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø§Ù„Ùƒ
  owner_name TEXT,                              -- Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù„Ùƒ
  
  -- Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
  plan_id UUID REFERENCES subscription_plans(id),
  subscription_status TEXT DEFAULT 'trial',     -- trial, active, suspended, cancelled
  subscription_started_at TIMESTAMPTZ,
  subscription_expires_at TIMESTAMPTZ,
  trial_ends_at TIMESTAMPTZ,
  
  -- Stripe
  stripe_customer_id TEXT,
  stripe_subscription_id TEXT,
  
  -- Ø§Ù„Ø­Ø¯ÙˆØ¯
  max_beneficiaries INTEGER DEFAULT 50,
  max_properties INTEGER DEFAULT 10,
  max_users INTEGER DEFAULT 5,
  max_storage_mb INTEGER DEFAULT 1024,
  
  -- Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  current_beneficiaries INTEGER DEFAULT 0,
  current_properties INTEGER DEFAULT 0,
  current_users INTEGER DEFAULT 0,
  current_storage_mb INTEGER DEFAULT 0,
  
  -- Ø§Ù„Ø­Ø§Ù„Ø©
  status TEXT DEFAULT 'active',                 -- active, suspended, deleted
  suspended_reason TEXT,
  suspended_at TIMESTAMPTZ,
  
  -- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  settings JSONB DEFAULT '{}',
  features JSONB DEFAULT '{}',                  -- Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ÙØ¹Ù„Ø©
  
  -- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ©
  metadata JSONB DEFAULT '{}',
  
  -- Ø§Ù„ØªØªØ¨Ø¹
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  created_by UUID,
  
  -- Ø§Ù„Ù‚ÙŠÙˆØ¯
  CONSTRAINT valid_slug CHECK (slug ~ '^[a-z0-9-]+$'),
  CONSTRAINT slug_min_length CHECK (length(slug) >= 3),
  CONSTRAINT valid_status CHECK (status IN ('active', 'suspended', 'deleted')),
  CONSTRAINT valid_subscription_status CHECK (
    subscription_status IN ('trial', 'active', 'suspended', 'cancelled', 'expired')
  )
);

-- Ø§Ù„ÙÙ‡Ø§Ø±Ø³
CREATE INDEX idx_tenants_slug ON tenants(slug);
CREATE INDEX idx_tenants_status ON tenants(status);
CREATE INDEX idx_tenants_subscription_status ON tenants(subscription_status);
CREATE INDEX idx_tenants_owner_email ON tenants(owner_email);
CREATE INDEX idx_tenants_plan_id ON tenants(plan_id);
CREATE INDEX idx_tenants_expires_at ON tenants(subscription_expires_at);

-- ØªØ­Ø¯ÙŠØ« updated_at ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
CREATE TRIGGER update_tenants_updated_at
  BEFORE UPDATE ON tenants
  FOR EACH ROW
  EXECUTE FUNCTION handle_updated_at();
```

### 4.1.2 Ø¬Ø¯ÙˆÙ„ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (subscription_plans)
```sql
CREATE TABLE public.subscription_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø·Ø©
  name TEXT NOT NULL,                           -- Basic, Pro, Enterprise
  name_ar TEXT NOT NULL,                        -- Ø£Ø³Ø§Ø³ÙŠØ©ØŒ Ù…ØªÙ‚Ø¯Ù…Ø©ØŒ Ù…Ø¤Ø³Ø³ÙŠØ©
  description TEXT,
  description_ar TEXT,
  
  -- Ø§Ù„ØªØ³Ø¹ÙŠØ±
  price_monthly NUMERIC(10,2) NOT NULL,         -- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ
  price_yearly NUMERIC(10,2),                   -- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ (Ø®ØµÙ…)
  currency TEXT DEFAULT 'SAR',
  
  -- Ø§Ù„Ø­Ø¯ÙˆØ¯
  max_beneficiaries INTEGER NOT NULL,
  max_properties INTEGER NOT NULL,
  max_users INTEGER NOT NULL,
  max_storage_mb INTEGER NOT NULL,
  
  -- Ø§Ù„Ù…ÙŠØ²Ø§Øª
  features JSONB DEFAULT '[]',                  -- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙŠØ²Ø§Øª
  features_ar JSONB DEFAULT '[]',
  
  -- Stripe
  stripe_price_id_monthly TEXT,
  stripe_price_id_yearly TEXT,
  stripe_product_id TEXT,
  
  -- Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø¹Ø±Ø¶
  display_order INTEGER DEFAULT 0,
  is_popular BOOLEAN DEFAULT false,             -- Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§
  is_active BOOLEAN DEFAULT true,
  
  -- Ø§Ù„ØªØªØ¨Ø¹
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
INSERT INTO subscription_plans (name, name_ar, price_monthly, max_beneficiaries, max_properties, max_users, max_storage_mb, features, display_order) VALUES
('Basic', 'Ø£Ø³Ø§Ø³ÙŠØ©', 99, 50, 10, 5, 1024, 
 '["Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†", "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª", "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", "Ø§Ù„Ø¯Ø¹Ù… Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯"]', 1),
('Pro', 'Ù…ØªÙ‚Ø¯Ù…Ø©', 299, 200, 50, 15, 5120, 
 '["Ø¬Ù…ÙŠØ¹ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©", "Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ø¢Ù„ÙŠØ©", "Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ù‡Ø§ØªÙÙŠ", "API Access"]', 2),
('Enterprise', 'Ù…Ø¤Ø³Ø³ÙŠØ©', 599, -1, -1, -1, -1, 
 '["Ø¬Ù…ÙŠØ¹ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©", "ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯", "Ù…Ø¯ÙŠØ± Ø­Ø³Ø§Ø¨ Ø®Ø§Øµ", "ØªØ®ØµÙŠØµ ÙƒØ§Ù…Ù„", "SLA Ù…Ø¶Ù…ÙˆÙ†"]', 3);
```

### 4.1.3 Ø¬Ø¯ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù…Ø´ØªØ±Ùƒ (tenant_users)
```sql
CREATE TABLE public.tenant_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- Ø§Ù„Ø¯ÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
  role app_role NOT NULL DEFAULT 'user',
  
  -- Ø§Ù„Ø­Ø§Ù„Ø©
  status TEXT DEFAULT 'active',                 -- active, suspended, pending
  
  -- Ø§Ù„Ø¯Ø¹ÙˆØ©
  invited_by UUID REFERENCES auth.users(id),
  invited_at TIMESTAMPTZ,
  accepted_at TIMESTAMPTZ,
  invitation_token TEXT,
  invitation_expires_at TIMESTAMPTZ,
  
  -- Ø§Ù„ØªØªØ¨Ø¹
  last_login_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  -- Ø§Ù„Ù‚ÙŠÙˆØ¯
  CONSTRAINT unique_tenant_user UNIQUE (tenant_id, user_id),
  CONSTRAINT valid_status CHECK (status IN ('active', 'suspended', 'pending'))
);

-- Ø§Ù„ÙÙ‡Ø§Ø±Ø³
CREATE INDEX idx_tenant_users_tenant_id ON tenant_users(tenant_id);
CREATE INDEX idx_tenant_users_user_id ON tenant_users(user_id);
CREATE INDEX idx_tenant_users_role ON tenant_users(role);
CREATE INDEX idx_tenant_users_status ON tenant_users(status);
```

### 4.1.4 Ø¬Ø¯ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ (tenant_settings)
```sql
CREATE TABLE public.tenant_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  
  -- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
  timezone TEXT DEFAULT 'Asia/Riyadh',
  language TEXT DEFAULT 'ar',
  date_format TEXT DEFAULT 'YYYY-MM-DD',
  currency TEXT DEFAULT 'SAR',
  
  -- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Ù
  waqf_name TEXT,
  waqf_registration_number TEXT,
  nazer_name TEXT,
  nazer_percentage NUMERIC(5,2) DEFAULT 10,
  charity_percentage NUMERIC(5,2) DEFAULT 5,
  
  -- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆØ²ÙŠØ¹
  distribution_settings JSONB DEFAULT '{}',
  
  -- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  notification_settings JSONB DEFAULT '{
    "email_enabled": true,
    "sms_enabled": false,
    "push_enabled": true
  }',
  
  -- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¸Ù‡Ø±
  theme_settings JSONB DEFAULT '{
    "primary_color": "#10b981",
    "logo_url": null
  }',
  
  -- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
  report_settings JSONB DEFAULT '{}',
  
  -- Ø§Ù„ØªØªØ¨Ø¹
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  CONSTRAINT unique_tenant_settings UNIQUE (tenant_id)
);
```

### 4.1.5 Ø¬Ø¯ÙˆÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±Ùƒ (tenant_billing)
```sql
CREATE TABLE public.tenant_billing (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  
  -- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©
  invoice_number TEXT NOT NULL,
  invoice_date DATE NOT NULL,
  due_date DATE NOT NULL,
  
  -- Ø§Ù„Ù…Ø¨Ø§Ù„Øº
  subtotal NUMERIC(10,2) NOT NULL,
  tax_amount NUMERIC(10,2) DEFAULT 0,
  discount_amount NUMERIC(10,2) DEFAULT 0,
  total_amount NUMERIC(10,2) NOT NULL,
  
  -- Ø§Ù„Ø¯ÙØ¹
  status TEXT DEFAULT 'pending',                -- pending, paid, overdue, cancelled
  paid_at TIMESTAMPTZ,
  payment_method TEXT,
  
  -- Stripe
  stripe_invoice_id TEXT,
  stripe_payment_intent_id TEXT,
  
  -- Ø§Ù„ØªÙØ§ØµÙŠÙ„
  line_items JSONB DEFAULT '[]',
  billing_period_start DATE,
  billing_period_end DATE,
  
  -- Ø§Ù„ØªØªØ¨Ø¹
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  CONSTRAINT valid_billing_status CHECK (status IN ('pending', 'paid', 'overdue', 'cancelled'))
);

-- Ø§Ù„ÙÙ‡Ø§Ø±Ø³
CREATE INDEX idx_tenant_billing_tenant_id ON tenant_billing(tenant_id);
CREATE INDEX idx_tenant_billing_status ON tenant_billing(status);
CREATE INDEX idx_tenant_billing_due_date ON tenant_billing(due_date);
```

## 4.2 ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©

### 4.2.1 Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
```sql
-- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø¥Ø¶Ø§ÙØ© tenant_id (50+ Ø¬Ø¯ÙˆÙ„)
ALTER TABLE beneficiaries ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE properties ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE contracts ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE rental_payments ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE tenants_table ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE tenant_ledger ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE journal_entries ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE journal_entry_lines ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE accounts ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE fiscal_years ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE distributions ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE distribution_details ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE loans ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE loan_installments ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE emergency_aid_requests ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE payments ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE invoices ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE documents ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE families ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE funds ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE notifications ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE beneficiary_requests ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE bank_accounts ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE property_units ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE maintenance_requests ADD COLUMN tenant_id UUID REFERENCES tenants(id);
ALTER TABLE annual_disclosures ADD COLUMN tenant_id UUID REFERENCES tenants(id);
-- ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
```

### 4.2.2 Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ØªØ±Ø­ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„
```sql
-- Ù…Ù„Ù: migrations/001_add_tenant_id_to_all_tables.sql

-- 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø£ÙˆÙ„Ø§Ù‹
-- (ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ÙˆØ¶Ø­ Ø£Ø¹Ù„Ø§Ù‡)

-- 2. Ø¥Ø¶Ø§ÙØ© tenant_id Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
DO $$
DECLARE
  table_name TEXT;
  tables_to_update TEXT[] := ARRAY[
    'beneficiaries', 'properties', 'contracts', 'rental_payments',
    'tenants', 'tenant_ledger', 'journal_entries', 'journal_entry_lines',
    'accounts', 'fiscal_years', 'distributions', 'distribution_details',
    'loans', 'loan_installments', 'emergency_aid_requests', 'payments',
    'invoices', 'documents', 'families', 'funds', 'notifications',
    'beneficiary_requests', 'bank_accounts', 'property_units',
    'maintenance_requests', 'annual_disclosures', 'heir_distributions',
    'opening_balances', 'waqf_distribution_settings', 'cashier_shifts',
    'pos_transactions', 'support_tickets', 'knowledge_base_articles',
    'custom_reports', 'report_templates', 'approval_workflows',
    'beneficiary_attachments', 'beneficiary_activity_log',
    'beneficiary_categories', 'beneficiary_tags', 'contract_units',
    'bank_statements', 'bank_transactions', 'bank_transfer_files',
    'payment_vouchers', 'receipt_vouchers'
    -- Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
  ];
BEGIN
  FOREACH table_name IN ARRAY tables_to_update LOOP
    EXECUTE format('
      ALTER TABLE %I 
      ADD COLUMN IF NOT EXISTS tenant_id UUID REFERENCES tenants(id);
    ', table_name);
    
    -- Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø±Ø³
    EXECUTE format('
      CREATE INDEX IF NOT EXISTS idx_%s_tenant_id 
      ON %I(tenant_id);
    ', table_name, table_name);
  END LOOP;
END $$;

-- 3. Ø¥Ù†Ø´Ø§Ø¡ ÙÙ‡Ø§Ø±Ø³ Ù…Ø±ÙƒØ¨Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡
CREATE INDEX idx_beneficiaries_tenant_status ON beneficiaries(tenant_id, status);
CREATE INDEX idx_properties_tenant_status ON properties(tenant_id, status);
CREATE INDEX idx_contracts_tenant_status ON contracts(tenant_id, status);
CREATE INDEX idx_payments_tenant_date ON rental_payments(tenant_id, payment_date);
CREATE INDEX idx_journal_entries_tenant_date ON journal_entries(tenant_id, entry_date);
CREATE INDEX idx_distributions_tenant_fiscal ON distributions(tenant_id, fiscal_year_id);
```

## 4.3 Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©

### 4.3.1 Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ tenant_id Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
```sql
CREATE OR REPLACE FUNCTION get_user_tenant_id()
RETURNS UUID
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT tenant_id 
  FROM tenant_users 
  WHERE user_id = auth.uid() 
    AND status = 'active'
  LIMIT 1;
$$;
```

### 4.3.2 Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø´ØªØ±Ùƒ
```sql
CREATE OR REPLACE FUNCTION user_belongs_to_tenant(p_tenant_id UUID)
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 
    FROM tenant_users 
    WHERE user_id = auth.uid() 
      AND tenant_id = p_tenant_id
      AND status = 'active'
  );
$$;
```

### 4.3.3 Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Super Admin
```sql
CREATE OR REPLACE FUNCTION is_super_admin()
RETURNS BOOLEAN
LANGUAGE sql
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1 
    FROM user_roles 
    WHERE user_id = auth.uid() 
      AND role = 'super_admin'
  );
$$;
```

### 4.3.4 Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø·Ø©
```sql
CREATE OR REPLACE FUNCTION check_tenant_limit(
  p_tenant_id UUID,
  p_resource_type TEXT  -- 'beneficiaries', 'properties', 'users', 'storage'
)
RETURNS TABLE(
  allowed BOOLEAN,
  current_count INTEGER,
  max_allowed INTEGER,
  percentage_used NUMERIC
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_current INTEGER;
  v_max INTEGER;
BEGIN
  -- Ø¬Ù„Ø¨ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø®Ø·Ø©
  SELECT 
    CASE p_resource_type
      WHEN 'beneficiaries' THEN t.max_beneficiaries
      WHEN 'properties' THEN t.max_properties
      WHEN 'users' THEN t.max_users
      WHEN 'storage' THEN t.max_storage_mb
    END
  INTO v_max
  FROM tenants t
  WHERE t.id = p_tenant_id;
  
  -- Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
  SELECT 
    CASE p_resource_type
      WHEN 'beneficiaries' THEN t.current_beneficiaries
      WHEN 'properties' THEN t.current_properties
      WHEN 'users' THEN t.current_users
      WHEN 'storage' THEN t.current_storage_mb
    END
  INTO v_current
  FROM tenants t
  WHERE t.id = p_tenant_id;
  
  RETURN QUERY SELECT 
    (v_max = -1 OR v_current < v_max) AS allowed,
    v_current AS current_count,
    v_max AS max_allowed,
    CASE WHEN v_max > 0 THEN (v_current::NUMERIC / v_max * 100) ELSE 0 END AS percentage_used;
END;
$$;
```

### 4.3.5 Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ
```sql
CREATE OR REPLACE FUNCTION update_tenant_counters()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  IF TG_TABLE_NAME = 'beneficiaries' THEN
    IF TG_OP = 'INSERT' THEN
      UPDATE tenants SET current_beneficiaries = current_beneficiaries + 1 
      WHERE id = NEW.tenant_id;
    ELSIF TG_OP = 'DELETE' THEN
      UPDATE tenants SET current_beneficiaries = current_beneficiaries - 1 
      WHERE id = OLD.tenant_id;
    END IF;
  ELSIF TG_TABLE_NAME = 'properties' THEN
    IF TG_OP = 'INSERT' THEN
      UPDATE tenants SET current_properties = current_properties + 1 
      WHERE id = NEW.tenant_id;
    ELSIF TG_OP = 'DELETE' THEN
      UPDATE tenants SET current_properties = current_properties - 1 
      WHERE id = OLD.tenant_id;
    END IF;
  END IF;
  
  RETURN COALESCE(NEW, OLD);
END;
$$;

-- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±ÙŠØ¬Ø±
CREATE TRIGGER trigger_update_beneficiaries_counter
  AFTER INSERT OR DELETE ON beneficiaries
  FOR EACH ROW EXECUTE FUNCTION update_tenant_counters();

CREATE TRIGGER trigger_update_properties_counter
  AFTER INSERT OR DELETE ON properties
  FOR EACH ROW EXECUTE FUNCTION update_tenant_counters();
```

---

# 5. Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø¹Ø²Ù„

## 5.1 Ø³ÙŠØ§Ø³Ø§Øª RLS Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

### 5.1.1 Ù†Ù…Ø· Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù…ÙˆØ­Ø¯
```sql
-- Ù†Ù…Ø· Ù…ÙˆØ­Ø¯ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
-- ÙŠØ¶Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ±Ù‰ ÙÙ‚Ø· Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø°ÙŠ ÙŠÙ†ØªÙ…ÙŠ Ø¥Ù„ÙŠÙ‡

-- 1. Ø³ÙŠØ§Ø³Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©
CREATE POLICY "tenant_isolation_select" ON [table_name]
FOR SELECT
TO authenticated
USING (
  tenant_id = get_user_tenant_id()
  OR is_super_admin()
);

-- 2. Ø³ÙŠØ§Ø³Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ©
CREATE POLICY "tenant_isolation_insert" ON [table_name]
FOR INSERT
TO authenticated
WITH CHECK (
  tenant_id = get_user_tenant_id()
);

-- 3. Ø³ÙŠØ§Ø³Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«
CREATE POLICY "tenant_isolation_update" ON [table_name]
FOR UPDATE
TO authenticated
USING (tenant_id = get_user_tenant_id())
WITH CHECK (tenant_id = get_user_tenant_id());

-- 4. Ø³ÙŠØ§Ø³Ø© Ù„Ù„Ø­Ø°Ù
CREATE POLICY "tenant_isolation_delete" ON [table_name]
FOR DELETE
TO authenticated
USING (
  tenant_id = get_user_tenant_id()
  AND is_admin_or_nazer()
);
```

### 5.1.2 Ø³ÙƒØ±ÙŠØ¨Øª ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
```sql
-- Ù…Ù„Ù: migrations/002_apply_tenant_rls_policies.sql

DO $$
DECLARE
  table_name TEXT;
  tables_with_tenant_id TEXT[] := ARRAY[
    'beneficiaries', 'properties', 'contracts', 'rental_payments',
    'journal_entries', 'accounts', 'distributions', 'loans', 
    'payments', 'invoices', 'documents', 'families', 'funds',
    'notifications', 'bank_accounts', 'property_units'
    -- ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
  ];
BEGIN
  FOREACH table_name IN ARRAY tables_with_tenant_id LOOP
    -- Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    EXECUTE format('DROP POLICY IF EXISTS "tenant_isolation_select" ON %I', table_name);
    EXECUTE format('DROP POLICY IF EXISTS "tenant_isolation_insert" ON %I', table_name);
    EXECUTE format('DROP POLICY IF EXISTS "tenant_isolation_update" ON %I', table_name);
    EXECUTE format('DROP POLICY IF EXISTS "tenant_isolation_delete" ON %I', table_name);
    
    -- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    EXECUTE format('
      CREATE POLICY "tenant_isolation_select" ON %I
      FOR SELECT TO authenticated
      USING (tenant_id = get_user_tenant_id() OR is_super_admin())
    ', table_name);
    
    EXECUTE format('
      CREATE POLICY "tenant_isolation_insert" ON %I
      FOR INSERT TO authenticated
      WITH CHECK (tenant_id = get_user_tenant_id())
    ', table_name);
    
    EXECUTE format('
      CREATE POLICY "tenant_isolation_update" ON %I
      FOR UPDATE TO authenticated
      USING (tenant_id = get_user_tenant_id())
      WITH CHECK (tenant_id = get_user_tenant_id())
    ', table_name);
    
    EXECUTE format('
      CREATE POLICY "tenant_isolation_delete" ON %I
      FOR DELETE TO authenticated
      USING (tenant_id = get_user_tenant_id() AND is_admin_or_nazer())
    ', table_name);
  END LOOP;
END $$;
```

### 5.1.3 Ø³ÙŠØ§Ø³Ø§Øª Ø®Ø§ØµØ© Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
```sql
-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†: ÙŠØ±Ø§Ù‡ Super Admin ÙÙ‚Ø·
CREATE POLICY "tenants_super_admin_only" ON tenants
FOR ALL
TO authenticated
USING (is_super_admin())
WITH CHECK (is_super_admin());

-- Ø¬Ø¯ÙˆÙ„ Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ØŒ ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù€ Super Admin
CREATE POLICY "plans_read_all" ON subscription_plans
FOR SELECT
TO authenticated
USING (is_active = true);

CREATE POLICY "plans_admin_modify" ON subscription_plans
FOR ALL
TO authenticated
USING (is_super_admin())
WITH CHECK (is_super_admin());

-- Ø¬Ø¯ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
CREATE POLICY "tenant_users_own_tenant" ON tenant_users
FOR SELECT
TO authenticated
USING (
  tenant_id = get_user_tenant_id() 
  OR user_id = auth.uid()
  OR is_super_admin()
);

CREATE POLICY "tenant_users_admin_modify" ON tenant_users
FOR ALL
TO authenticated
USING (
  (tenant_id = get_user_tenant_id() AND is_admin_or_nazer())
  OR is_super_admin()
);
```

## 5.2 Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† (4 Ø·Ø¨Ù‚Ø§Øª)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Ø§Ù„Ø·Ø¨Ù‚Ø© 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† URL (Middleware)                                   â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                   â”‚
â”‚  â€¢ Ø§Ø³ØªØ®Ø±Ø§Ø¬ slug Ù…Ù† URL                                                  â”‚
â”‚  â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø´ØªØ±Ùƒ                                               â”‚
â”‚  â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (active, not expired)                        â”‚
â”‚  â€¢ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ­Ù‚Ù‚ Ø£ÙŠ Ø´Ø±Ø·                                        â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚  Ø§Ù„Ø·Ø¨Ù‚Ø© 2: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© (Context)                                   â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                  â”‚
â”‚  â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…                                        â”‚
â”‚  â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø´ØªØ±Ùƒ                                    â”‚
â”‚  â€¢ ØªØ­Ù…ÙŠÙ„ Ø£Ø¯ÙˆØ§Ø± ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…                                        â”‚
â”‚  â€¢ ØªØ®Ø²ÙŠÙ† tenant_id ÙÙŠ Context                                           â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚  Ø§Ù„Ø·Ø¨Ù‚Ø© 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Hooks/Services)                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                         â”‚
â”‚  â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©                             â”‚
â”‚  â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø·Ø© (Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©)                                   â”‚
â”‚  â€¢ ØªÙ…Ø±ÙŠØ± tenant_id Ù…Ø¹ ÙƒÙ„ Ø§Ø³ØªØ¹Ù„Ø§Ù…                                        â”‚
â”‚                          â”‚                                              â”‚
â”‚                          â–¼                                              â”‚
â”‚  Ø§Ù„Ø·Ø¨Ù‚Ø© 4: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (RLS)                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                               â”‚
â”‚  â€¢ RLS ÙŠØ¶Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ØªØ±Ùƒ Ø¢Ø®Ø±                                â”‚
â”‚  â€¢ Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©                                      â”‚
â”‚  â€¢ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙˆØ§Ù„Ø£Ù‡Ù…                                                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5.3 Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚

```sql
-- Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
CREATE TABLE public.tenant_audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id),
  user_id UUID REFERENCES auth.users(id),
  
  -- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  action TEXT NOT NULL,                         -- create, update, delete, login, etc.
  resource_type TEXT NOT NULL,                  -- beneficiary, property, etc.
  resource_id UUID,
  
  -- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  old_values JSONB,
  new_values JSONB,
  
  -- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨
  ip_address INET,
  user_agent TEXT,
  request_id TEXT,
  
  -- Ø§Ù„ØªØªØ¨Ø¹
  created_at TIMESTAMPTZ DEFAULT now()
);

-- ÙÙ‡Ø§Ø±Ø³ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
CREATE INDEX idx_tenant_audit_tenant_id ON tenant_audit_logs(tenant_id);
CREATE INDEX idx_tenant_audit_user_id ON tenant_audit_logs(user_id);
CREATE INDEX idx_tenant_audit_action ON tenant_audit_logs(action);
CREATE INDEX idx_tenant_audit_created_at ON tenant_audit_logs(created_at);

-- Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
CREATE OR REPLACE FUNCTION log_tenant_action(
  p_action TEXT,
  p_resource_type TEXT,
  p_resource_id UUID DEFAULT NULL,
  p_old_values JSONB DEFAULT NULL,
  p_new_values JSONB DEFAULT NULL
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_log_id UUID;
BEGIN
  INSERT INTO tenant_audit_logs (
    tenant_id, user_id, action, resource_type, 
    resource_id, old_values, new_values
  ) VALUES (
    get_user_tenant_id(), auth.uid(), p_action, p_resource_type,
    p_resource_id, p_old_values, p_new_values
  ) RETURNING id INTO v_log_id;
  
  RETURN v_log_id;
END;
$$;
```

---

# 6. Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ÙÙ‡Ø±Ø³Ø©

## 6.1 Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ÙÙ‡Ø±Ø³Ø©

### 6.1.1 ÙÙ‡Ø§Ø±Ø³ Ù…Ø±ÙƒØ¨Ø© Ù„ÙƒÙ„ Ø¬Ø¯ÙˆÙ„
```sql
-- Ø§Ù„ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© ØªØ¶Ù…Ù† Ø£Ø¯Ø§Ø¡ Ø¹Ø§Ù„ÙŠ Ù…Ø¹ tenant_id

-- Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†
CREATE INDEX idx_beneficiaries_tenant_status ON beneficiaries(tenant_id, status);
CREATE INDEX idx_beneficiaries_tenant_category ON beneficiaries(tenant_id, category);
CREATE INDEX idx_beneficiaries_tenant_family ON beneficiaries(tenant_id, family_id);
CREATE INDEX idx_beneficiaries_tenant_created ON beneficiaries(tenant_id, created_at DESC);

-- Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
CREATE INDEX idx_properties_tenant_status ON properties(tenant_id, status);
CREATE INDEX idx_properties_tenant_type ON properties(tenant_id, property_type);
CREATE INDEX idx_properties_tenant_city ON properties(tenant_id, city);

-- Ø§Ù„Ø¹Ù‚ÙˆØ¯
CREATE INDEX idx_contracts_tenant_status ON contracts(tenant_id, status);
CREATE INDEX idx_contracts_tenant_dates ON contracts(tenant_id, start_date, end_date);
CREATE INDEX idx_contracts_tenant_property ON contracts(tenant_id, property_id);

-- Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
CREATE INDEX idx_rental_payments_tenant_date ON rental_payments(tenant_id, payment_date DESC);
CREATE INDEX idx_rental_payments_tenant_status ON rental_payments(tenant_id, status);
CREATE INDEX idx_rental_payments_tenant_contract ON rental_payments(tenant_id, contract_id);

-- Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
CREATE INDEX idx_journal_entries_tenant_date ON journal_entries(tenant_id, entry_date DESC);
CREATE INDEX idx_journal_entries_tenant_fiscal ON journal_entries(tenant_id, fiscal_year_id);
CREATE INDEX idx_journal_entries_tenant_status ON journal_entries(tenant_id, status);

-- Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª
CREATE INDEX idx_distributions_tenant_fiscal ON distributions(tenant_id, fiscal_year_id);
CREATE INDEX idx_distributions_tenant_status ON distributions(tenant_id, status);
CREATE INDEX idx_distributions_tenant_date ON distributions(tenant_id, distribution_date DESC);
```

### 6.1.2 ÙÙ‡Ø§Ø±Ø³ Ø¬Ø²Ø¦ÙŠØ© Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
```sql
-- ÙÙ‡Ø§Ø±Ø³ Ø¬Ø²Ø¦ÙŠØ© Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙÙ‚Ø· (Ø£ÙƒØ«Ø± ÙƒÙØ§Ø¡Ø©)
CREATE INDEX idx_beneficiaries_active ON beneficiaries(tenant_id, full_name)
WHERE status = 'Ù†Ø´Ø·';

CREATE INDEX idx_contracts_active ON contracts(tenant_id, end_date)
WHERE status = 'Ù†Ø´Ø·';

CREATE INDEX idx_loans_active ON loans(tenant_id, remaining_balance)
WHERE status IN ('pending', 'approved', 'Ù†Ø´Ø·');
```

## 6.2 ØªØ­Ø³ÙŠÙ†Ø§Øª React Query

### 6.2.1 Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ø¹ tenant_id
```typescript
// src/lib/query-keys-tenant.ts

export const TENANT_QUERY_KEYS = {
  // Ø§Ù„Ù…Ø´ØªØ±Ùƒ
  tenant: (slug: string) => ['tenant', slug] as const,
  tenantSettings: (tenantId: string) => ['tenant', tenantId, 'settings'] as const,
  tenantUsers: (tenantId: string) => ['tenant', tenantId, 'users'] as const,
  tenantLimits: (tenantId: string) => ['tenant', tenantId, 'limits'] as const,
  
  // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ù…Ø´ØªØ±Ùƒ
  beneficiaries: (tenantId: string) => ['tenant', tenantId, 'beneficiaries'] as const,
  properties: (tenantId: string) => ['tenant', tenantId, 'properties'] as const,
  contracts: (tenantId: string) => ['tenant', tenantId, 'contracts'] as const,
  payments: (tenantId: string) => ['tenant', tenantId, 'payments'] as const,
  
  // KPIs
  dashboardKPIs: (tenantId: string) => ['tenant', tenantId, 'dashboard', 'kpis'] as const,
  
  // Super Admin
  allTenants: () => ['super-admin', 'tenants'] as const,
  tenantDetails: (tenantId: string) => ['super-admin', 'tenant', tenantId] as const,
  tenantHealth: (tenantId: string) => ['super-admin', 'tenant', tenantId, 'health'] as const,
  subscriptionPlans: () => ['super-admin', 'plans'] as const,
  billing: () => ['super-admin', 'billing'] as const,
};
```

### 6.2.2 Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
```typescript
// src/lib/query-config-tenant.ts

export const TENANT_QUERY_CONFIG = {
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© - ØªØ®Ø²ÙŠÙ† Ø·ÙˆÙŠÙ„
  tenant: {
    staleTime: 10 * 60 * 1000,      // 10 Ø¯Ù‚Ø§Ø¦Ù‚
    gcTime: 30 * 60 * 1000,         // 30 Ø¯Ù‚ÙŠÙ‚Ø©
    refetchOnWindowFocus: false,
  },
  
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ - ØªØ®Ø²ÙŠÙ† Ù…ØªÙˆØ³Ø·
  settings: {
    staleTime: 5 * 60 * 1000,       // 5 Ø¯Ù‚Ø§Ø¦Ù‚
    gcTime: 15 * 60 * 1000,         // 15 Ø¯Ù‚ÙŠÙ‚Ø©
  },
  
  // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ© - ØªØ®Ø²ÙŠÙ† Ù‚ØµÙŠØ±
  operational: {
    staleTime: 2 * 60 * 1000,       // 2 Ø¯Ù‚ÙŠÙ‚Ø©
    gcTime: 10 * 60 * 1000,         // 10 Ø¯Ù‚Ø§Ø¦Ù‚
    refetchOnWindowFocus: true,
  },
  
  // Ø§Ù„Ø®Ø·Ø· ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø± - ØªØ®Ø²ÙŠÙ† Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹
  plans: {
    staleTime: 60 * 60 * 1000,      // 1 Ø³Ø§Ø¹Ø©
    gcTime: 24 * 60 * 60 * 1000,    // 24 Ø³Ø§Ø¹Ø©
    refetchOnWindowFocus: false,
  },
};
```

## 6.3 Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ

```typescript
// src/hooks/tenant/useTenantRealtime.ts

export function useTenantRealtime(tenantId: string) {
  const queryClient = useQueryClient();
  
  useEffect(() => {
    if (!tenantId) return;
    
    const channel = supabase
      .channel(`tenant-${tenantId}`)
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          filter: `tenant_id=eq.${tenantId}`,
        },
        (payload) => {
          const table = payload.table;
          
          // Ø¥Ø¨Ø·Ø§Ù„ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
          queryClient.invalidateQueries({
            queryKey: ['tenant', tenantId, table],
          });
          
          // Ø¥Ø¨Ø·Ø§Ù„ KPIs Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¤Ø«Ø±Ø§Ù‹
          if (['beneficiaries', 'properties', 'payments', 'contracts'].includes(table)) {
            queryClient.invalidateQueries({
              queryKey: ['tenant', tenantId, 'dashboard', 'kpis'],
            });
          }
        }
      )
      .subscribe();
    
    return () => {
      supabase.removeChannel(channel);
    };
  }, [tenantId, queryClient]);
}
```

---

# 7. Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª

## 7.1 Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª

```
Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Ø¨Ø¯ÙˆÙ† Ù…ØµØ§Ø¯Ù‚Ø©):
â”œâ”€â”€ /                           â†’ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
â”œâ”€â”€ /login                      â†’ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
â”œâ”€â”€ /register                   â†’ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¥Ù†Ø´Ø§Ø¡ ÙˆÙ‚Ù Ø¬Ø¯ÙŠØ¯)
â”œâ”€â”€ /pricing                    â†’ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø®Ø·Ø·
â””â”€â”€ /about                      â†’ Ø¹Ù† Ø§Ù„Ù…Ù†ØµØ©

Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ (ØªØªØ·Ù„Ø¨ Ù…ØµØ§Ø¯Ù‚Ø© + Ø§Ù†ØªÙ…Ø§Ø¡ Ù„Ù„Ù…Ø´ØªØ±Ùƒ):
â”œâ”€â”€ /:slug/                     â†’ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
â”œâ”€â”€ /:slug/beneficiaries        â†’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†
â”œâ”€â”€ /:slug/beneficiaries/:id    â†’ ØªÙØ§ØµÙŠÙ„ Ù…Ø³ØªÙÙŠØ¯
â”œâ”€â”€ /:slug/properties           â†’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
â”œâ”€â”€ /:slug/properties/:id       â†’ ØªÙØ§ØµÙŠÙ„ Ø¹Ù‚Ø§Ø±
â”œâ”€â”€ /:slug/contracts            â†’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯
â”œâ”€â”€ /:slug/accounting           â†’ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©
â”œâ”€â”€ /:slug/distributions        â†’ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª
â”œâ”€â”€ /:slug/loans                â†’ Ø§Ù„Ù‚Ø±ÙˆØ¶
â”œâ”€â”€ /:slug/reports              â†’ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
â”œâ”€â”€ /:slug/archive              â†’ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
â”œâ”€â”€ /:slug/settings             â†’ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
â””â”€â”€ /:slug/users                â†’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

Ù…Ø³Ø§Ø±Ø§Øª Super Admin:
â”œâ”€â”€ /super-admin/               â†’ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
â”œâ”€â”€ /super-admin/tenants        â†’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
â”œâ”€â”€ /super-admin/tenants/:id    â†’ ØªÙØ§ØµÙŠÙ„ Ù…Ø´ØªØ±Ùƒ
â”œâ”€â”€ /super-admin/plans          â†’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø·Ø·
â”œâ”€â”€ /super-admin/billing        â†’ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
â”œâ”€â”€ /super-admin/analytics      â†’ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
â””â”€â”€ /super-admin/settings       â†’ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
```

## 7.2 Ù…ÙƒÙˆÙ† TenantMiddleware

```typescript
// src/middleware/TenantMiddleware.tsx

import React, { useEffect, useState } from 'react';
import { useParams, Navigate, Outlet } from 'react-router-dom';
import { useTenantBySlug } from '@/hooks/tenant/useTenantBySlug';
import { TenantContext } from '@/contexts/TenantContext';
import { useAuth } from '@/contexts/AuthContext';
import { TenantSuspendedPage } from '@/pages/errors/TenantSuspendedPage';
import { TenantExpiredPage } from '@/pages/errors/TenantExpiredPage';
import { TenantNotFoundPage } from '@/pages/errors/TenantNotFoundPage';
import { UnauthorizedPage } from '@/pages/errors/UnauthorizedPage';
import { LoadingSpinner } from '@/components/ui/loading-spinner';

export function TenantMiddleware() {
  const { slug } = useParams<{ slug: string }>();
  const { user, isLoading: authLoading } = useAuth();
  
  const { 
    data: tenant, 
    isLoading: tenantLoading, 
    error 
  } = useTenantBySlug(slug!);
  
  // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
  if (authLoading || tenantLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <LoadingSpinner size="lg" />
        <span className="mr-3 text-muted-foreground">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
      </div>
    );
  }
  
  // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„
  if (!user) {
    return <Navigate to="/login" state={{ from: `/${slug}` }} replace />;
  }
  
  // Ø§Ù„Ù…Ø´ØªØ±Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
  if (error || !tenant) {
    return <TenantNotFoundPage slug={slug!} />;
  }
  
  // Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù…Ø¹Ù„Ù‚
  if (tenant.status === 'suspended') {
    return <TenantSuspendedPage 
      tenant={tenant} 
      reason={tenant.suspended_reason} 
    />;
  }
  
  // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ
  if (tenant.subscription_status === 'expired' || 
      (tenant.subscription_expires_at && new Date(tenant.subscription_expires_at) < new Date())) {
    return <TenantExpiredPage tenant={tenant} />;
  }
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø´ØªØ±Ùƒ
  const userBelongsToTenant = tenant.users?.some(u => u.user_id === user.id);
  if (!userBelongsToTenant) {
    return <UnauthorizedPage tenant={tenant} />;
  }
  
  // ÙƒÙ„ Ø´ÙŠØ¡ ØµØ­ÙŠØ­ - ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³ÙŠØ§Ù‚
  return (
    <TenantContext.Provider value={{
      tenant,
      tenantId: tenant.id,
      slug: tenant.slug,
      settings: tenant.settings,
      plan: tenant.plan,
      limits: {
        beneficiaries: { current: tenant.current_beneficiaries, max: tenant.max_beneficiaries },
        properties: { current: tenant.current_properties, max: tenant.max_properties },
        users: { current: tenant.current_users, max: tenant.max_users },
        storage: { current: tenant.current_storage_mb, max: tenant.max_storage_mb },
      },
    }}>
      <Outlet />
    </TenantContext.Provider>
  );
}
```

## 7.3 TenantContext

```typescript
// src/contexts/TenantContext.tsx

import React, { createContext, useContext } from 'react';

interface TenantLimits {
  beneficiaries: { current: number; max: number };
  properties: { current: number; max: number };
  users: { current: number; max: number };
  storage: { current: number; max: number };
}

interface TenantPlan {
  id: string;
  name: string;
  name_ar: string;
  price_monthly: number;
  features: string[];
}

interface TenantSettings {
  timezone?: string;
  language?: string;
  currency?: string;
  waqf_name?: string;
  nazer_name?: string;
  nazer_percentage?: number;
  [key: string]: any;
}

interface Tenant {
  id: string;
  slug: string;
  name: string;
  name_ar?: string;
  logo_url?: string;
  status: 'active' | 'suspended' | 'deleted';
  subscription_status: 'trial' | 'active' | 'suspended' | 'cancelled' | 'expired';
  subscription_expires_at?: string;
  [key: string]: any;
}

interface TenantContextValue {
  tenant: Tenant;
  tenantId: string;
  slug: string;
  settings: TenantSettings;
  plan: TenantPlan | null;
  limits: TenantLimits;
}

const TenantContext = createContext<TenantContextValue | null>(null);

export function useTenant() {
  const context = useContext(TenantContext);
  if (!context) {
    throw new Error('useTenant must be used within TenantMiddleware');
  }
  return context;
}

export function useTenantId() {
  const { tenantId } = useTenant();
  return tenantId;
}

export function useTenantLimits() {
  const { limits } = useTenant();
  return limits;
}

export function useCanAddResource(resourceType: keyof TenantLimits) {
  const { limits } = useTenant();
  const limit = limits[resourceType];
  
  // -1 ÙŠØ¹Ù†ÙŠ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯
  if (limit.max === -1) return true;
  
  return limit.current < limit.max;
}

export { TenantContext };
```

## 7.4 ØªØ­Ø¯ÙŠØ« App.tsx

```typescript
// src/App.tsx (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…ØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª)

import { TenantMiddleware } from '@/middleware/TenantMiddleware';
import { SuperAdminMiddleware } from '@/middleware/SuperAdminMiddleware';

// Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
<Routes>
  {/* Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */}
  <Route path="/" element={<LandingPage />} />
  <Route path="/login" element={<LoginPage />} />
  <Route path="/register" element={<RegisterPage />} />
  <Route path="/pricing" element={<PricingPage />} />
  
  {/* Ù…Ø³Ø§Ø±Ø§Øª Super Admin */}
  <Route path="/super-admin" element={<SuperAdminMiddleware />}>
    <Route index element={<SuperAdminDashboard />} />
    <Route path="tenants" element={<TenantsListPage />} />
    <Route path="tenants/:id" element={<TenantDetailsPage />} />
    <Route path="plans" element={<PlansManagementPage />} />
    <Route path="billing" element={<BillingPage />} />
    <Route path="analytics" element={<AnalyticsPage />} />
    <Route path="settings" element={<SuperAdminSettingsPage />} />
  </Route>
  
  {/* Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ */}
  <Route path="/:slug" element={<TenantMiddleware />}>
    <Route element={<MainLayout />}>
      <Route index element={<Dashboard />} />
      <Route path="beneficiaries" element={<BeneficiariesPage />} />
      <Route path="beneficiaries/:id" element={<BeneficiaryDetailsPage />} />
      <Route path="properties" element={<PropertiesPage />} />
      <Route path="properties/:id" element={<PropertyDetailsPage />} />
      <Route path="contracts" element={<ContractsPage />} />
      <Route path="accounting" element={<AccountingPage />} />
      <Route path="distributions" element={<DistributionsPage />} />
      <Route path="loans" element={<LoansPage />} />
      <Route path="reports" element={<ReportsPage />} />
      <Route path="archive" element={<ArchivePage />} />
      <Route path="settings" element={<SettingsPage />} />
      <Route path="users" element={<UsersManagementPage />} />
    </Route>
  </Route>
  
  {/* ØµÙØ­Ø© 404 */}
  <Route path="*" element={<NotFoundPage />} />
</Routes>
```

---

# 8. Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„ÙÙˆØªØ±Ø©

## 8.1 ØªÙƒØ§Ù…Ù„ Stripe

### 8.1.1 Edge Function Ù„Ù€ Webhook
```typescript
// supabase/functions/stripe-webhook/index.ts

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
import Stripe from 'https://esm.sh/stripe@12.0.0';

const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY')!, {
  apiVersion: '2023-10-16',
});

const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

serve(async (req) => {
  const signature = req.headers.get('stripe-signature')!;
  const body = await req.text();
  
  let event: Stripe.Event;
  
  try {
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      Deno.env.get('STRIPE_WEBHOOK_SECRET')!
    );
  } catch (err) {
    return new Response(`Webhook Error: ${err.message}`, { status: 400 });
  }
  
  switch (event.type) {
    case 'customer.subscription.created':
    case 'customer.subscription.updated': {
      const subscription = event.data.object as Stripe.Subscription;
      
      await supabase
        .from('tenants')
        .update({
          stripe_subscription_id: subscription.id,
          subscription_status: subscription.status === 'active' ? 'active' : 'suspended',
          subscription_expires_at: new Date(subscription.current_period_end * 1000).toISOString(),
        })
        .eq('stripe_customer_id', subscription.customer);
      
      break;
    }
    
    case 'customer.subscription.deleted': {
      const subscription = event.data.object as Stripe.Subscription;
      
      await supabase
        .from('tenants')
        .update({
          subscription_status: 'cancelled',
        })
        .eq('stripe_subscription_id', subscription.id);
      
      break;
    }
    
    case 'invoice.paid': {
      const invoice = event.data.object as Stripe.Invoice;
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ ÙØ§ØªÙˆØ±Ø©
      await supabase
        .from('tenant_billing')
        .insert({
          tenant_id: await getTenantIdByStripeCustomer(invoice.customer as string),
          invoice_number: invoice.number,
          invoice_date: new Date(invoice.created * 1000).toISOString(),
          due_date: new Date(invoice.due_date! * 1000).toISOString(),
          subtotal: invoice.subtotal / 100,
          tax_amount: invoice.tax ? invoice.tax / 100 : 0,
          total_amount: invoice.total / 100,
          status: 'paid',
          paid_at: new Date().toISOString(),
          stripe_invoice_id: invoice.id,
        });
      
      break;
    }
    
    case 'invoice.payment_failed': {
      const invoice = event.data.object as Stripe.Invoice;
      
      // ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
      await supabase
        .from('tenants')
        .update({
          subscription_status: 'suspended',
          suspended_reason: 'ÙØ´Ù„ Ø§Ù„Ø¯ÙØ¹',
          suspended_at: new Date().toISOString(),
        })
        .eq('stripe_customer_id', invoice.customer);
      
      break;
    }
  }
  
  return new Response(JSON.stringify({ received: true }), {
    headers: { 'Content-Type': 'application/json' },
  });
});

async function getTenantIdByStripeCustomer(customerId: string) {
  const { data } = await supabase
    .from('tenants')
    .select('id')
    .eq('stripe_customer_id', customerId)
    .single();
  
  return data?.id;
}
```

### 8.1.2 Ø®Ø¯Ù…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
```typescript
// src/services/subscription.service.ts

import Stripe from 'stripe';
import { supabase } from '@/integrations/supabase/client';

export class SubscriptionService {
  private static stripe = new Stripe(import.meta.env.VITE_STRIPE_PUBLIC_KEY);
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¯ÙØ¹
  static async createCheckoutSession(
    tenantId: string,
    planId: string,
    billingPeriod: 'monthly' | 'yearly'
  ) {
    const { data, error } = await supabase.functions.invoke('create-checkout-session', {
      body: { tenantId, planId, billingPeriod },
    });
    
    if (error) throw error;
    return data;
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØ§Ø¨Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
  static async createBillingPortalSession(tenantId: string) {
    const { data, error } = await supabase.functions.invoke('create-billing-portal', {
      body: { tenantId },
    });
    
    if (error) throw error;
    return data;
  }
  
  // ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ø·Ø©
  static async changePlan(tenantId: string, newPlanId: string) {
    const { data, error } = await supabase.functions.invoke('change-subscription-plan', {
      body: { tenantId, newPlanId },
    });
    
    if (error) throw error;
    return data;
  }
  
  // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
  static async cancelSubscription(tenantId: string) {
    const { data, error } = await supabase.functions.invoke('cancel-subscription', {
      body: { tenantId },
    });
    
    if (error) throw error;
    return data;
  }
  
  // Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
  static async getInvoices(tenantId: string) {
    const { data, error } = await supabase
      .from('tenant_billing')
      .select('*')
      .eq('tenant_id', tenantId)
      .order('invoice_date', { ascending: false });
    
    if (error) throw error;
    return data;
  }
  
  // Ø¬Ù„Ø¨ Ø§Ù„Ø®Ø·Ø· Ø§Ù„Ù…ØªØ§Ø­Ø©
  static async getPlans() {
    const { data, error } = await supabase
      .from('subscription_plans')
      .select('*')
      .eq('is_active', true)
      .order('display_order');
    
    if (error) throw error;
    return data;
  }
}
```

## 8.2 ØµÙØ­Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø±

```typescript
// src/pages/public/PricingPage.tsx

import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import { SubscriptionService } from '@/services/subscription.service';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Switch } from '@/components/ui/switch';
import { Check } from 'lucide-react';

export function PricingPage() {
  const [billingPeriod, setBillingPeriod] = useState<'monthly' | 'yearly'>('monthly');
  const navigate = useNavigate();
  
  const { data: plans, isLoading } = useQuery({
    queryKey: ['subscription-plans'],
    queryFn: () => SubscriptionService.getPlans(),
  });
  
  const handleSelectPlan = (planId: string) => {
    navigate(`/register?plan=${planId}&billing=${billingPeriod}`);
  };
  
  return (
    <div className="container mx-auto py-16">
      <div className="text-center mb-12">
        <h1 className="text-4xl font-bold mb-4">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ùƒ</h1>
        <p className="text-muted-foreground text-lg mb-8">
          Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø·Ø· ØªØ´Ù…Ù„ ÙØªØ±Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© 14 ÙŠÙˆÙ… Ù…Ø¬Ø§Ù†Ø§Ù‹
        </p>
        
        {/* Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ÙÙˆØªØ±Ø© */}
        <div className="flex items-center justify-center gap-4">
          <span className={billingPeriod === 'monthly' ? 'font-bold' : ''}>Ø´Ù‡Ø±ÙŠ</span>
          <Switch
            checked={billingPeriod === 'yearly'}
            onCheckedChange={(checked) => setBillingPeriod(checked ? 'yearly' : 'monthly')}
          />
          <span className={billingPeriod === 'yearly' ? 'font-bold' : ''}>
            Ø³Ù†ÙˆÙŠ
            <span className="text-green-500 text-sm mr-1">(Ø®ØµÙ… 20%)</span>
          </span>
        </div>
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
        {plans?.map((plan) => (
          <Card 
            key={plan.id}
            className={`relative ${plan.is_popular ? 'border-primary shadow-lg scale-105' : ''}`}
          >
            {plan.is_popular && (
              <div className="absolute -top-3 right-4 bg-primary text-primary-foreground px-3 py-1 rounded-full text-sm">
                Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ø§Ù‹
              </div>
            )}
            
            <CardHeader>
              <CardTitle className="text-2xl">{plan.name_ar}</CardTitle>
              <div className="mt-4">
                <span className="text-4xl font-bold">
                  {billingPeriod === 'monthly' 
                    ? plan.price_monthly 
                    : Math.round(plan.price_yearly! / 12)}
                </span>
                <span className="text-muted-foreground"> Ø±.Ø³/Ø´Ù‡Ø±ÙŠØ§Ù‹</span>
              </div>
              {billingPeriod === 'yearly' && (
                <p className="text-sm text-muted-foreground">
                  ÙŠÙØ¯ÙØ¹ {plan.price_yearly} Ø±.Ø³ Ø³Ù†ÙˆÙŠØ§Ù‹
                </p>
              )}
            </CardHeader>
            
            <CardContent>
              <ul className="space-y-3 mb-6">
                <li className="flex items-center gap-2">
                  <Check className="h-5 w-5 text-green-500" />
                  <span>
                    {plan.max_beneficiaries === -1 
                      ? 'Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯' 
                      : `Ø­ØªÙ‰ ${plan.max_beneficiaries} Ù…Ø³ØªÙÙŠØ¯`}
                  </span>
                </li>
                <li className="flex items-center gap-2">
                  <Check className="h-5 w-5 text-green-500" />
                  <span>
                    {plan.max_properties === -1 
                      ? 'Ø¹Ù‚Ø§Ø±Ø§Øª ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©' 
                      : `Ø­ØªÙ‰ ${plan.max_properties} Ø¹Ù‚Ø§Ø±`}
                  </span>
                </li>
                <li className="flex items-center gap-2">
                  <Check className="h-5 w-5 text-green-500" />
                  <span>
                    {plan.max_users === -1 
                      ? 'Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯' 
                      : `Ø­ØªÙ‰ ${plan.max_users} Ù…Ø³ØªØ®Ø¯Ù…`}
                  </span>
                </li>
                {(plan.features as string[])?.map((feature, index) => (
                  <li key={index} className="flex items-center gap-2">
                    <Check className="h-5 w-5 text-green-500" />
                    <span>{feature}</span>
                  </li>
                ))}
              </ul>
              
              <Button 
                className="w-full" 
                variant={plan.is_popular ? 'default' : 'outline'}
                onClick={() => handleSelectPlan(plan.id)}
              >
                Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†
              </Button>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
}
```

---

# 9. Ù„ÙˆØ­Ø© Super Admin

## 9.1 Ù‡ÙŠÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª

```
src/pages/super-admin/
â”œâ”€â”€ SuperAdminDashboard.tsx      # Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
â”œâ”€â”€ TenantsListPage.tsx          # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
â”œâ”€â”€ TenantDetailsPage.tsx        # ØªÙØ§ØµÙŠÙ„ Ù…Ø´ØªØ±Ùƒ
â”œâ”€â”€ PlansManagementPage.tsx      # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø·Ø·
â”œâ”€â”€ BillingPage.tsx              # Ø§Ù„ÙÙˆØ§ØªÙŠØ±
â”œâ”€â”€ AnalyticsPage.tsx            # Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
â””â”€â”€ SuperAdminSettingsPage.tsx   # Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
```

## 9.2 Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

```typescript
// src/pages/super-admin/SuperAdminDashboard.tsx

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { useSuperAdminStats } from '@/hooks/super-admin/useSuperAdminStats';
import { useRecentTenants } from '@/hooks/super-admin/useRecentTenants';
import { useBillingOverview } from '@/hooks/super-admin/useBillingOverview';
import { TenantHealthOverview } from '@/components/super-admin/TenantHealthOverview';
import { RevenueChart } from '@/components/super-admin/RevenueChart';
import { AlertsPanel } from '@/components/super-admin/AlertsPanel';

export function SuperAdminDashboard() {
  const { stats, isLoading: statsLoading } = useSuperAdminStats();
  const { tenants, isLoading: tenantsLoading } = useRecentTenants(5);
  const { overview, isLoading: billingLoading } = useBillingOverview();
  
  return (
    <div className="p-6 space-y-6">
      <h1 className="text-3xl font-bold">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h1>
      
      {/* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm text-muted-foreground">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold">{stats?.totalTenants || 0}</div>
            <p className="text-xs text-green-500">+{stats?.newTenantsThisMonth || 0} Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm text-muted-foreground">Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold">{stats?.activeTenants || 0}</div>
            <p className="text-xs text-muted-foreground">
              {stats?.trialTenants || 0} ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm text-muted-foreground">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold">
              {overview?.monthlyRevenue?.toLocaleString()} Ø±.Ø³
            </div>
            <p className="text-xs text-green-500">
              +{overview?.revenueGrowth || 0}% Ø¹Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
            </p>
          </CardContent>
        </Card>
        
        <Card>
          <CardHeader className="pb-2">
            <CardTitle className="text-sm text-muted-foreground">Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-red-500">
              {overview?.overdueInvoices || 0}
            </div>
            <p className="text-xs text-muted-foreground">
              {overview?.overdueAmount?.toLocaleString()} Ø±.Ø³
            </p>
          </CardContent>
        </Card>
      </div>
      
      {/* Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2">
          <Card>
            <CardHeader>
              <CardTitle>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</CardTitle>
            </CardHeader>
            <CardContent>
              <RevenueChart />
            </CardContent>
          </Card>
        </div>
        
        <Card>
          <CardHeader>
            <CardTitle>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</CardTitle>
          </CardHeader>
          <CardContent>
            <AlertsPanel />
          </CardContent>
        </Card>
      </div>
      
      {/* ØµØ­Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† */}
      <Card>
        <CardHeader>
          <CardTitle>ØµØ­Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</CardTitle>
        </CardHeader>
        <CardContent>
          <TenantHealthOverview />
        </CardContent>
      </Card>
    </div>
  );
}
```

## 9.3 Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†

```typescript
// src/pages/super-admin/TenantsListPage.tsx

import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAllTenants } from '@/hooks/super-admin/useAllTenants';
import { DataTable } from '@/components/ui/data-table';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { 
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { MoreHorizontal, Plus, Search } from 'lucide-react';

export function TenantsListPage() {
  const [search, setSearch] = useState('');
  const [statusFilter, setStatusFilter] = useState<string | null>(null);
  const navigate = useNavigate();
  
  const { tenants, isLoading } = useAllTenants({
    search,
    status: statusFilter,
  });
  
  const columns = [
    {
      accessorKey: 'name_ar',
      header: 'Ø§Ø³Ù… Ø§Ù„ÙˆÙ‚Ù',
      cell: ({ row }) => (
        <div className="flex items-center gap-3">
          {row.original.logo_url && (
            <img 
              src={row.original.logo_url} 
              alt={row.original.name} 
              className="h-8 w-8 rounded-full"
            />
          )}
          <div>
            <div className="font-medium">{row.original.name_ar || row.original.name}</div>
            <div className="text-sm text-muted-foreground">{row.original.slug}</div>
          </div>
        </div>
      ),
    },
    {
      accessorKey: 'owner_email',
      header: 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
    },
    {
      accessorKey: 'plan',
      header: 'Ø§Ù„Ø®Ø·Ø©',
      cell: ({ row }) => (
        <Badge variant="outline">{row.original.plan?.name_ar || 'Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø©'}</Badge>
      ),
    },
    {
      accessorKey: 'subscription_status',
      header: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
      cell: ({ row }) => {
        const statusMap = {
          trial: { label: 'ØªØ¬Ø±ÙŠØ¨ÙŠ', variant: 'secondary' },
          active: { label: 'Ù†Ø´Ø·', variant: 'success' },
          suspended: { label: 'Ù…Ø¹Ù„Ù‚', variant: 'warning' },
          cancelled: { label: 'Ù…Ù„ØºÙŠ', variant: 'destructive' },
          expired: { label: 'Ù…Ù†ØªÙ‡ÙŠ', variant: 'destructive' },
        };
        const status = statusMap[row.original.subscription_status] || { label: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ', variant: 'secondary' };
        return <Badge variant={status.variant as any}>{status.label}</Badge>;
      },
    },
    {
      accessorKey: 'stats',
      header: 'Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…',
      cell: ({ row }) => (
        <div className="text-sm">
          <div>{row.original.current_beneficiaries}/{row.original.max_beneficiaries} Ù…Ø³ØªÙÙŠØ¯</div>
          <div className="text-muted-foreground">
            {row.original.current_properties}/{row.original.max_properties} Ø¹Ù‚Ø§Ø±
          </div>
        </div>
      ),
    },
    {
      accessorKey: 'created_at',
      header: 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
      cell: ({ row }) => new Date(row.original.created_at).toLocaleDateString('ar-SA'),
    },
    {
      id: 'actions',
      cell: ({ row }) => (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon">
              <MoreHorizontal className="h-4 w-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => navigate(`/super-admin/tenants/${row.original.id}`)}>
              Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => window.open(`/${row.original.slug}`, '_blank')}>
              ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            </DropdownMenuItem>
            <DropdownMenuItem>ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ø·Ø©</DropdownMenuItem>
            <DropdownMenuItem className="text-red-500">ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      ),
    },
  ];
  
  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h1>
        <Button onClick={() => navigate('/super-admin/tenants/new')}>
          <Plus className="h-4 w-4 ml-2" />
          Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ
        </Button>
      </div>
      
      <div className="flex items-center gap-4">
        <div className="relative flex-1 max-w-sm">
          <Search className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder="Ø¨Ø­Ø«..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pr-10"
          />
        </div>
        
        <select
          value={statusFilter || ''}
          onChange={(e) => setStatusFilter(e.target.value || null)}
          className="border rounded-md px-3 py-2"
        >
          <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ</option>
          <option value="active">Ù†Ø´Ø·</option>
          <option value="suspended">Ù…Ø¹Ù„Ù‚</option>
          <option value="expired">Ù…Ù†ØªÙ‡ÙŠ</option>
        </select>
      </div>
      
      <DataTable columns={columns} data={tenants || []} isLoading={isLoading} />
    </div>
  );
}
```

---

# 10. Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ù„ÙÙŠ

## 10.1 Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù…Ù„Ø®Øµ)

```
src/
â”œâ”€â”€ contexts/
â”‚   â””â”€â”€ TenantContext.tsx                    # Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
â”‚
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ TenantMiddleware.tsx                 # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø´ØªØ±Ùƒ
â”‚   â””â”€â”€ SuperAdminMiddleware.tsx             # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Super Admin
â”‚
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ tenant/
â”‚       â”œâ”€â”€ index.ts                         # ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ hooks
â”‚       â”œâ”€â”€ useTenant.ts                     # Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ
â”‚       â”œâ”€â”€ useTenantBySlug.ts               # Ø¬Ù„Ø¨ Ù…Ø´ØªØ±Ùƒ Ø¨Ø§Ù„Ù€ slug
â”‚       â”œâ”€â”€ useTenantUsers.ts                # Ù…Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
â”‚       â”œâ”€â”€ useTenantSettings.ts             # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ
â”‚       â”œâ”€â”€ useTenantLimits.ts               # Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø·Ø©
â”‚       â”œâ”€â”€ useTenantRealtime.ts             # Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Realtime
â”‚       â”œâ”€â”€ useCanAddResource.ts             # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯
â”‚       â””â”€â”€ useTenantHealth.ts               # ØµØ­Ø© Ø§Ù„Ù…Ø´ØªØ±Ùƒ
â”‚   â””â”€â”€ super-admin/
â”‚       â”œâ”€â”€ index.ts
â”‚       â”œâ”€â”€ useAllTenants.ts                 # Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
â”‚       â”œâ”€â”€ useTenantDetails.ts              # ØªÙØ§ØµÙŠÙ„ Ù…Ø´ØªØ±Ùƒ
â”‚       â”œâ”€â”€ useSuperAdminStats.ts            # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©
â”‚       â”œâ”€â”€ useBillingOverview.ts            # Ù…Ù„Ø®Øµ Ø§Ù„ÙÙˆØªØ±Ø©
â”‚       â””â”€â”€ useRecentTenants.ts              # Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ tenant.service.ts                    # Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
â”‚   â”œâ”€â”€ subscription.service.ts              # Ø®Ø¯Ù…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
â”‚   â”œâ”€â”€ billing.service.ts                   # Ø®Ø¯Ù…Ø© Ø§Ù„ÙÙˆØªØ±Ø©
â”‚   â”œâ”€â”€ super-admin.service.ts               # Ø®Ø¯Ù…Ø© Super Admin
â”‚   â””â”€â”€ tenant-health.service.ts             # Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
â”‚
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â”œâ”€â”€ LandingPage.tsx                  # Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
â”‚   â”‚   â”œâ”€â”€ PricingPage.tsx                  # Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
â”‚   â”‚   â””â”€â”€ RegisterPage.tsx                 # Ø§Ù„ØªØ³Ø¬ÙŠÙ„
â”‚   â”œâ”€â”€ super-admin/
â”‚   â”‚   â”œâ”€â”€ SuperAdminDashboard.tsx          # Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
â”‚   â”‚   â”œâ”€â”€ TenantsListPage.tsx              # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
â”‚   â”‚   â”œâ”€â”€ TenantDetailsPage.tsx            # ØªÙØ§ØµÙŠÙ„ Ù…Ø´ØªØ±Ùƒ
â”‚   â”‚   â”œâ”€â”€ PlansManagementPage.tsx          # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø·Ø·
â”‚   â”‚   â”œâ”€â”€ BillingPage.tsx                  # Ø§Ù„ÙÙˆØ§ØªÙŠØ±
â”‚   â”‚   â”œâ”€â”€ AnalyticsPage.tsx                # Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
â”‚   â”‚   â””â”€â”€ SuperAdminSettingsPage.tsx       # Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
â”‚   â””â”€â”€ errors/
â”‚       â”œâ”€â”€ TenantNotFoundPage.tsx           # Ø§Ù„Ù…Ø´ØªØ±Ùƒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
â”‚       â”œâ”€â”€ TenantSuspendedPage.tsx          # Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ù…Ø¹Ù„Ù‚
â”‚       â”œâ”€â”€ TenantExpiredPage.tsx            # Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ
â”‚       â””â”€â”€ UnauthorizedPage.tsx             # ØºÙŠØ± Ù…ØµØ±Ø­
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ tenant/
â”‚   â”‚   â”œâ”€â”€ TenantSwitcher.tsx               # ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
â”‚   â”‚   â”œâ”€â”€ PlanLimitWarning.tsx             # ØªØ­Ø°ÙŠØ± Ø§Ù„Ø­Ø¯ÙˆØ¯
â”‚   â”‚   â”œâ”€â”€ SubscriptionCard.tsx             # Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
â”‚   â”‚   â””â”€â”€ TenantLogo.tsx                   # Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø´ØªØ±Ùƒ
â”‚   â””â”€â”€ super-admin/
â”‚       â”œâ”€â”€ TenantHealthOverview.tsx         # ØµØ­Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
â”‚       â”œâ”€â”€ RevenueChart.tsx                 # Ù…Ø®Ø·Ø· Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
â”‚       â”œâ”€â”€ AlertsPanel.tsx                  # Ù„ÙˆØ­Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
â”‚       â”œâ”€â”€ TenantActionsDropdown.tsx        # Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø´ØªØ±Ùƒ
â”‚       â””â”€â”€ PlanComparisonTable.tsx          # Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø®Ø·Ø·
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ query-keys-tenant.ts                 # Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
â”‚   â”œâ”€â”€ query-config-tenant.ts               # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†
â”‚   â””â”€â”€ tenant-utils.ts                      # Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
â”‚
â””â”€â”€ types/
    â””â”€â”€ tenant.ts                            # Ø£Ù†ÙˆØ§Ø¹ TypeScript

supabase/
â””â”€â”€ functions/
    â”œâ”€â”€ stripe-webhook/
    â”‚   â””â”€â”€ index.ts                         # Webhook Ù„Ù€ Stripe
    â”œâ”€â”€ create-checkout-session/
    â”‚   â””â”€â”€ index.ts                         # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø¯ÙØ¹
    â”œâ”€â”€ create-billing-portal/
    â”‚   â””â”€â”€ index.ts                         # Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ÙÙˆØªØ±Ø©
    â”œâ”€â”€ tenant-health-check/
    â”‚   â””â”€â”€ index.ts                         # ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
    â””â”€â”€ tenant-cleanup/
        â””â”€â”€ index.ts                         # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†
```

## 10.2 Ù…Ù„Ø®Øµ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª

| Ø§Ù„Ù†ÙˆØ¹ | Ø§Ù„Ø¹Ø¯Ø¯ |
|-------|-------|
| Contexts | 1 |
| Middleware | 2 |
| Hooks (tenant) | 9 |
| Hooks (super-admin) | 6 |
| Services | 5 |
| Pages (public) | 3 |
| Pages (super-admin) | 7 |
| Pages (errors) | 4 |
| Components (tenant) | 4 |
| Components (super-admin) | 5 |
| Lib utilities | 3 |
| Types | 1 |
| Edge Functions | 5 |
| **Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ** | **~55 Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯** |

---

# 11. Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ

## 11.1 Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ (4 Ø£Ø³Ø§Ø¨ÙŠØ¹)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1: Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ©                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                               â”‚
â”‚  â”œâ”€â”€ ÙŠÙˆÙ… 1-2: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©                                    â”‚
â”‚  â”‚   â€¢ tenants, subscription_plans, tenant_users                       â”‚
â”‚  â”‚   â€¢ tenant_settings, tenant_billing                                 â”‚
â”‚  â”‚                                                                      â”‚
â”‚  â”œâ”€â”€ ÙŠÙˆÙ… 3-4: Ø¥Ø¶Ø§ÙØ© tenant_id Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©                         â”‚
â”‚  â”‚   â€¢ migrations Ù„Ù„Ù€ 50+ Ø¬Ø¯ÙˆÙ„                                         â”‚
â”‚  â”‚   â€¢ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙ‡Ø§Ø±Ø³ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©                                           â”‚
â”‚  â”‚                                                                      â”‚
â”‚  â””â”€â”€ ÙŠÙˆÙ… 5: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©                                      â”‚
â”‚      â€¢ get_user_tenant_id()                                            â”‚
â”‚      â€¢ user_belongs_to_tenant()                                        â”‚
â”‚      â€¢ is_super_admin()                                                â”‚
â”‚      â€¢ check_tenant_limit()                                            â”‚
â”‚                                                                         â”‚
â”‚  Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 2: Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                              â”‚
â”‚  â”œâ”€â”€ ÙŠÙˆÙ… 1-2: ØªØ­Ø¯ÙŠØ« Ø³ÙŠØ§Ø³Ø§Øª RLS                                         â”‚
â”‚  â”‚   â€¢ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ù…ÙˆØ­Ø¯ Ø¹Ù„Ù‰ 724 Ø³ÙŠØ§Ø³Ø©                                â”‚
â”‚  â”‚   â€¢ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ø²Ù„                                                    â”‚
â”‚  â”‚                                                                      â”‚
â”‚  â”œâ”€â”€ ÙŠÙˆÙ… 3: Ø¥Ù†Ø´Ø§Ø¡ Contexts Ùˆ Middleware                                â”‚
â”‚  â”‚   â€¢ TenantContext                                                   â”‚
â”‚  â”‚   â€¢ TenantMiddleware                                                â”‚
â”‚  â”‚   â€¢ SuperAdminMiddleware                                            â”‚
â”‚  â”‚                                                                      â”‚
â”‚  â”œâ”€â”€ ÙŠÙˆÙ… 4: ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆØ¬ÙŠÙ‡                                              â”‚
â”‚  â”‚   â€¢ ØªØ¹Ø¯ÙŠÙ„ App.tsx                                                   â”‚
â”‚  â”‚   â€¢ Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø·Ø§Ø¡                                             â”‚
â”‚  â”‚                                                                      â”‚
â”‚  â””â”€â”€ ÙŠÙˆÙ… 5: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆØ§Ù„Ù€ Hooks                                   â”‚
â”‚      â€¢ Ø¥Ø¶Ø§ÙØ© tenantId Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª                                    â”‚
â”‚      â€¢ ØªØ­Ø¯ÙŠØ« Ù…ÙØ§ØªÙŠØ­ React Query                                        â”‚
â”‚                                                                         â”‚
â”‚  Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 3: Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„ÙÙˆØªØ±Ø©                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                           â”‚
â”‚  â”œâ”€â”€ ÙŠÙˆÙ… 1-2: ØªÙƒØ§Ù…Ù„ Stripe                                             â”‚
â”‚  â”‚   â€¢ Ø¥Ù†Ø´Ø§Ø¡ Edge Functions                                            â”‚
â”‚  â”‚   â€¢ webhook Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«                                          â”‚
â”‚  â”‚                                                                      â”‚
â”‚  â”œâ”€â”€ ÙŠÙˆÙ… 3: Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ                                             â”‚
â”‚  â”‚   â€¢ SubscriptionService                                             â”‚
â”‚  â”‚   â€¢ BillingService                                                  â”‚
â”‚  â”‚                                                                      â”‚
â”‚  â””â”€â”€ ÙŠÙˆÙ… 4-5: ØµÙØ­Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ                                           â”‚
â”‚      â€¢ PricingPage                                                     â”‚
â”‚      â€¢ RegisterPage (Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø·Ø©)                                  â”‚
â”‚      â€¢ ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ                                             â”‚
â”‚                                                                         â”‚
â”‚  Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 4: Super Admin ÙˆØ§Ù„Ø§Ø®ØªØ¨Ø§Ø±                                       â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                       â”‚
â”‚  â”œâ”€â”€ ÙŠÙˆÙ… 1-2: Ù„ÙˆØ­Ø© Super Admin                                         â”‚
â”‚  â”‚   â€¢ SuperAdminDashboard                                             â”‚
â”‚  â”‚   â€¢ TenantsListPage                                                 â”‚
â”‚  â”‚   â€¢ TenantDetailsPage                                               â”‚
â”‚  â”‚                                                                      â”‚
â”‚  â”œâ”€â”€ ÙŠÙˆÙ… 3: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø·Ø· ÙˆØ§Ù„ÙÙˆØªØ±Ø©                                       â”‚
â”‚  â”‚   â€¢ PlansManagementPage                                             â”‚
â”‚  â”‚   â€¢ BillingPage                                                     â”‚
â”‚  â”‚                                                                      â”‚
â”‚  â””â”€â”€ ÙŠÙˆÙ… 4-5: Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚                                        â”‚
â”‚      â€¢ Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù„Ù„Ø¹Ø²Ù„                                               â”‚
â”‚      â€¢ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡                                                   â”‚
â”‚      â€¢ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù†Ø´Ø±                                                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# 12. Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„Ø¬ÙˆØ¯Ø©

## 12.1 Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø²Ù„

```typescript
// tests/tenant-isolation.test.ts

describe('Tenant Isolation Tests', () => {
  const tenant1 = { id: 'tenant-1', slug: 'waqf-ahmed' };
  const tenant2 = { id: 'tenant-2', slug: 'waqf-mohammed' };
  
  test('User from tenant1 cannot see tenant2 beneficiaries', async () => {
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ù…Ù† tenant1
    await loginAs(tenant1.userId);
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ù…Ø³ØªÙÙŠØ¯ÙŠ tenant2
    const { data, error } = await supabase
      .from('beneficiaries')
      .select('*')
      .eq('tenant_id', tenant2.id);
    
    // ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙØ§Ø±ØºØ© Ø¨Ø³Ø¨Ø¨ RLS
    expect(data).toHaveLength(0);
  });
  
  test('User cannot insert data for another tenant', async () => {
    await loginAs(tenant1.userId);
    
    const { error } = await supabase
      .from('beneficiaries')
      .insert({
        tenant_id: tenant2.id,  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ù„Ù…Ø´ØªØ±Ùƒ Ø¢Ø®Ø±
        full_name: 'Test',
        // ...
      });
    
    expect(error).not.toBeNull();
    expect(error.code).toBe('42501');  // RLS violation
  });
  
  test('Super Admin can see all tenants data', async () => {
    await loginAsSuperAdmin();
    
    const { data } = await supabase
      .from('beneficiaries')
      .select('tenant_id');
    
    const uniqueTenants = [...new Set(data.map(d => d.tenant_id))];
    expect(uniqueTenants.length).toBeGreaterThan(1);
  });
});
```

## 12.2 Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡

```typescript
// tests/performance.test.ts

describe('Performance Tests', () => {
  test('Query with tenant_id index should be fast', async () => {
    const start = performance.now();
    
    await supabase
      .from('beneficiaries')
      .select('*')
      .eq('tenant_id', 'test-tenant-id')
      .limit(100);
    
    const duration = performance.now() - start;
    
    // ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 100ms
    expect(duration).toBeLessThan(100);
  });
  
  test('Dashboard KPIs should load within 2 seconds', async () => {
    const start = performance.now();
    
    await Promise.all([
      supabase.from('beneficiaries').select('count', { count: 'exact' }),
      supabase.from('properties').select('count', { count: 'exact' }),
      supabase.from('contracts').select('count', { count: 'exact' }),
    ]);
    
    const duration = performance.now() - start;
    expect(duration).toBeLessThan(2000);
  });
});
```

---

# 13. Ø§Ù„Ù†Ø´Ø± ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©

## 13.1 Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù†Ø´Ø±

```
1. Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
2. ØªÙ†ÙÙŠØ° migrations Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨:
   a. 001_create_tenant_tables.sql
   b. 002_add_tenant_id_columns.sql
   c. 003_create_tenant_functions.sql
   d. 004_apply_tenant_rls.sql
   e. 005_create_indexes.sql

3. ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:
   - Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´ØªØ±Ùƒ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
   - ØªØ¹ÙŠÙŠÙ† tenant_id Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©

4. Ù†Ø´Ø± Edge Functions:
   - stripe-webhook
   - create-checkout-session
   - create-billing-portal

5. ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Stripe:
   - Ø¥Ø¶Ø§ÙØ© webhook URL
   - Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±

6. Ù†Ø´Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©

7. Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬
```

## 13.2 Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©

```typescript
// Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø¯ÙˆØ±ÙŠØ©

// 1. ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† - ÙƒÙ„ Ø³Ø§Ø¹Ø©
cron('0 * * * *', async () => {
  await TenantHealthService.checkAllTenants();
});

// 2. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© - ÙŠÙˆÙ…ÙŠØ§Ù‹
cron('0 3 * * *', async () => {
  await cleanupExpiredSessions();
});

// 3. ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ù‚Ø±ÙŠØ¨Ø§Ù‹ - ÙŠÙˆÙ…ÙŠØ§Ù‹
cron('0 9 * * *', async () => {
  await notifyExpiringSubscriptions(7); // 7 Ø£ÙŠØ§Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
});

// 4. ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª - Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹
cron('0 10 * * 1', async () => {
  await generateWeeklyRevenueReport();
});
```

---

# Ù…Ù„Ø­Ù‚: Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ©

| Ø§Ù„Ù‚Ø±Ø§Ø± | Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª | Ø§Ù„Ù…Ø®ØªØ§Ø± | Ø§Ù„Ø³Ø¨Ø¨ |
|--------|----------|---------|-------|
| Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ø²Ù„ | Multi-DB / Schema / Row | Row (RLS) | ØªÙƒÙ„ÙØ© Ø£Ù‚Ù„ØŒ ØµÙŠØ§Ù†Ø© Ø£Ø³Ù‡Ù„ |
| Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ | Subdomain / Path | Path | Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Lovable |
| Ø§Ù„ÙÙˆØªØ±Ø© | Stripe / Paddle / Custom | Stripe | Ù…ÙˆØ«ÙˆÙ‚ØŒ API Ù‚ÙˆÙŠ |
| Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª | Redis / React Query | React Query | ÙƒØ§ÙÙØŒ Ø£Ø³Ù‡Ù„ |
| Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© | Custom / External | Custom | Ù…ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… |

---

**Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©**

Ø§Ù„Ø¥ØµØ¯Ø§Ø±: 1.0.0
Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: 2025-12-10
