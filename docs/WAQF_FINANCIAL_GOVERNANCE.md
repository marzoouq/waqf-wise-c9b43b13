# ๐ ูุซููุฉ ุญูููุฉ ุงูููู ุงููุงูู
# Waqf Financial Governance Document

> **ุงูุฅุตุฏุงุฑ:** 3.4.0  
> **ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 2026-01-20  
> **ุงููุณุคูู:** ูุงุธุฑ ุงูููู

---

## ุงููุญุชููุงุช

1. [ูููู ุงูููุงูุฉ ูุงูุตูุงุญูุงุช](#1-ูููู-ุงูููุงูุฉ-ูุงูุตูุงุญูุงุช)
2. [ููุงุนุฏ ูุตู ุงูููุงูุฉ](#2-ููุงุนุฏ-ูุตู-ุงูููุงูุฉ)
3. [ุณูุงุณุฉ ุนุฏู ุงูุญุฐู](#3-ุณูุงุณุฉ-ุนุฏู-ุงูุญุฐู)
4. [ุณูุงุณุฉ ุงูุฎุชู ุงูุฒููู](#4-ุณูุงุณุฉ-ุงูุฎุชู-ุงูุฒููู)
5. [ุณูุงุณุฉ ุณุฌู ุงูุชุฏููู](#5-ุณูุงุณุฉ-ุณุฌู-ุงูุชุฏููู)
6. [ุงูุญุฏูุฏ ุงููุงููุฉ](#6-ุงูุญุฏูุฏ-ุงููุงููุฉ)
7. [ุฅุฌุฑุงุกุงุช ุงูุชุฏููู](#7-ุฅุฌุฑุงุกุงุช-ุงูุชุฏููู)

---

## 1. ูููู ุงูููุงูุฉ ูุงูุตูุงุญูุงุช

### 1.1 ุงูุฃุฏูุงุฑ ูุงููุณุคูููุงุช

| ุงูุฏูุฑ | ุงูุตูุงุญูุฉ ุงูุฑุฆูุณูุฉ | ุงูุญุฏ ุงููุงูู | ุงูููุงููุฉ ุงููุทููุจุฉ |
|-------|------------------|-------------|-------------------|
| **ูุงุธุฑ ุงูููู** | ุงูููุงููุฉ ุงูููุงุฆูุฉ ูุงูุฅุดุฑุงู | ุบูุฑ ูุญุฏูุฏ | - |
| **ุงููุญุงุณุจ** | ุฅูุดุงุก ุงููููุฏ ูุงูุชูุงุฑูุฑ | โค 50,000 ุฑ.ุณ | ูุงุธุฑ ูููุจุงูุบ ุงูุฃุนูู |
| **ุงูุตุฑุงู** | ุชูููุฐ ุงููุฏููุนุงุช ูุงูุชุญุตูู | โค 10,000 ุฑ.ุณ | ูุญุงุณุจ/ูุงุธุฑ ูููุจุงูุบ ุงูุฃุนูู |
| **ุฃููู ุงูุฃุฑุดูู** | ุฅุฏุงุฑุฉ ุงููุณุชูุฏุงุช ูุงููุซุงุฆู | - | - |
| **ุงููุณุชููุฏ** | ุนุฑุถ ุจูุงูุงุชู ููุท | - | - |
| **ุงููุณุชุฃุฌุฑ** | ุนุฑุถ ุนููุฏู ูุณุฏุงุฏ ุงูุฅูุฌุงุฑ | - | - |

### 1.2 ูุตูููุฉ ุงูุตูุงุญูุงุช

```
                    ุฅูุดุงุก    ุนุฑุถ     ุชุนุฏูู    ููุงููุฉ   ุญุฐู ููู
ุณูุฏุงุช ุงูุตุฑู          โ      โ       โ       โ       โ
ุงููููุฏ ุงููุญุงุณุจูุฉ      โ      โ       โ       โ       โ
ุงูุชูุฒูุนุงุช             โ      โ       โ       โ       โ
ุงูุนููุฏ               โ      โ       โ       โ       โ
ุณุฌูุงุช ุงูุชุฏููู        โ      โ       โ       โ       โ
```

---

## 2. ููุงุนุฏ ูุตู ุงูููุงูุฉ (Dual Control)

### 2.1 ุงููุจุฏุฃ ุงูุฃุณุงุณู

> **"ูู ููุดุฆ โ ูู ูุนุชูุฏ โ ูู ูููุฐ"**

ูุง ูุฌูุฒ ูุฃู ุดุฎุต ุฅุชูุงู ุฏูุฑุฉ ูุงููุฉ ูุงููุฉ ุจููุฑุฏู.

### 2.2 ุงูุญุฏูุฏ ุงููุงููุฉ ูููุตู

| ููุน ุงูุนูููุฉ | ุงูุญุฏ ุงูุฃุฏูู ูููุตู | ุงููุนุชูุฏ ุงููุทููุจ |
|------------|-------------------|-----------------|
| ุณูุฏุงุช ุงูุตุฑู | > 10,000 ุฑ.ุณ | ุดุฎุต ูุฎุชูู ุนู ุงูููุดุฆ |
| ุงูุชูุฒูุนุงุช | > 50,000 ุฑ.ุณ | ุงููุงุธุฑ |
| ุงูุชุญูููุงุช ุงูุจูููุฉ | > 10,000 ุฑ.ุณ | ูุญุงุณุจ + ูุงุธุฑ |

### 2.3 ุงูุชุทุจูู ุงูุชููู

```sql
-- ููููููุฐ ุชููุงุฆูุงู ุนุจุฑ trigger: enforce_dual_control
IF NEW.approved_by = NEW.created_by THEN
  RAISE EXCEPTION 'ุงููุจุงูุบ ุงููุจูุฑุฉ ุชุชุทูุจ ููุงููุฉ ูู ุดุฎุต ูุฎุชูู';
END IF;
```

---

## 3. ุณูุงุณุฉ ุนุฏู ุงูุญุฐู (No Physical Delete)

### 3.1 ุงููุจุฏุฃ ุงูุดุฑุนู

> **"ูุง ูุฌูุฒ ุฅุณูุงุท ุงูุญู"**

ุงูุญุฐู ุงูููุฒูุงุฆู ููุณุฌูุงุช ุงููุงููุฉ ููููุน ููุนุงู ุจุงุชุงู ูู ูุธุงู ุงูููู.

### 3.2 ุงูุฌุฏุงูู ุงููุญููุฉ

| ุงูุฌุฏูู | ุงูุญูุงูุฉ | ุงูุจุฏูู |
|--------|---------|--------|
| `payment_vouchers` | โ Trigger | Soft Delete |
| `journal_entries` | โ Trigger | Soft Delete |
| `distributions` | โ Trigger | Soft Delete |
| `contracts` | โ Trigger | Soft Delete |
| `loans` | โ Trigger | Soft Delete |
| `rental_payments` | โ Trigger | Soft Delete |
| `invoices` | โ Trigger | Soft Delete |
| `audit_logs` | โ Trigger | ูุง ุญุฐู |

### 3.3 ุขููุฉ ุงูุญุฐู ุงูููู

```typescript
// ุงูุทุฑููุฉ ุงูุตุญูุญุฉ ููุญุฐู
await supabase
  .from('payment_vouchers')
  .update({ 
    deleted_at: new Date().toISOString(),
    deleted_by: userId,
    deletion_reason: 'ุณุจุจ ุงูุญุฐู'
  })
  .eq('id', voucherId);
```

### 3.4 ุฑุณุงูุฉ ุงูุฎุทุฃ

ุนูุฏ ูุญุงููุฉ ุงูุญุฐู ุงูููุฒูุงุฆู:
```
ุงูุญุฐู ุงูููุฒูุงุฆู ููููุน ูู ูุธุงู ุงูููู ุงููุงูู. 
ุงุณุชุฎุฏู soft delete ุจุชุญุฏูุซ deleted_at ุจุฏูุงู ูู ุฐูู.
```

---

## 4. ุณูุงุณุฉ ุงูุฎุชู ุงูุฒููู (Immutable Timestamps)

### 4.1 ุงููุจุฏุฃ

> **"ุงูุฃูุงูุฉ ุงูุฒูููุฉ: ูุง ูุงู ุตุญูุญุงู ูู ุฒููู ูุฌุจ ุฃู ูุจูู ูุงุจูุงู ููุฅุซุจุงุช"**

### 4.2 ุงูุญููู ุงููุญููุฉ

- `created_at` - ุชุงุฑูุฎ ุงูุฅูุดุงุก (ุบูุฑ ูุงุจู ููุชุนุฏูู)
- `posted_at` - ุชุงุฑูุฎ ุงูุชุฑุญูู
- `approved_at` - ุชุงุฑูุฎ ุงูููุงููุฉ

### 4.3 ุงูุชุทุจูู

```sql
-- ููููููุฐ ุชููุงุฆูุงู ุนุจุฑ trigger: protect_created_at
IF NEW.created_at IS DISTINCT FROM OLD.created_at THEN
  RAISE EXCEPTION 'ุชุนุฏูู created_at ููููุน';
END IF;
```

---

## 5. ุณูุงุณุฉ ุณุฌู ุงูุชุฏููู (Immutable Audit Trail)

### 5.1 ุงููุจุฏุฃ

> **"ูู ุนูููุฉ ุชูุณุฌูููุ ููุง ุณุฌู ูููุญู"**

### 5.2 ุฎุตุงุฆุต ุงูุณุฌู

| ุงูุฎุงุตูุฉ | ุงููููุฉ |
|---------|--------|
| INSERT | โ ูุณููุญ |
| SELECT | โ ูุณููุญ |
| UPDATE | โ ููููุน |
| DELETE | โ ููููุน |
| ุงูุงุญุชูุงุธ | ุฏุงุฆู (99 ุณูุฉ) |

### 5.3 ุงูุจูุงูุงุช ุงููุณุฌูุฉ

```json
{
  "action_type": "ููุน ุงูุนูููุฉ (INSERT/UPDATE/DELETE)",
  "table_name": "ุงุณู ุงูุฌุฏูู",
  "record_id": "ูุนุฑู ุงูุณุฌู",
  "old_values": "ุงูููู ุงููุฏููุฉ (ููุชุนุฏูู/ุงูุญุฐู)",
  "new_values": "ุงูููู ุงูุฌุฏูุฏุฉ (ููุฅูุดุงุก/ุงูุชุนุฏูู)",
  "user_id": "ูุนุฑู ุงููุณุชุฎุฏู",
  "user_email": "ุจุฑูุฏ ุงููุณุชุฎุฏู",
  "ip_address": "ุนููุงู IP",
  "created_at": "ุงูุฎุชู ุงูุฒููู"
}
```

### 5.4 ุนุฏุฏ Triggers ุงูุชู ุชุบุฐู ุงูุณุฌู

**270+ Trigger** ุชุนูู ุชููุงุฆูุงู ูุชุณุฌูู ุฌููุน ุงูุนูููุงุช.

---

## 6. ุงูุญุฏูุฏ ุงููุงููุฉ

### 6.1 ุฌุฏูู ุงูุญุฏูุฏ

| ููุน ุงูุญุฏ | ุงููููุฉ | ุงูุฅุฌุฑุงุก |
|----------|--------|---------|
| ุญุฏ ุงูุตุฑุงู | 10,000 ุฑ.ุณ | ูุชุทูุจ ููุงููุฉ ุฃุนูู |
| ุญุฏ ุงููุญุงุณุจ | 50,000 ุฑ.ุณ | ูุชุทูุจ ููุงููุฉ ุงููุงุธุฑ |
| ุญุฏ ุงูุชูุฒูุน | 50,000 ุฑ.ุณ | ูุชุทูุจ ููุงููุงุช ูุชุนุฏุฏุฉ |

### 6.2 ุชุฎุฒูู ุงูุฅุนุฏุงุฏุงุช

ุงูุญุฏูุฏ ูุฎุฒูุฉ ูู ุฌุฏูู `waqf_governance_config`:

```sql
SELECT config_key, config_value 
FROM waqf_governance_config;

-- ุงููุชูุฌุฉ:
-- dual_control_threshold_voucher: {"amount": 10000, "currency": "SAR"}
-- dual_control_threshold_distribution: {"amount": 50000, "currency": "SAR"}
-- audit_retention_years: {"years": 99}
-- soft_delete_enabled: {"enabled": true}
```

---

## 7. ุฅุฌุฑุงุกุงุช ุงูุชุฏููู

### 7.1 ุงูุชุฏููู ุงูุฏุงุฎูู

- **ุงูุฏูุฑูุฉ:** ุดูุฑูุงู
- **ุงููุณุคูู:** ุงููุญุงุณุจ
- **ุงููุทุงู:** ูุทุงุจูุฉ ุงูุฃุฑุตุฏุฉุ ูุญุต ุงููููุฏ

### 7.2 ุงูุชุฏููู ุงูุฎุงุฑุฌู

- **ุงูุฏูุฑูุฉ:** ุณูููุงู
- **ุงูุฌูุฉ:** ูุฏูู ุฎุงุฑุฌู ูุนุชูุฏ
- **ุงูุชูุงุฑูุฑ ุงููุทููุจุฉ:**
  - ููุฒุงู ุงููุฑุงุฌุนุฉ
  - ูุงุฆูุฉ ุงูุฏุฎู
  - ูุงุฆูุฉ ุงููุฑูุฒ ุงููุงูู
  - ุชูุฑูุฑ ุงูุชูุฒูุนุงุช
  - ุณุฌู ุงูุชุฏููู ุงููุงูู

### 7.3 ุงูุชุฏููู ุงูุดุฑุนู

- **ุงูุฏูุฑูุฉ:** ุณูููุงู
- **ุงูุฌูุฉ:** ูุฌูุฉ ุงูุฑูุงุจุฉ ุงูุดุฑุนูุฉ
- **ุงููุทุงู:**
  - ุงูุชุญูู ูู ูุณุจ ุงูุชูุฒูุน
  - ูุทุงุจูุฉ ุงูุดุฑูุท ุงูููููุฉ
  - ูุญุต ุงุณุชุซูุงุฑ ุงูุฃููุงู

---

## 8. ุงูุฏูุงู ุงููุญููุฉ

### 8.1 ูุงุฆูุฉ ุงูุฏูุงู ุงูุญุฑุฌุฉ

| ุงูุฏุงูุฉ | ุงููุธููุฉ | ุงูุญูุงูุฉ |
|--------|---------|---------|
| `prevent_hard_delete_financial()` | ููุน ุงูุญุฐู ุงูููุฒูุงุฆู | SECURITY DEFINER |
| `protect_created_at()` | ุญูุงูุฉ ุงูุฎุชู ุงูุฒููู | SECURITY DEFINER |
| `enforce_dual_control()` | ูุตู ุงูููุงูุฉ | SECURITY DEFINER |
| `immutable_audit_logs()` | ุญูุงูุฉ ุณุฌู ุงูุชุฏููู | SECURITY DEFINER |
| `is_nazer_or_admin()` | ูุญุต ุงูุตูุงุญูุฉ | SECURITY DEFINER |

---

## 9. ุงูุงูุชุซุงู ูุงููุนุงููุฑ

### 9.1 ุงููุนุงููุฑ ุงููุทุจูุฉ

- โ ูุธุงู ุงูููู ุงูุณุนูุฏู
- โ ูุนุงููุฑ ุงููุญุงุณุจุฉ AAOIFI
- โ ูุชุทูุจุงุช ZATCA (ุงูุฒูุงุฉ)
- โ ููุงุนุฏ SOX ููุฑูุงุจุฉ ุงูุฏุงุฎููุฉ

### 9.2 ุดูุงุฏุฉ ุงูุงูุชุซุงู

| ุงููุญูุฑ | ุงููุณุจุฉ |
|--------|--------|
| ุงููุฒุงูุฉ ุงูุดุฑุนูุฉ | 97% |
| ุงูุฃุซุฑ ุงููุงูููู | 98% |
| ููุงููุฉ ุงูุชูุงุนุจ | 99% |
| ูุงุจููุฉ ุงูุชุฏููู | 99.5% |

---

## 10. ุงูุชูุงุตู ูุงูุฅุจูุงุบ

### 10.1 ูููุงุช ุงูุฅุจูุงุบ

- **ุงููุดุงูู ุงูุชูููุฉ:** ูุฑูู ุชูููุฉ ุงููุนูููุงุช
- **ุงููุฎุงููุงุช ุงููุงููุฉ:** ุงููุงุธุฑ ูุจุงุดุฑุฉ
- **ุงุณุชูุณุงุฑุงุช ุงููุณุชููุฏูู:** ุฅุฏุงุฑุฉ ุงููุณุชููุฏูู

### 10.2 ููุช ุงูุงุณุชุฌุงุจุฉ

| ููุน ุงูุทูุจ | ุงูููุช ุงููุชููุน |
|-----------|---------------|
| ุทุงุฑุฆ (ุฃููู) | 1 ุณุงุนุฉ |
| ุนุงุฌู (ูุงูู) | 4 ุณุงุนุงุช |
| ุนุงุฏู | 24 ุณุงุนุฉ |

---

## ุณุฌู ุงูุชุบููุฑุงุช

| ุงูุฅุตุฏุงุฑ | ุงูุชุงุฑูุฎ | ุงูุชุบููุฑ |
|---------|---------|---------|
| 3.4.0 | 2026-01-20 | ุฅุถุงูุฉ Soft Delete ูุญูุงูุฉ ุงูุฎุชู ุงูุฒููู |
| 3.3.0 | 2026-01-15 | ุชุนุฒูุฒ ุฃูุงู RLS |
| 3.2.0 | 2026-01-10 | ุฅุถุงูุฉ ูุตู ุงูููุงูุฉ |
| 3.0.0 | 2025-12-01 | ุงูุฅุตุฏุงุฑ ุงูุฃูู |

---

> **ุชูุจูู:** ูุฐู ุงููุซููุฉ ููุฒูุฉ ูุฌููุน ูุณุชุฎุฏูู ุงููุธุงู. ุฃู ูุฎุงููุฉ ุชูุนุฑุถ ุตุงุญุจูุง ูููุณุงุกูุฉ.
